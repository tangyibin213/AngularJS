
<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8" />
    <title>AngularJS学习笔记 - YS.Zou</title>
    <meta name="generator" content="http://txt2tags.org" />
    <meta name="author" content="Yesheng Zou,YS.Zou,邹业盛"/>

<script type="text/javascript">
window.START = (new Date()).valueOf();
</script>

<!-- start Dplus --><script type="text/javascript">!function(a,b){if(!b.__SV){var c,d,e,f;window.dplus=b,b._i=[],b.init=function(a,c,d){function g(a,b){var c=b.split(".");2==c.length&&(a=a[c[0]],b=c[1]),a[b]=function(){a.push([b].concat(Array.prototype.slice.call(arguments,0)))}}var h=b;for("undefined"!=typeof d?h=b[d]=[]:d="dplus",h.people=h.people||[],h.toString=function(a){var b="dplus";return"dplus"!==d&&(b+="."+d),a||(b+=" (stub)"),b},h.people.toString=function(){return h.toString(1)+".people (stub)"},e="disable track track_links track_forms register unregister get_property identify clear set_config get_config get_distinct_id track_pageview register_once track_with_tag time_event people.set people.unset people.delete_user".split(" "),f=0;f<e.length;f++)g(h,e[f]);b._i.push([a,c,d])},b.__SV=1.1,c=a.createElement("script"),c.type="text/javascript",c.charset="utf-8",c.async=!0,c.src="//w.cnzz.com/dplus.php?id=1260074970",d=a.getElementsByTagName("script")[0],d.parentNode.insertBefore(c,d)}}(document,window.dplus||[]),dplus.init("1260074970");</script><!-- end Dplus -->

</head>

<body class="z" style="color: #333; font-size: 16px; letter-spacing: 0.2em; font-family: 'Microsoft YaHei','WenQuanYi Micro Hei',SimHei,tahoma,sans-serif; -webkit-font-smoothing: antialiased; margin: 0;">
    <div class="content" style="width: 900px; margin: auto; padding: 30px; box-sizing: border-box; position: relative">
        <div class="header">
            <h1 style="text-align: center; font-size: 26px; margin: 0;">AngularJS学习笔记</h1>
            <div class="user" style="margin: 20px auto; text-align: center;">
                <span>邹业盛</span>
                <span>2016-06-07 00:48 更新</span>
            </div>
        </div>

<div class="toc">

  <ol style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
  <li style="margin: 10px auto;"><a href="#toc1" style="color: #0184b7; text-decoration: none">关于AngularJS</a>
  </li>
  <li style="margin: 10px auto;"><a href="#toc2" style="color: #0184b7; text-decoration: none">关于本文档</a>
  </li>
  <li style="margin: 10px auto;"><a href="#toc3" style="color: #0184b7; text-decoration: none">开始的例子</a>
  </li>
  <li style="margin: 10px auto;"><a href="#toc4" style="color: #0184b7; text-decoration: none">依赖注入</a>
  </li>
  <li style="margin: 10px auto;"><a href="#toc5" style="color: #0184b7; text-decoration: none">作用域</a>
  </li>
  <li style="margin: 10px auto;"><a href="#toc6" style="color: #0184b7; text-decoration: none">数据绑定与模板</a>
    <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
    <li style="margin: 10px auto;"><a href="#toc7" style="color: #0184b7; text-decoration: none">6.1. 数据-&gt;模板</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc8" style="color: #0184b7; text-decoration: none">6.2. 模板-&gt;数据</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc9" style="color: #0184b7; text-decoration: none">6.3. 数据-&gt;模板-&gt;数据-&gt;模板</a>
    </li>
    </ul>
  </li>
  <li style="margin: 10px auto;"><a href="#toc10" style="color: #0184b7; text-decoration: none">模板</a>
    <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
    <li style="margin: 10px auto;"><a href="#toc11" style="color: #0184b7; text-decoration: none">7.1. 定义模板内容</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc12" style="color: #0184b7; text-decoration: none">7.2. 内容渲染控制</a>
      <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
      <li style="margin: 10px auto;"><a href="#toc13" style="color: #0184b7; text-decoration: none">7.2.1. 重复 ng-repeat</a>
      </li>
      <li style="margin: 10px auto;"><a href="#toc14" style="color: #0184b7; text-decoration: none">7.2.2. 赋值 ng-init</a>
      </li>
      </ul>
    </li>
    <li style="margin: 10px auto;"><a href="#toc15" style="color: #0184b7; text-decoration: none">7.3. 节点控制</a>
      <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
      <li style="margin: 10px auto;"><a href="#toc16" style="color: #0184b7; text-decoration: none">7.3.1. 样式 ng-style</a>
      </li>
      <li style="margin: 10px auto;"><a href="#toc17" style="color: #0184b7; text-decoration: none">7.3.2. 类 ng-class</a>
      </li>
      <li style="margin: 10px auto;"><a href="#toc18" style="color: #0184b7; text-decoration: none">7.3.3. 显示和隐藏 ng-show ng-hide ng-switch</a>
      </li>
      <li style="margin: 10px auto;"><a href="#toc19" style="color: #0184b7; text-decoration: none">7.3.4. 其它属性控制</a>
      </li>
      </ul>
    </li>
    <li style="margin: 10px auto;"><a href="#toc20" style="color: #0184b7; text-decoration: none">7.4. 事件绑定</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc21" style="color: #0184b7; text-decoration: none">7.5. 表单控件</a>
      <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
      <li style="margin: 10px auto;"><a href="#toc22" style="color: #0184b7; text-decoration: none">7.5.1. form</a>
      </li>
      <li style="margin: 10px auto;"><a href="#toc23" style="color: #0184b7; text-decoration: none">7.5.2. input</a>
      </li>
      <li style="margin: 10px auto;"><a href="#toc24" style="color: #0184b7; text-decoration: none">7.5.3. checkbox</a>
      </li>
      <li style="margin: 10px auto;"><a href="#toc25" style="color: #0184b7; text-decoration: none">7.5.4. radio</a>
      </li>
      <li style="margin: 10px auto;"><a href="#toc26" style="color: #0184b7; text-decoration: none">7.5.5. textarea</a>
      </li>
      <li style="margin: 10px auto;"><a href="#toc27" style="color: #0184b7; text-decoration: none">7.5.6. select</a>
      </li>
      </ul>
    </li>
    </ul>
  </li>
  <li style="margin: 10px auto;"><a href="#toc28" style="color: #0184b7; text-decoration: none">模板中的过滤器</a>
    <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
    <li style="margin: 10px auto;"><a href="#toc29" style="color: #0184b7; text-decoration: none">8.1. 排序 orderBy</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc30" style="color: #0184b7; text-decoration: none">8.2. 过滤列表 filter</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc31" style="color: #0184b7; text-decoration: none">8.3. 其它</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc32" style="color: #0184b7; text-decoration: none">8.4. 例子：表头排序</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc33" style="color: #0184b7; text-decoration: none">8.5. 例子：搜索</a>
    </li>
    </ul>
  </li>
  <li style="margin: 10px auto;"><a href="#toc34" style="color: #0184b7; text-decoration: none">锚点路由</a>
    <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
    <li style="margin: 10px auto;"><a href="#toc35" style="color: #0184b7; text-decoration: none">9.1. 路由定义</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc36" style="color: #0184b7; text-decoration: none">9.2. 参数定义</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc37" style="color: #0184b7; text-decoration: none">9.3. 业务处理</a>
    </li>
    </ul>
  </li>
  <li style="margin: 10px auto;"><a href="#toc38" style="color: #0184b7; text-decoration: none">定义模板变量标识标签</a>
  </li>
  <li style="margin: 10px auto;"><a href="#toc39" style="color: #0184b7; text-decoration: none">AJAX</a>
    <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
    <li style="margin: 10px auto;"><a href="#toc40" style="color: #0184b7; text-decoration: none">11.1. HTTP请求</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc41" style="color: #0184b7; text-decoration: none">11.2. 广义回调管理</a>
      <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
      <li style="margin: 10px auto;"><a href="#toc42" style="color: #0184b7; text-decoration: none">11.2.1. $q</a>
      </li>
      <li style="margin: 10px auto;"><a href="#toc43" style="color: #0184b7; text-decoration: none">11.2.2. deferred</a>
      </li>
      <li style="margin: 10px auto;"><a href="#toc44" style="color: #0184b7; text-decoration: none">11.2.3. promise</a>
      </li>
      </ul>
    </li>
    </ul>
  </li>
  <li style="margin: 10px auto;"><a href="#toc45" style="color: #0184b7; text-decoration: none">工具函数</a>
    <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
    <li style="margin: 10px auto;"><a href="#toc46" style="color: #0184b7; text-decoration: none">12.1. 上下文绑定</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc47" style="color: #0184b7; text-decoration: none">12.2. 对象处理</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc48" style="color: #0184b7; text-decoration: none">12.3. 类型判定</a>
    </li>
    </ul>
  </li>
  <li style="margin: 10px auto;"><a href="#toc49" style="color: #0184b7; text-decoration: none">其它服务</a>
    <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
    <li style="margin: 10px auto;"><a href="#toc50" style="color: #0184b7; text-decoration: none">13.1. 日志</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc51" style="color: #0184b7; text-decoration: none">13.2. 缓存</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc52" style="color: #0184b7; text-decoration: none">13.3. 计时器</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc53" style="color: #0184b7; text-decoration: none">13.4. 表达式函数化</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc54" style="color: #0184b7; text-decoration: none">13.5. 模板单独使用</a>
    </li>
    </ul>
  </li>
  <li style="margin: 10px auto;"><a href="#toc55" style="color: #0184b7; text-decoration: none">自定义模块和服务</a>
    <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
    <li style="margin: 10px auto;"><a href="#toc56" style="color: #0184b7; text-decoration: none">14.1. 模块和服务的概念与关系</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc57" style="color: #0184b7; text-decoration: none">14.2. 定义模块</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc58" style="color: #0184b7; text-decoration: none">14.3. 定义服务</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc59" style="color: #0184b7; text-decoration: none">14.4. 引入模块并使用服务</a>
    </li>
    </ul>
  </li>
  <li style="margin: 10px auto;"><a href="#toc60" style="color: #0184b7; text-decoration: none">附加模块 ngResource</a>
    <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
    <li style="margin: 10px auto;"><a href="#toc61" style="color: #0184b7; text-decoration: none">15.1. 使用引入与整体概念</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc62" style="color: #0184b7; text-decoration: none">15.2. 基本定义</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc63" style="color: #0184b7; text-decoration: none">15.3. 基本使用</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc64" style="color: #0184b7; text-decoration: none">15.4. 定义和使用时的占位量</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc65" style="color: #0184b7; text-decoration: none">15.5. 实例</a>
    </li>
    </ul>
  </li>
  <li style="margin: 10px auto;"><a href="#toc66" style="color: #0184b7; text-decoration: none">AngularJS与其它框架的混用(jQuery, Dojo)</a>
  </li>
  <li style="margin: 10px auto;"><a href="#toc67" style="color: #0184b7; text-decoration: none">自定义过滤器</a>
  </li>
  <li style="margin: 10px auto;"><a href="#toc68" style="color: #0184b7; text-decoration: none">自定义指令directive</a>
    <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
    <li style="margin: 10px auto;"><a href="#toc69" style="color: #0184b7; text-decoration: none">18.1. 指令的使用</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc70" style="color: #0184b7; text-decoration: none">18.2. 指令的执行过程</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc71" style="color: #0184b7; text-decoration: none">18.3. 基本的自定义方法</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc72" style="color: #0184b7; text-decoration: none">18.4. 属性值类型的自定义</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc73" style="color: #0184b7; text-decoration: none">18.5. Compile的细节</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc74" style="color: #0184b7; text-decoration: none">18.6. transclude的细节</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc75" style="color: #0184b7; text-decoration: none">18.7. 把节点内容作为变量处理的类型</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc76" style="color: #0184b7; text-decoration: none">18.8. 指令定义时的参数</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc77" style="color: #0184b7; text-decoration: none">18.9. Attributes的细节</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc78" style="color: #0184b7; text-decoration: none">18.10. 预定义的 NgModelController</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc79" style="color: #0184b7; text-decoration: none">18.11. 预定义的 FormController</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc80" style="color: #0184b7; text-decoration: none">18.12. 示例：文本框</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc81" style="color: #0184b7; text-decoration: none">18.13. 示例：模板控制语句 for</a>
    </li>
    <li style="margin: 10px auto;"><a href="#toc82" style="color: #0184b7; text-decoration: none">18.14. 示例：模板控制语句 if/else</a>
    </li>
    </ul>
  </li>
  </ol>

</div>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<strong style="color: red; font-weight: normal;">本文的内容是在 1.0.x 版本之下完成的。</strong>
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<strong style="color: red; font-weight: normal;">2016-6-1 去掉了全局 Controller 的写法。</strong>
</p>

<a class="anchor" name="toc1"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">1. 关于AngularJS</h1>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<a href="http://angularjs.org/" style="color: #0184b7; text-decoration: none">AngularJS</a> 是 Google 开源出来的一套 js 工具。下面简称其为 <a href="http://docs.angularjs.org/misc/faq" style="color: #0184b7; text-decoration: none">ng</a> 。这里只说它是“工具”，没说它是完整的“框架”，是因为它并不是定位于去完成一套框架要做的事。更重要的，是它给我们揭示了一种新的应用组织与开发方式。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
ng 最让我称奇的，是它的数据双向绑定。其实想想，我们一直在提数据与表现的分离，但是这里的“双向绑定”从某方面来说，是把数据与表现完全绑定在一起——数据变化，表现也变化。反之，表现变化了，内在的数据也变化。有过开发经验的人能体会到这种机制对于前端应用来说，是很有必要的，能带来维护上的巨大优势。当然，这里的绑定与提倡的分离并不是矛盾的。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
ng 可以和 jQuery 集成工作，事实上，如果没有 jQuery ， ng 自己也做了一个轻量级的 jQuery ，主要实现了元素操作部分的 API 。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
关于 ng 的几点：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">对 IE 方面，它兼容 IE8 及以上的版本。
</li>
<li style="margin: 10px auto;">与 jQuery 集成工作，它的一些对象与 jQuery 相关对象表现是一致的。
</li>
<li style="margin: 10px auto;">使用 ng 时不要冒然去改变相关 DOM 的结构（不是说不可以，只是你自己要清楚你在做什么）。
</li>
</ul>

<a class="anchor" name="toc2"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">2. 关于本文档</h1>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这份文档如其名，是我自己学习 ng 的过程记录。只是过程记录，没有刻意像教程那样去做。所以呢，从前至后，中间不免有一些概念不清不明的地方。因为事实上，在某个阶段对于一些概念本来就不可能明白。所以，整个过程只求在形式上的能用即可——直到最后的“自定义”那几章，特别是“自定义指令”，那几章过完，你才能看清 ng 本来的面貌。前面就不要太纠结概念，本质，知道怎么用就好。
</p>

<a class="anchor" name="toc3"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">3. 开始的例子</h1>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
我们从一个完整的例子开始认识 ng ：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #999999; font-weight: bold">&lt;!DOCTYPE html&gt;</span>
<span style="color: #000080">&lt;html&gt;</span>
<span style="color: #000080">&lt;head&gt;</span>
<span style="color: #000080">&lt;meta</span> <span style="color: #008080">charset=</span><span style="color: #dd1144">&quot;utf-8&quot;</span> <span style="color: #000080">/&gt;</span>

<span style="color: #000080">&lt;title&gt;</span>试验<span style="color: #000080">&lt;/title&gt;</span>

<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span> <span style="color: #008080">src=</span><span style="color: #dd1144">&quot;http://s.zys.me/js/jq/jquery.js&quot;</span><span style="color: #000080">&gt;&lt;/script&gt;</span>
<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span> <span style="color: #008080">src=</span><span style="color: #dd1144">&quot;http://s.zys.me/js/ng/angular.js&quot;</span><span style="color: #000080">&gt;&lt;/script&gt;</span>

<span style="color: #000080">&lt;/head&gt;</span>
<span style="color: #000080">&lt;body&gt;</span>
  <span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;BoxCtrl&quot;</span><span style="color: #000080">&gt;</span>
    <span style="color: #000080">&lt;div</span> <span style="color: #008080">style=</span><span style="color: #dd1144">&quot;width: 100px; height: 100px; background-color: red;&quot;</span>
         <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;click()&quot;</span><span style="color: #000080">&gt;&lt;/div&gt;</span>
    <span style="color: #000080">&lt;p&gt;</span>{{ w }} x {{ h }}<span style="color: #000080">&lt;/p&gt;</span>
    <span style="color: #000080">&lt;p&gt;</span>W: <span style="color: #000080">&lt;input</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text&quot;</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;w&quot;</span> <span style="color: #000080">/&gt;&lt;/p&gt;</span>
    <span style="color: #000080">&lt;p&gt;</span>H: <span style="color: #000080">&lt;input</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text&quot;</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;h&quot;</span> <span style="color: #000080">/&gt;&lt;/p&gt;</span>
  <span style="color: #000080">&lt;/div&gt;</span>


<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span> <span style="color: #008080">charset=</span><span style="color: #dd1144">&quot;utf-8&quot;</span><span style="color: #000080">&gt;</span>

  angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
  .controller(<span style="color: #dd1144">&#39;BoxCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope, $element){
      <span style="color: #999988">//$element 就是一个 jQuery 对象</span>
      <span style="color: #000000; font-weight: bold">var</span> e <span style="color: #000000; font-weight: bold">=</span> $element.children().eq(<span style="color: #009999">0</span>);
      $scope.w <span style="color: #000000; font-weight: bold">=</span> e.width();
      $scope.h <span style="color: #000000; font-weight: bold">=</span> e.height();

      $scope.click <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){
        $scope.w <span style="color: #000000; font-weight: bold">=</span> <span style="color: #0086B3">parseInt</span>($scope.w) <span style="color: #000000; font-weight: bold">+</span> <span style="color: #009999">10</span>;
        $scope.h <span style="color: #000000; font-weight: bold">=</span> <span style="color: #0086B3">parseInt</span>($scope.h) <span style="color: #000000; font-weight: bold">+</span> <span style="color: #009999">10</span>;
      }

      $scope.$watch(<span style="color: #dd1144">&#39;w&#39;</span>,
        <span style="color: #000000; font-weight: bold">function</span>(to, from){
          e.width(to);
        }
      );

      $scope.$watch(<span style="color: #dd1144">&#39;h&#39;</span>,
        <span style="color: #000000; font-weight: bold">function</span>(to, from){
          e.height(to);
        }
      );
  });


  angular.bootstrap(<span style="color: #0086B3">document</span>.documentElement, [<span style="color: #dd1144">&#39;app&#39;</span>]);
<span style="color: #000080">&lt;/script&gt;</span>
<span style="color: #000080">&lt;/body&gt;</span>
<span style="color: #000080">&lt;/html&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
从上面的代码中，我们看到在通常的 HTML 代码当中，引入了一些标记，这些就是 ng 的模板机制，它不光完成数据渲染的工作，还实现了数据绑定的功能。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
同时，在 HTML 中的本身的 DOM 层级结构，被 ng 利用起来，直接作为它的内部机制中，上下文结构的判断依据。比如例子中 <em style="color: #d75100; font-style: normal;">p</em> 是 <em style="color: #d75100; font-style: normal;">div</em> 的子节点，那么 <em style="color: #d75100; font-style: normal;">p</em> 中的那些模板标记就是在 <em style="color: #d75100; font-style: normal;">div</em> 的 <em style="color: #d75100; font-style: normal;">Ctrl</em> 的作用范围之内。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
其它的，也同样写一些 js 代码，里面重要的是作一些数据的操作，事件的绑定定义等。这样，数据的变化就会和页面中的 DOM 表现联系起来。一旦这种联系建立起来，也即完成了我们所说的“双向绑定”。然后，这里说的“事件”，除了那些“点击”等通常的 DOM 事件之外，我们还更关注“数据变化”这个事件。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
最后，可以使用：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">angular.bootstrap(<span style="color: #0086B3">document</span>.documentElement, [<span style="color: #dd1144">&#39;app&#39;</span>]);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
来把整个页面驱动起来了。（你可以看到一个可被控制大小的红色方块）
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
简单来说，就是定义一个 App ，然后 <em style="color: #d75100; font-style: normal;">bootstrap</em> 时指定需要用哪些 App 。（ App 之间的依赖关系在定义时声明就好了）
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这里说的一个 App 就是 <em style="color: #d75100; font-style: normal;">ng</em> 概念中的一个 <em style="color: #d75100; font-style: normal;">Module</em> 。
</p>

<a class="anchor" name="toc4"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">4. 依赖注入</h1>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<strong style="color: red; font-weight: normal;">injector</strong> ， 我从 ng 的文档中得知这个概念，之后去翻看源码时了解了一下这个机制的工作原理。感觉就是虽然与自己的所想仅差那么一点点，但就是这么一点点，让我感慨想象力之神奇。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
先看我们之前代码中的一处定义：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">app.controller(<span style="color: #dd1144">&#39;BoxCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope, $element){});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在这个函数定义中，注意那两个参数： <em style="color: #d75100; font-style: normal;">$scope</em> ， <em style="color: #d75100; font-style: normal;">$element</em> ，这是两个很有意思的东西。总的来说，它们是参数，这没什么可说的。但又不仅仅是参数——你换个名字代码就不能正常运行了。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
事实上，这两个参数，除了完成“参数”的本身任务之外，还作为一种语法糖完成了“依赖声明”的任务。本来这个函数定义，完整的写法应该像 AMD 声明一样，写成：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">app.controller(<span style="color: #dd1144">&#39;BoxCtrl&#39;</span>,
                [ <span style="color: #dd1144">&#39;$scope&#39;</span>, <span style="color: #dd1144">&#39;$element&#39;</span>,
                  <span style="color: #000000; font-weight: bold">function</span>($scope, $element){}
                ]
              );
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这样就很明显，表示有一个函数，它依赖于两个东西，然后这两个东西会依次作为参数传入。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
简单起见，就写成了一个函数定义原本的样子，然后在定义参数的名字上作文章，来起到依赖声明的作用。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在处理时，通过函数对象的 <em style="color: #d75100; font-style: normal;">toString()</em> 方法可以知道这个函数定义代码的字符串表现形式，然后就知道它的参数是 <em style="color: #d75100; font-style: normal;">$scope</em> 和 <em style="color: #d75100; font-style: normal;">$element</em> 。通过名字判断出这是两个外部依赖，然后就去获取资源，最后把资源作为参数，调用定义的函数。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
所以，参数的名字是不能随便写的，这里也充分利用了 js 的特点来尽量做到“反省”了。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在 Python 中受限于函数名的命名规则，写出来不太好看。不过也得利于反省机制，做到这点也很容易：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #999988"># -*- coding: utf-8 -*-</span>

<span style="color: #000000; font-weight: bold">def</span> <span style="color: #990000; font-weight: bold">f</span>(Ia, Ib):
    <span style="color: #000000; font-weight: bold">print</span> Ia, Ib

args <span style="color: #000000; font-weight: bold">=</span> f<span style="color: #000000; font-weight: bold">.</span>func_code<span style="color: #000000; font-weight: bold">.</span>co_varnames
SRV_MAP <span style="color: #000000; font-weight: bold">=</span> {
    <span style="color: #dd1144">&#39;Ia&#39;</span>: <span style="color: #dd1144">&#39;123&#39;</span>,
    <span style="color: #dd1144">&#39;Ib&#39;</span>: <span style="color: #dd1144">&#39;456&#39;</span>,
}

srv <span style="color: #000000; font-weight: bold">=</span> {}
<span style="color: #000000; font-weight: bold">for</span> a <span style="color: #000000; font-weight: bold">in</span> args:
    <span style="color: #000000; font-weight: bold">if</span> a <span style="color: #000000; font-weight: bold">in</span> SRV_MAP:
        srv[a] <span style="color: #000000; font-weight: bold">=</span> SRV_MAP[a]
f(<span style="color: #000000; font-weight: bold">**</span>srv)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc5"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">5. 作用域</h1>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这里提到的“作用域”的概念，是一个在范围上与 DOM 结构一致，数据上相对于某个 <em style="color: #d75100; font-style: normal;">$scope</em> 对象的属性的概念。我们还是从 HTML 代码上来入手：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;BoxCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;div</span> <span style="color: #008080">style=</span><span style="color: #dd1144">&quot;width: 100px; height: 100px; background-color: red;&quot;</span>
       <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;click()&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;/div&gt;</span>
  <span style="color: #000080">&lt;p&gt;</span>{{ w }} x {{ h }}<span style="color: #000080">&lt;/p&gt;</span>
  <span style="color: #000080">&lt;p&gt;</span>W: <span style="color: #000080">&lt;input</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text&quot;</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;w&quot;</span> <span style="color: #000080">/&gt;&lt;/p&gt;</span>
  <span style="color: #000080">&lt;p&gt;</span>H: <span style="color: #000080">&lt;input</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text&quot;</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;h&quot;</span> <span style="color: #000080">/&gt;&lt;/p&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
上面的代码中，我们给一个 <em style="color: #d75100; font-style: normal;">div</em> 元素指定了一个 <em style="color: #d75100; font-style: normal;">BoxCtrl</em> ，那么， <em style="color: #d75100; font-style: normal;">div</em> 元素之内，就是 <em style="color: #d75100; font-style: normal;">BoxCtrl</em> 这个函数运行时， <em style="color: #d75100; font-style: normal;">$scope</em> 这个注入资源的控制范围。在代码中我们看到的 <em style="color: #d75100; font-style: normal;">click()</em> ， <em style="color: #d75100; font-style: normal;">w</em> ， <em style="color: #d75100; font-style: normal;">h</em> 这些东西，它们本来的位置对应于 <em style="color: #d75100; font-style: normal;">$scope.click</em> ， <em style="color: #d75100; font-style: normal;">$scope.w</em> ， <em style="color: #d75100; font-style: normal;">$scope.h</em> 。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
我们在后面的 js 代码中，也可以看到我们就是在操作这些变量。依赖于 ng 的数据绑定机制，操作变量的结果直接在页面上表现出来了。
</p>

<a class="anchor" name="toc6"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">6. 数据绑定与模板</h1>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
我纠结了半天，“数据绑定”与“模板”这两个东西还真没办法分开来说。因为数据绑定需要以模板为载体，离开了模板，数据还绑个毛啊。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
ng 的一大特点，就是数据双向绑定。双向绑定是一体，为了描述方便，下面分别介绍。
</p>

<a class="anchor" name="toc7"></a>
<h2 style="font-size: 18px; margin: 30px auto;">6.1. 数据-&gt;模板</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
数据到表现的绑定，主要是使用模板标记直接完成的：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;p&gt;</span>{{ w }} x {{ h }}<span style="color: #000080">&lt;/p&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
使用 <em style="color: #d75100; font-style: normal;">{{ }}</em> 这个标记，就可以直接引用，并绑定一个作用域内的变量。在实现上， ng 自动创建了一个 <em style="color: #d75100; font-style: normal;">watcher</em> 。效果就是，不管因为什么，如果作用域的变量发生了改变，我们随时可以让相应的页面表现也随之改变。我们可以看一个更纯粹的例子：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;p</span> <span style="color: #008080">id=</span><span style="color: #dd1144">&quot;test&quot;</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>{{ a }}<span style="color: #000080">&lt;/p&gt;</span>

<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000080">&gt;</span>
angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
    $scope.a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;123&#39;</span>;
});
angular.bootstrap(<span style="color: #0086B3">document</span>.documentElement, [<span style="color: #dd1144">&#39;app&#39;</span>]);
<span style="color: #000080">&lt;/script&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
上面的例子在页面载入之后，我们可以在页面上看到 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">123</code> 。这时，我们可以打开一个终端控制器，输入：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">$(<span style="color: #dd1144">&#39;#test&#39;</span>).scope().a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;12345&#39;</span>;
$(<span style="color: #dd1144">&#39;#test&#39;</span>).scope().$digest();
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
上面的代码执行之后，就可以看到页面变化了。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
对于使用 ng 进行的事件绑定，在处理函数中就不需要去关心 <em style="color: #d75100; font-style: normal;">$digest()</em> 的调用了。因为 ng 会自己处理。源码中，对于 ng 的事件绑定，真正的处理函数不是指定名字的函数，而是经过 <em style="color: #d75100; font-style: normal;">$apply()</em> 包装过的一个函数。这个 <em style="color: #d75100; font-style: normal;">$apply()</em> 做的一件事，就是调用根作用域 <em style="color: #d75100; font-style: normal;">$rootScope</em> 的 <em style="color: #d75100; font-style: normal;">$digest()</em> ，这样整个世界就清净了：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;p</span> <span style="color: #008080">id=</span><span style="color: #dd1144">&quot;test&quot;</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;click()&quot;</span><span style="color: #000080">&gt;</span>{{ a }}<span style="color: #000080">&lt;/p&gt;</span>

<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000080">&gt;</span>
angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
    $scope.a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;123&#39;</span>;
    $scope.click <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){
      $scope.a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;456&#39;</span>;
    }
});
angular.bootstrap(<span style="color: #0086B3">document</span>.documentElement, [<span style="color: #dd1144">&#39;app&#39;</span>]);
<span style="color: #000080">&lt;/script&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
那个 <em style="color: #d75100; font-style: normal;">click</em> 函数的定义，绑定时变成了类似于：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">function</span>(){
  $scope.$apply(
    <span style="color: #000000; font-weight: bold">function</span>(){
      $scope.click();
    }
  )
}
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这里的 <em style="color: #d75100; font-style: normal;">$scope.$apply()</em> 中做的一件事：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">$<span style="color: #008080">rootScope</span>.$<span style="color: #008080">digest</span>();
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc8"></a>
<h2 style="font-size: 18px; margin: 30px auto;">6.2. 模板-&gt;数据</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
模板到数据的绑定，主要是通过 <em style="color: #d75100; font-style: normal;">ng-model</em> 来完成的：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;input</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text&quot;</span> <span style="color: #008080">id=</span><span style="color: #dd1144">&quot;test&quot;</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #000080">/&gt;</span>

<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000080">&gt;</span>
angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
    $scope.a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;123&#39;</span>;
});
angular.bootstrap(<span style="color: #0086B3">document</span>.documentElement, [<span style="color: #dd1144">&#39;app&#39;</span>]);
<span style="color: #000080">&lt;/script&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这时修改 <em style="color: #d75100; font-style: normal;">input</em> 中的值，然后再在控制终端中使用：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">$(<span style="color: #dd1144">&#39;#test&#39;</span>).scope().a
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
查看，发现变量 <em style="color: #d75100; font-style: normal;">a</em> 的值已经更改了。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
实际上， <em style="color: #d75100; font-style: normal;">ng-model</em> 是把两个方向的绑定都做了。它不光显示出变量的值，也把显示上的数值变化反映给了变量。这个在实现上就简单多了，只是绑定 <em style="color: #d75100; font-style: normal;">change</em> 事件，然后做一些赋值操作即可。不过 ng 里，还要区分对待不同的控件。
</p>

<a class="anchor" name="toc9"></a>
<h2 style="font-size: 18px; margin: 30px auto;">6.3. 数据-&gt;模板-&gt;数据-&gt;模板</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
现在要考虑的是一种在现实中很普遍的一个需求。比如就是我们可以输入数值，来控制一个矩形的长度。在这里，数据与表现的关系是：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">长度数值保存在变量中
</li>
<li style="margin: 10px auto;">变量显示于某个 input 中
</li>
<li style="margin: 10px auto;">变量的值即是矩形的长度
</li>
<li style="margin: 10px auto;">input 中的值变化时，变量也要变化
</li>
<li style="margin: 10px auto;">input 中的值变化时，矩形的长度也要变化
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
当然，要实现目的在这里可能就不止一种方案了。按照以前的做法，很自然地会想法，绑定 <em style="color: #d75100; font-style: normal;">input</em> 的 <em style="color: #d75100; font-style: normal;">change</em> 事件，然后去做一些事就好了。但是，我们前面提到过 <em style="color: #d75100; font-style: normal;">ng-model</em> 这个东西，利用它就可以在不手工处理 <em style="color: #d75100; font-style: normal;">change</em> 的条件下完成数据的展现需求，在此基础之上，我们还需要做的一点，就是把变化后的数据应用到矩形的长度之上。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
最开始，我们面对的应该是这样一个东西：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;div</span> <span style="color: #008080">style=</span><span style="color: #dd1144">&quot;width: 100px; height: 10px; background-color: red&quot;</span><span style="color: #000080">&gt;&lt;/div&gt;</span>
  <span style="color: #000080">&lt;input</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text&quot;</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;width&quot;</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;width&quot;</span> <span style="color: #000080">/&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>


<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000080">&gt;</span>
angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
    $scope.width <span style="color: #000000; font-weight: bold">=</span> <span style="color: #009999">100</span>;
});
angular.bootstrap(<span style="color: #0086B3">document</span>.documentElement, [<span style="color: #dd1144">&#39;app&#39;</span>]);
<span style="color: #000080">&lt;/script&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
我们从响应数据变化，但又不使用 <em style="color: #d75100; font-style: normal;">change</em> 事件的角度来看，可以这样处理宽度变化：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.width <span style="color: #000000; font-weight: bold">=</span> <span style="color: #009999">100</span>;
  $scope.$watch(<span style="color: #dd1144">&#39;width&#39;</span>,
    <span style="color: #000000; font-weight: bold">function</span>(to, from){
      $element.children(<span style="color: #dd1144">&#39;:first&#39;</span>).width(to);
    }
  );
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
使用 <em style="color: #d75100; font-style: normal;">$watch()</em> 来绑定数据变化。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
当然，这种样式的问题，有更直接有效的手段， ng 的数据绑定总是让人惊异：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;div</span> <span style="color: #008080">style=</span><span style="color: #dd1144">&quot;width: 10px; height: 10px; background-color: red&quot;</span> <span style="color: #008080">ng-style=</span><span style="color: #dd1144">&quot;style&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;/div&gt;</span>
  <span style="color: #000080">&lt;input</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text&quot;</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;width&quot;</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;style.width&quot;</span> <span style="color: #000080">/&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>


<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000080">&gt;</span>
angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
    $scope.style <span style="color: #000000; font-weight: bold">=</span> {width<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">100</span> <span style="color: #000000; font-weight: bold">+</span> <span style="color: #dd1144">&#39;px&#39;</span>};
});
angular.bootstrap(<span style="color: #0086B3">document</span>.documentElement, [<span style="color: #dd1144">&#39;app&#39;</span>]);
<span style="color: #000080">&lt;/script&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc10"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">7. 模板</h1>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
前面讲了数据绑定之后，现在可以单独讲讲模板了。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
作为一套能称之谓“模板”的系统，除了能干一些模板的常规的事之外（好吧，即使是常规的逻辑判断现在它也做不了的），配合作用域 <em style="color: #d75100; font-style: normal;">$scope</em> 和 ng 的数据双向绑定机制， ng 的模板系统就变得比较神奇了。
</p>

<a class="anchor" name="toc11"></a>
<h2 style="font-size: 18px; margin: 30px auto;">7.1. 定义模板内容</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
定义模板的内容现在有三种方式：
</p>

<ol style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">在需要的地方直接写字符串
</li>
<li style="margin: 10px auto;">外部文件
</li>
<li style="margin: 10px auto;">使用 <em style="color: #d75100; font-style: normal;">script</em> 标签定义的“内部文件”
</li>
</ol>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
第一种不需要多说。第二种和第三种都可以和 <em style="color: #d75100; font-style: normal;">ng-include</em> 一起工作，来引入一段模板。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
直接引入同域的外部文件作为模板的一部分：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-include</span> <span style="color: #008080">src=</span><span style="color: #dd1144">&quot;&#39;tpl.html&#39;&quot;</span><span style="color: #000080">&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>

<span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-include=</span><span style="color: #dd1144">&quot;&#39;tpl.html&#39;&quot;</span><span style="color: #000080">&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
注意， <em style="color: #d75100; font-style: normal;">src</em> 中的字符串会作为表达式处理（可以是 <em style="color: #d75100; font-style: normal;">$scope</em> 中的变量），所以，直接写名字的话需要使用引号。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
引入 <em style="color: #d75100; font-style: normal;">script</em> 定义的“内部文件”：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/ng-template&quot;</span> <span style="color: #008080">id=</span><span style="color: #dd1144">&quot;tpl&quot;</span><span style="color: #000080">&gt;</span>
here, {{ <span style="color: #009999">1</span> <span style="color: #000000; font-weight: bold">+</span> <span style="color: #009999">1</span> }}
<span style="color: #000080">&lt;/script&gt;</span>

<span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-include</span> <span style="color: #008080">src=</span><span style="color: #dd1144">&quot;&#39;tpl&#39;&quot;</span><span style="color: #000080">&gt;&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
配合变量使用：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/ng-template&quot;</span> <span style="color: #008080">id=</span><span style="color: #dd1144">&quot;tpl&quot;</span><span style="color: #000080">&gt;</span>
here, {{ <span style="color: #009999">1</span> <span style="color: #000000; font-weight: bold">+</span> <span style="color: #009999">1</span> }}
<span style="color: #000080">&lt;/script&gt;</span>

<span style="color: #000080">&lt;a</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;v=&#39;tpl&#39;&quot;</span><span style="color: #000080">&gt;</span>Load<span style="color: #000080">&lt;/a&gt;</span>
<span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-include</span> <span style="color: #008080">src=</span><span style="color: #dd1144">&quot;v&quot;</span><span style="color: #000080">&gt;&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc12"></a>
<h2 style="font-size: 18px; margin: 30px auto;">7.2. 内容渲染控制</h2>

<a class="anchor" name="toc13"></a>
<h3 style="font-size: 16px; margin: 25px auto;">7.2.1. 重复 ng-repeat</h3>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这算是唯一的一个控制标签么……，它的使用方法类型于：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;ul</span> <span style="color: #008080">ng-repeat=</span><span style="color: #dd1144">&quot;member in obj_list&quot;</span><span style="color: #000080">&gt;</span>
    <span style="color: #000080">&lt;li&gt;</span>{{ member }}<span style="color: #000080">&lt;/li&gt;</span>
  <span style="color: #000080">&lt;/ul&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>



angular.module(&#39;app&#39;, [], angular.noop)
.controller(&#39;TestCtrl&#39;, function($scope){
    $scope.obj_list = [1,2,3,4];
});
angular.bootstrap(document.documentElement, [&#39;app&#39;]);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
除此之外，它还提供了几个变量可供使用：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">$index</em> 当前索引
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">$first</em> 是否为头元素
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">$middle</em> 是否为非头非尾元素
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">$last</em> 是否为尾元素
</li>
</ul>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;ul</span> <span style="color: #008080">ng-repeat=</span><span style="color: #dd1144">&quot;member in obj_list&quot;</span><span style="color: #000080">&gt;</span>
    <span style="color: #000080">&lt;li&gt;</span>{{ $index }}, {{ member.name }}<span style="color: #000080">&lt;/li&gt;</span>
  <span style="color: #000080">&lt;/ul&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>


angular.module(&#39;app&#39;, [], angular.noop)
.controller(&#39;TestCtrl&#39;, function($scope){
    $scope.obj_list = [{name: &#39;A&#39;}, {name: &#39;B&#39;}, {name: &#39;C&#39;}];
});
angular.bootstrap(document.documentElement, [&#39;app&#39;]);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc14"></a>
<h3 style="font-size: 16px; margin: 25px auto;">7.2.2. 赋值 ng-init</h3>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这个指令可以在模板中直接赋值，它作用于 <em style="color: #d75100; font-style: normal;">angular.bootstrap</em> 之前，并且，定义的变量与 <em style="color: #d75100; font-style: normal;">$scope</em> 作用域无关。
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span> <span style="color: #008080">ng-init=</span><span style="color: #dd1144">&quot;a=[1,2,3,4];&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;ul</span> <span style="color: #008080">ng-repeat=</span><span style="color: #dd1144">&quot;member in a&quot;</span><span style="color: #000080">&gt;</span>
    <span style="color: #000080">&lt;li&gt;</span>{{ member }}<span style="color: #000080">&lt;/li&gt;</span>
  <span style="color: #000080">&lt;/ul&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc15"></a>
<h2 style="font-size: 18px; margin: 30px auto;">7.3. 节点控制</h2>

<a class="anchor" name="toc16"></a>
<h3 style="font-size: 16px; margin: 25px auto;">7.3.1. 样式 ng-style</h3>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
可以使用一个结构直接表示当前节点的样式：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-style=</span><span style="color: #dd1144">&quot;{width: 100 + &#39;px&#39;, height: 100 + &#39;px&#39;, backgroundColor: &#39;red&#39;}&quot;</span><span style="color: #000080">&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
同样地，绑定一个变量的话，威力大了。
</p>

<a class="anchor" name="toc17"></a>
<h3 style="font-size: 16px; margin: 25px auto;">7.3.2. 类 ng-class</h3>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
就是直接地设置当前节点的类，同样，配合数据绑定作用就大了：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span> <span style="color: #008080">ng-class=</span><span style="color: #dd1144">&quot;cls&quot;</span><span style="color: #000080">&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">ng-class-even</em> 和 <em style="color: #d75100; font-style: normal;">ng-class-odd</em> 是和 <em style="color: #d75100; font-style: normal;">ng-repeat</em> 配合使用的：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;ul</span> <span style="color: #008080">ng-init=</span><span style="color: #dd1144">&quot;l=[1,2,3,4]&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;li</span> <span style="color: #008080">ng-class-odd=</span><span style="color: #dd1144">&quot;&#39;odd&#39;&quot;</span> <span style="color: #008080">ng-class-even=</span><span style="color: #dd1144">&quot;&#39;even&#39;&quot;</span> <span style="color: #008080">ng-repeat=</span><span style="color: #dd1144">&quot;m in l&quot;</span><span style="color: #000080">&gt;</span>{{ m }}<span style="color: #000080">&lt;/li&gt;</span>
<span style="color: #000080">&lt;/ul&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
注意里面给的还是表示式，别少了引号。
</p>

<a class="anchor" name="toc18"></a>
<h3 style="font-size: 16px; margin: 25px auto;">7.3.3. 显示和隐藏 ng-show ng-hide ng-switch</h3>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
前两个是控制 <em style="color: #d75100; font-style: normal;">display</em> 的指令：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-show=</span><span style="color: #dd1144">&quot;true&quot;</span><span style="color: #000080">&gt;</span>1<span style="color: #000080">&lt;/div&gt;</span>
<span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-show=</span><span style="color: #dd1144">&quot;false&quot;</span><span style="color: #000080">&gt;</span>2<span style="color: #000080">&lt;/div&gt;</span>
<span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-hide=</span><span style="color: #dd1144">&quot;true&quot;</span><span style="color: #000080">&gt;</span>3<span style="color: #000080">&lt;/div&gt;</span>
<span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-hide=</span><span style="color: #dd1144">&quot;false&quot;</span><span style="color: #000080">&gt;</span>4<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
后一个 <em style="color: #d75100; font-style: normal;">ng-switch</em> 是根据一个值来决定哪个节点显示，其它节点移除：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-init=</span><span style="color: #dd1144">&quot;a=2&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;ul</span> <span style="color: #008080">ng-switch</span> <span style="color: #008080">on=</span><span style="color: #dd1144">&quot;a&quot;</span><span style="color: #000080">&gt;</span>
    <span style="color: #000080">&lt;li</span> <span style="color: #008080">ng-switch-when=</span><span style="color: #dd1144">&quot;1&quot;</span><span style="color: #000080">&gt;</span>1<span style="color: #000080">&lt;/li&gt;</span>
    <span style="color: #000080">&lt;li</span> <span style="color: #008080">ng-switch-when=</span><span style="color: #dd1144">&quot;2&quot;</span><span style="color: #000080">&gt;</span>2<span style="color: #000080">&lt;/li&gt;</span>
    <span style="color: #000080">&lt;li</span> <span style="color: #008080">ng-switch-default</span><span style="color: #000080">&gt;</span>other<span style="color: #000080">&lt;/li&gt;</span>
  <span style="color: #000080">&lt;/ul&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc19"></a>
<h3 style="font-size: 16px; margin: 25px auto;">7.3.4. 其它属性控制</h3>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">ng-src</em> 控制 <em style="color: #d75100; font-style: normal;">src</em> 属性：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;img</span> <span style="color: #008080">ng-src=</span><span style="color: #dd1144">&quot;{{ &#39;h&#39; + &#39;ead.png&#39; }}&quot;</span> <span style="color: #000080">/&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">ng-href</em> 控制 <em style="color: #d75100; font-style: normal;">href</em> 属性：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;a</span> <span style="color: #008080">ng-href=</span><span style="color: #dd1144">&quot;{{ &#39;#&#39; + &#39;123&#39; }}&quot;</span><span style="color: #000080">&gt;</span>here<span style="color: #000080">&lt;/a&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
总的来说：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-src</em> src属性
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-href</em> href属性
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-checked</em> 选中状态
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-selected</em> 被选择状态
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-disabled</em> 禁用状态
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-multiple</em> 多选状态
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-readonly</em> 只读状态
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<strong style="color: red; font-weight: normal;">注意：</strong> 上面的这些只是单向绑定，即只是从数据到展示，不能反作用于数据。要双向绑定，还是要使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">ng-model</code> 。
</p>

<a class="anchor" name="toc20"></a>
<h2 style="font-size: 18px; margin: 30px auto;">7.4. 事件绑定</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
事件绑定是模板指令中很好用的一部分。我们可以把相关事件的处理函数直接写在 DOM 中，这样做的最大好处就是可以从 DOM 结构上看出业务处理的形式，你知道当你点击这个节点时哪个函数被执行了。
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-change</em>
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-click</em>
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-dblclick</em>
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-mousedown</em>
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-mouseenter</em>
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-mouseleave</em>
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-mousemove</em>
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-mouseover</em>
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-mouseup</em>
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-submit</em>
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
对于事件对象本身，在函数调用时可以直接使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$event</code> 进行传递：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;p</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;click($event)&quot;</span><span style="color: #000080">&gt;</span>点击<span style="color: #000080">&lt;/p&gt;</span>
<span style="color: #000080">&lt;p</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;click($event.target)&quot;</span><span style="color: #000080">&gt;</span>点击<span style="color: #000080">&lt;/p&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc21"></a>
<h2 style="font-size: 18px; margin: 30px auto;">7.5. 表单控件</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
表单控件类的模板指令，最大的作用是它预定义了需要绑定的数据的格式。这样，就可以对于既定的数据进行既定的处理。
</p>

<a class="anchor" name="toc22"></a>
<h3 style="font-size: 16px; margin: 25px auto;">7.5.1. form</h3>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">form</em> 是核心的一个控件。 ng 对 <em style="color: #d75100; font-style: normal;">form</em> 这个标签作了包装。事实上， ng 自己的指令是叫 <em style="color: #d75100; font-style: normal;">ng-form</em> 的，区别在于， <em style="color: #d75100; font-style: normal;">form</em> 标签不能嵌套，而使用 <em style="color: #d75100; font-style: normal;">ng-form</em> 指令就可以做嵌套的表单了。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">form</em> 的行为中依赖它里面的各个输入控制的状态的，在这里，我们主要关心的是 <em style="color: #d75100; font-style: normal;">form</em> 自己的一些方法和属性。从 ng 的角度来说， <em style="color: #d75100; font-style: normal;">form</em> 标签，是一个模板指令，也创建了一个 <em style="color: #d75100; font-style: normal;">FormController</em> 的实例。这个实例就提供了相应的属性和方法。同时，它里面的控件也是一个 <em style="color: #d75100; font-style: normal;">NgModelController</em> 实例。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
很重要的一点， <em style="color: #d75100; font-style: normal;">form</em> 的相关方法要生效，必须为 <em style="color: #d75100; font-style: normal;">form</em> 标签指定 <em style="color: #d75100; font-style: normal;">name</em> 和 <em style="color: #d75100; font-style: normal;">ng-controller</em> ，并且每个控件都要绑定一个变量。 <em style="color: #d75100; font-style: normal;">form</em> 和控件的名字，即是 <em style="color: #d75100; font-style: normal;">$scope</em> 中的相关实例的引用变量名。
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;form</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;test_form&quot;</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;input</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text&quot;</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">required</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span>  <span style="color: #000080">/&gt;</span>
  <span style="color: #000080">&lt;span</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;see()&quot;</span><span style="color: #000080">&gt;</span>{{ test_form.$valid }}<span style="color: #000080">&lt;/span&gt;</span>
<span style="color: #000080">&lt;/form&gt;</span>


angular.module(&#39;app&#39;, [], angular.noop)
.controller(&#39;TestCtrl&#39;, function($scope){
  $scope.see = function(){
    console.log($scope.test_form);
    console.log($scope.test_form.a);
  }
});
angular.bootstrap(document.documentElement, [&#39;app&#39;]);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
除去对象的方法与属性， <em style="color: #d75100; font-style: normal;">form</em> 这个标签本身有一些动态类可以使用：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-valid</em> 当表单验证通过时的设置
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-invalid</em> 当表单验证失败时的设置
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-pristine</em> 表单的未被动之前拥有
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-dirty</em> 表单被动过之后拥有
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">form</em> 对象的属性有：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">$pristine</em> 表单是否未被动过
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">$dirty</em> 表单是否被动过
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">$valid</em> 表单是否验证通过
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">$invalid</em> 表单是否验证失败
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">$error</em> 表单的验证错误
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
其中的 <em style="color: #d75100; font-style: normal;">$error</em> 对象包含有所有字段的验证信息，及对相关字段的 <em style="color: #d75100; font-style: normal;">NgModelController</em> 实例的引用。它的结构是一个对象， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">key</code> 是失败信息， <em style="color: #d75100; font-style: normal;">required</em> ， <em style="color: #d75100; font-style: normal;">minlength</em> 之类的， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">value</code> 是对应的字段实例列表。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
注意，这里的失败信息是按序列取的一个。比如，如果一个字段既要求 <em style="color: #d75100; font-style: normal;">required</em> ，也要求 <em style="color: #d75100; font-style: normal;">minlength</em> ，那么当它为空时， <em style="color: #d75100; font-style: normal;">$error</em> 中只有 <em style="color: #d75100; font-style: normal;">required</em> 的失败信息。只输入一个字符之后， <em style="color: #d75100; font-style: normal;">required</em> 条件满足了，才可能有 <em style="color: #d75100; font-style: normal;">minlength</em> 这个失败信息。
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;form</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;test_form&quot;</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;input</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text&quot;</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">required</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span>  <span style="color: #000080">/&gt;</span>
  <span style="color: #000080">&lt;input</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text&quot;</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;b&quot;</span> <span style="color: #008080">required</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;b&quot;</span> <span style="color: #008080">ng-minlength=</span><span style="color: #dd1144">&quot;2&quot;</span> <span style="color: #000080">/&gt;</span>
  <span style="color: #000080">&lt;span</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;see()&quot;</span><span style="color: #000080">&gt;</span>{{ test_form.$error }}<span style="color: #000080">&lt;/span&gt;</span>
<span style="color: #000080">&lt;/form&gt;</span>


angular.module(&#39;app&#39;, [], angular.noop)
.controller(&#39;TestCtrl&#39;, function($scope){
  $scope.see = function(){
    console.log($scope.test_form.$error);
  }
});
angular.bootstrap(document.documentElement, [&#39;app&#39;]);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc23"></a>
<h3 style="font-size: 16px; margin: 25px auto;">7.5.2. input</h3>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">input</em> 是数据的最主要入口。 ng 支持 HTML5 中的相关属性，同时对旧浏览器也做了兼容性处理。最重要的， <em style="color: #d75100; font-style: normal;">input</em> 的规则定义，是所属表单的相关行为的参照（比如表单是否验证成功）。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">input</em> 控件的相关可用属性为：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">name</em> 名字
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-model</em> 绑定的数据
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">required</em> 是否必填
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-required</em> 是否必填
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-minlength</em> 最小长度
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-maxlength</em> 最大长度
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-pattern</em> 匹配模式
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">ng-change</em> 值变化时的回调
</li>
</ul>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;form</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;test_form&quot;</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;input</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text&quot;</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">required</span> <span style="color: #008080">ng-pattern=</span><span style="color: #dd1144">&quot;/abc/&quot;</span> <span style="color: #000080">/&gt;</span>
  <span style="color: #000080">&lt;span</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;see()&quot;</span><span style="color: #000080">&gt;</span>{{ test_form.$error }}<span style="color: #000080">&lt;/span&gt;</span>
<span style="color: #000080">&lt;/form&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">input</em> 控件，它还有一些扩展，这些扩展有些有自己的属性：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">input type="number"</em> 多了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">number</code> 错误类型，多了 <em style="color: #d75100; font-style: normal;">max</em> ， <em style="color: #d75100; font-style: normal;">min</em> 属性。
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">input type="url"</em> 多了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">url</code> 错误类型。
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">input type="email"</em> 多了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">email</code> 错误类型。
</li>
</ul>

<a class="anchor" name="toc24"></a>
<h3 style="font-size: 16px; margin: 25px auto;">7.5.3. checkbox</h3>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
它也算是 <em style="color: #d75100; font-style: normal;">input</em> 的扩展，不过，它没有验证相关的东西，只有选中与不选中两个值：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;form</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;test_form&quot;</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;input</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;checkbox&quot;</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">ng-true-value=</span><span style="color: #dd1144">&quot;AA&quot;</span> <span style="color: #008080">ng-false-value=</span><span style="color: #dd1144">&quot;BB&quot;</span> <span style="color: #000080">/&gt;</span>
  <span style="color: #000080">&lt;span&gt;</span>{{ a }}<span style="color: #000080">&lt;/span&gt;</span>
<span style="color: #000080">&lt;/form&gt;</span>

var TestCtrl = function($scope){
  $scope.a = &#39;AA&#39;;
}
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
两点：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">controller 要初始化变量值。
</li>
<li style="margin: 10px auto;">controller 中的初始化值会关系到控件状态（双向绑定）。
</li>
</ul>

<a class="anchor" name="toc25"></a>
<h3 style="font-size: 16px; margin: 25px auto;">7.5.4. radio</h3>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
也是 <em style="color: #d75100; font-style: normal;">input</em> 的扩展。和 <em style="color: #d75100; font-style: normal;">checkbox</em> 一样，但它只有一个值了：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;form</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;test_form&quot;</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;input</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;radio&quot;</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">value=</span><span style="color: #dd1144">&quot;AA&quot;</span> <span style="color: #000080">/&gt;</span>
  <span style="color: #000080">&lt;input</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;radio&quot;</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">value=</span><span style="color: #dd1144">&quot;BB&quot;</span> <span style="color: #000080">/&gt;</span>
  <span style="color: #000080">&lt;span&gt;</span>{{ a }}<span style="color: #000080">&lt;/span&gt;</span>
<span style="color: #000080">&lt;/form&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc26"></a>
<h3 style="font-size: 16px; margin: 25px auto;">7.5.5. textarea</h3>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
同 <em style="color: #d75100; font-style: normal;">input</em> 。
</p>

<a class="anchor" name="toc27"></a>
<h3 style="font-size: 16px; margin: 25px auto;">7.5.6. select</h3>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这是一个比较牛B的控件。它里面的一个叫做 <em style="color: #d75100; font-style: normal;">ng-options</em> 的属性用于数据呈现。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
对于给定列表时的使用。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
最简单的使用方法， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">x for x in list</code> ：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;form</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;test_form&quot;</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span> <span style="color: #008080">ng-init=</span><span style="color: #dd1144">&quot;o=[0,1,2,3]; a=o[1];&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;select</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">ng-options=</span><span style="color: #dd1144">&quot;x for x in o&quot;</span> <span style="color: #008080">ng-change=</span><span style="color: #dd1144">&quot;show()&quot;</span><span style="color: #000080">&gt;</span>
    <span style="color: #000080">&lt;option</span> <span style="color: #008080">value=</span><span style="color: #dd1144">&quot;&quot;</span><span style="color: #000080">&gt;</span>可以加这个空值<span style="color: #000080">&lt;/option&gt;</span>
  <span style="color: #000080">&lt;/select&gt;</span>
<span style="color: #000080">&lt;/form&gt;</span>

<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000080">&gt;</span>
angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.show <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){
    console.log($scope.a);
  }
});
angular.bootstrap(<span style="color: #0086B3">document</span>.documentElement, [<span style="color: #dd1144">&#39;app&#39;</span>]);
<span style="color: #000080">&lt;/script&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在 <em style="color: #d75100; font-style: normal;">$scope</em> 中， <em style="color: #d75100; font-style: normal;">select</em> 绑定的变量，其值和普通的 <em style="color: #d75100; font-style: normal;">value</em> 无关，可以是一个对象：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;form</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;test_form&quot;</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span>
      <span style="color: #008080">ng-init=</span><span style="color: #dd1144">&quot;o=[{name: &#39;AA&#39;}, {name: &#39;BB&#39;}]; a=o[1];&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;select</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">ng-options=</span><span style="color: #dd1144">&quot;x.name for x in o&quot;</span> <span style="color: #008080">ng-change=</span><span style="color: #dd1144">&quot;show()&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;/select&gt;</span>
<span style="color: #000080">&lt;/form&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
显示与值分别指定， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">x.v as x.name for x in o</code> ：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;form</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;test_form&quot;</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span>
      <span style="color: #008080">ng-init=</span><span style="color: #dd1144">&quot;o=[{name: &#39;AA&#39;, v: &#39;00&#39;}, {name: &#39;BB&#39;, v: &#39;11&#39;}]; a=o[1].v;&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;select</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">ng-options=</span><span style="color: #dd1144">&quot;x.v as x.name for x in o&quot;</span> <span style="color: #008080">ng-change=</span><span style="color: #dd1144">&quot;show()&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;/select&gt;</span>
<span style="color: #000080">&lt;/form&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
加入分组的， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">x.name group by x.g for x in o</code> ：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;form</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;test_form&quot;</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span>
      <span style="color: #008080">ng-init=</span><span style="color: #dd1144">&quot;o=[{name: &#39;AA&#39;, g: &#39;00&#39;},</span>
<span style="color: #dd1144">                  {name: &#39;BB&#39;, g: &#39;11&#39;},</span>
<span style="color: #dd1144">                  {name: &#39;CC&#39;, g: &#39;00&#39;}]; a=o[1];&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;select</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">ng-options=</span><span style="color: #dd1144">&quot;x.name group by x.g for x in o&quot;</span> <span style="color: #008080">ng-change=</span><span style="color: #dd1144">&quot;show()&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;/select&gt;</span>
<span style="color: #000080">&lt;/form&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
分组了还分别指定显示与值的， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">x.v as x.name group by x.g for x in o</code> ：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;form</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;test_form&quot;</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span>
<span style="color: #008080">ng-init=</span><span style="color: #dd1144">&quot;o=[{name: &#39;AA&#39;, g: &#39;00&#39;, v: &#39;=&#39;},</span>
<span style="color: #dd1144">            {name: &#39;BB&#39;, g: &#39;11&#39;, v: &#39;+&#39;},</span>
<span style="color: #dd1144">            {name: &#39;CC&#39;, g: &#39;00&#39;, v: &#39;!&#39;}]; a=o[1].v;&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;select</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">ng-options=</span><span style="color: #dd1144">&quot;x.v as x.name group by x.g for x in o&quot;</span>
          <span style="color: #008080">ng-change=</span><span style="color: #dd1144">&quot;show()&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;/select&gt;</span>
<span style="color: #000080">&lt;/form&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
如果参数是对象的话，基本也是一样的，只是把遍历的对象改成 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">(key, value)</code> ：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;form</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;test_form&quot;</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span> <span style="color: #008080">ng-init=</span><span style="color: #dd1144">&quot;o={a: 0, b: 1}; a=o.a;&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;select</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">ng-options=</span><span style="color: #dd1144">&quot;k for (k, v) in o&quot;</span> <span style="color: #008080">ng-change=</span><span style="color: #dd1144">&quot;show()&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;/select&gt;</span>
<span style="color: #000080">&lt;/form&gt;</span>

<span style="color: #000080">&lt;form</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;test_form&quot;</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span>
      <span style="color: #008080">ng-init=</span><span style="color: #dd1144">&quot;o={a: {name: &#39;AA&#39;, v: &#39;00&#39;}, b: {name: &#39;BB&#39;, v: &#39;11&#39;}}; a=o.a.v;&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;select</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">ng-options=</span><span style="color: #dd1144">&quot;v.v as v.name for (k, v) in o&quot;</span>
          <span style="color: #008080">ng-change=</span><span style="color: #dd1144">&quot;show()&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;/select&gt;</span>
<span style="color: #000080">&lt;/form&gt;</span>

<span style="color: #000080">&lt;form</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;test_form&quot;</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span>
      <span style="color: #008080">ng-init=</span><span style="color: #dd1144">&quot;o={a: {name: &#39;AA&#39;, v: &#39;00&#39;, g: &#39;==&#39;},</span>
<span style="color: #dd1144">                  b: {name: &#39;BB&#39;, v: &#39;11&#39;, g: &#39;==&#39;}}; a=o.a;&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;select</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">ng-options=</span><span style="color: #dd1144">&quot;v.name group by v.g for (k, v) in o&quot;</span>
          <span style="color: #008080">ng-change=</span><span style="color: #dd1144">&quot;show()&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;/select&gt;</span>
<span style="color: #000080">&lt;/form&gt;</span>

<span style="color: #000080">&lt;form</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;test_form&quot;</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span>
      <span style="color: #008080">ng-init=</span><span style="color: #dd1144">&quot;o={a: {name: &#39;AA&#39;, v: &#39;00&#39;, g: &#39;==&#39;},</span>
<span style="color: #dd1144">                  b: {name: &#39;BB&#39;, v: &#39;11&#39;, g: &#39;==&#39;}}; a=o.a.v;&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;select</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">ng-options=</span><span style="color: #dd1144">&quot;v.v as v.name group by v.g for (k, v) in o&quot;</span>
          <span style="color: #008080">ng-change=</span><span style="color: #dd1144">&quot;show()&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;/select&gt;</span>
<span style="color: #000080">&lt;/form&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc28"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">8. 模板中的过滤器</h1>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这里说的过滤器，是用于对数据的格式化，或者筛选的函数。它们可以直接在模板中通过一种语法使用。对于常用功能来说，是很方便的一种机制。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
多个过滤器之间可以直接连续使用。
</p>

<a class="anchor" name="toc29"></a>
<h2 style="font-size: 18px; margin: 30px auto;">8.1. 排序 orderBy</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">orderBy</em> 是一个排序用的过滤器标签。它可以像 <em style="color: #d75100; font-style: normal;">sort</em> 函数那样支持一个排序函数，也可以简单地指定一个属性名进行操作：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  {{ data | orderBy: &#39;age&#39; }} <span style="color: #000080">&lt;br</span> <span style="color: #000080">/&gt;</span>
  {{ data | orderBy: &#39;-age&#39; }} <span style="color: #000080">&lt;br</span> <span style="color: #000080">/&gt;</span>
  {{ data | orderBy: &#39;-age&#39; | limitTo: 2 }} <span style="color: #000080">&lt;br</span> <span style="color: #000080">/&gt;</span>
  {{ data | orderBy: [&#39;-age&#39;, &#39;name&#39;] }} <span style="color: #000080">&lt;br</span> <span style="color: #000080">/&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>


<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000080">&gt;</span>
angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.data <span style="color: #000000; font-weight: bold">=</span> [
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;B&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">4</span>},  
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;A&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">1</span>},  
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;D&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">3</span>},  
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;C&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">3</span>},  
  ];
});
angular.bootstrap(<span style="color: #0086B3">document</span>.documentElement, [<span style="color: #dd1144">&#39;app&#39;</span>]);
<span style="color: #000080">&lt;/script&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc30"></a>
<h2 style="font-size: 18px; margin: 30px auto;">8.2. 过滤列表 filter</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">filter</em> 是一个过滤内容的标签。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
如果参数是一个字符串，则列表成员中的任意属性值中有这个字符串，即为满足条件（忽略大小写）：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  {{ data | filter: &#39;b&#39; }} <span style="color: #000080">&lt;br</span> <span style="color: #000080">/&gt;</span>
  {{ data | filter: &#39;!B&#39; }} <span style="color: #000080">&lt;br</span> <span style="color: #000080">/&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>


<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000080">&gt;</span>
angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.data <span style="color: #000000; font-weight: bold">=</span> [
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;B&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">4</span>},  
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;A&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">1</span>},  
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;D&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">3</span>},  
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;C&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">3</span>},  
  ];
});
angular.bootstrap(<span style="color: #0086B3">document</span>.documentElement, [<span style="color: #dd1144">&#39;app&#39;</span>]);
<span style="color: #000080">&lt;/script&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
可以使用对象，来指定属性名， <em style="color: #d75100; font-style: normal;">$</em> 表示任意属性：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">{{ data | filter: {name: &#39;A&#39;} }} <span style="color: #000080">&lt;br</span> <span style="color: #000080">/&gt;</span>
{{ data | filter: {$: &#39;3&#39;} }} <span style="color: #000080">&lt;br</span> <span style="color: #000080">/&gt;</span>
{{ data | filter: {$: &#39;!3&#39;} }} <span style="color: #000080">&lt;br</span> <span style="color: #000080">/&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
自定义的过滤函数也支持：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  {{ data | filter: f }} <span style="color: #000080">&lt;br</span> <span style="color: #000080">/&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>


<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000080">&gt;</span>
angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.data <span style="color: #000000; font-weight: bold">=</span> [
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;B&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">4</span>},  
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;A&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">1</span>},  
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;D&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">3</span>},  
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;C&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">3</span>},  
  ];

  $scope.f <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(e){
    <span style="color: #000000; font-weight: bold">return</span> e.age <span style="color: #000000; font-weight: bold">&gt;</span> <span style="color: #009999">2</span>;
  }
});
angular.bootstrap(<span style="color: #0086B3">document</span>.documentElement, [<span style="color: #dd1144">&#39;app&#39;</span>]);
<span style="color: #000080">&lt;/script&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc31"></a>
<h2 style="font-size: 18px; margin: 30px auto;">8.3. 其它</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
时间戳格式化 <em style="color: #d75100; font-style: normal;">date</em> ：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
{{ a | date: &#39;yyyy-MM-dd HH:mm:ss&#39; }}
<span style="color: #000080">&lt;/div&gt;</span>

<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000080">&gt;</span>
angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.a <span style="color: #000000; font-weight: bold">=</span> ((<span style="color: #000000; font-weight: bold">new</span> <span style="color: #0086B3">Date</span>().valueOf()));
});
angular.bootstrap(<span style="color: #0086B3">document</span>.documentElement, [<span style="color: #dd1144">&#39;app&#39;</span>]);
<span style="color: #000080">&lt;/script&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
列表截取 <em style="color: #d75100; font-style: normal;">limitTo</em> ，支持正负数：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">{{ [1,2,3,4,5] | limitTo: 2 }}
{{ [1,2,3,4,5] | limitTo: -3 }}
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
大小写 <em style="color: #d75100; font-style: normal;">lowercase</em> ， <em style="color: #d75100; font-style: normal;">uppercase</em> ：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">{{ &#39;abc&#39; | uppercase }}
{{ &#39;Abc&#39; | lowercase }}
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc32"></a>
<h2 style="font-size: 18px; margin: 30px auto;">8.4. 例子：表头排序</h2>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;table&gt;</span>
    <span style="color: #000080">&lt;tr&gt;</span>
      <span style="color: #000080">&lt;th</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;f=&#39;name&#39;; rev=!rev&quot;</span><span style="color: #000080">&gt;</span>名字<span style="color: #000080">&lt;/th&gt;</span>
      <span style="color: #000080">&lt;th</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;f=&#39;age&#39;; rev=!rev&quot;</span><span style="color: #000080">&gt;</span>年龄<span style="color: #000080">&lt;/th&gt;</span>
    <span style="color: #000080">&lt;/tr&gt;</span>

    <span style="color: #000080">&lt;tr</span> <span style="color: #008080">ng-repeat=</span><span style="color: #dd1144">&quot;o in data | orderBy: f : rev&quot;</span><span style="color: #000080">&gt;</span>
      <span style="color: #000080">&lt;td&gt;</span>{{ o.name }}<span style="color: #000080">&lt;/td&gt;</span>
      <span style="color: #000080">&lt;td&gt;</span>{{ o.age }}<span style="color: #000080">&lt;/td&gt;</span>
    <span style="color: #000080">&lt;/tr&gt;</span>
  <span style="color: #000080">&lt;/table&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>

<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000080">&gt;</span>
angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.data <span style="color: #000000; font-weight: bold">=</span> [
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;B&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">4</span>},  
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;A&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">1</span>},  
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;D&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">3</span>},  
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;C&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">3</span>},  
  ];
});
angular.bootstrap(<span style="color: #0086B3">document</span>.documentElement, [<span style="color: #dd1144">&#39;app&#39;</span>]);
<span style="color: #000080">&lt;/script&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc33"></a>
<h2 style="font-size: 18px; margin: 30px auto;">8.5. 例子：搜索</h2>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span> <span style="color: #008080">ng-init=</span><span style="color: #dd1144">&quot;s=data[0].name; q=&#39;&#39;&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;div&gt;</span>
    <span style="color: #000080">&lt;span&gt;</span>查找：<span style="color: #000080">&lt;/span&gt;</span> <span style="color: #000080">&lt;input</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text&quot;</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;q&quot;</span> <span style="color: #000080">/&gt;</span>
  <span style="color: #000080">&lt;/div&gt;</span>
  <span style="color: #000080">&lt;select</span> <span style="color: #008080">ng-multiple=</span><span style="color: #dd1144">&quot;true&quot;</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;s&quot;</span>
          <span style="color: #008080">ng-options=</span><span style="color: #dd1144">&quot;o.name as o.name + &#39;(&#39; + o.age + &#39;)&#39; for o in data</span>
<span style="color: #dd1144">                            | filter: {name: q} | orderBy: [&#39;age&#39;, &#39;name&#39;] &quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;/select&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>

<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000080">&gt;</span>
<span style="color: #000000; font-weight: bold">var</span> TestCtrl <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.data <span style="color: #000000; font-weight: bold">=</span> [
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;B&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">4</span>},  
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;A&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">1</span>},  
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;D&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">3</span>},  
    {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;C&#39;</span>, age<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">3</span>},  
  ];
}

angular.bootstrap(<span style="color: #0086B3">document</span>.documentElement);
<span style="color: #000080">&lt;/script&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc34"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">9. 锚点路由</h1>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
准确地说，这应该叫对 <em style="color: #d75100; font-style: normal;">hashchange</em> 事件的处理吧。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
就是指 URL 中的锚点部分发生变化时，触发预先定义的业务逻辑。比如现在是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">/test#/x</code> ，锚点部分的值为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">#</code> 后的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">/x</code> ，它就对应了一组处理逻辑。当这部分变化时，比如变成了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">/test#/t</code> ，这时页面是不会刷新的，但是它可以触发另外一组处理逻辑，来做一些事，也可以让页面发生变化。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这种机制对于复杂的单页面来说，无疑是一种强大的业务切分手段。就算不是复杂的单页面应用，在普通页面上善用这种机制，也可以让业务逻辑更容易控制。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
ng 提供了完善的锚点路由功能，虽然目前我觉得相当重要的一个功能还有待完善（后面会说），但目前这功能的几部分内容，已经让我思考了很多种可能性了。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
ng 中的锚点路由功能是由几部分 API 共同完成的一整套方案。这其中包括了路由定义，参数定义，业务处理等。
</p>

<a class="anchor" name="toc35"></a>
<h2 style="font-size: 18px; margin: 30px auto;">9.1. 路由定义</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
要使用锚点路由功能，需要在先定义它。目前，对于定义的方法，我个人只发现在“初始化”阶段可以通过 <em style="color: #d75100; font-style: normal;">$routeProvider</em> 这个服务来定义。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在定义一个 app 时可以定义锚点路由：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;html</span> <span style="color: #008080">ng-app=</span><span style="color: #dd1144">&quot;ngView&quot;</span><span style="color: #000080">&gt;</span>
  ... ...

<span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-view</span><span style="color: #000080">&gt;&lt;/div&gt;</span>

<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000080">&gt;</span>

angular.module(<span style="color: #dd1144">&#39;ngView&#39;</span>, [],
  <span style="color: #000000; font-weight: bold">function</span>($routeProvider){
    $routeProvider.when(<span style="color: #dd1144">&#39;/test&#39;</span>,
      {
        template<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;test&#39;</span>,
      }
    );
  }
);

<span style="color: #000080">&lt;/script&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
首先看 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">ng-view</code> 这个 directive ，它是一个标记“锚点作用区”的指令。目前页面上只能有一个“锚点作用区”。有人已经提了，“多个可命名”的锚点作用区的代码到官方，但是目前官方还没有接受合并，我觉得多个作用区这个功能是很重要的，希望下个发布版中能有。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
锚点作用区的功能，就是让锚点路由定义时的那些模板， controller 等，它们产生的 HTML 代码放在作用区内。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
比如上面的代码，当你刚打开页面时，页面是空白的。你手动访问 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">/#/test</code> 就可以看到页面上出现了 <em style="color: #d75100; font-style: normal;">'test'</em> 的字样。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在 <em style="color: #d75100; font-style: normal;">angular.bootstrap()</em> 时也可以定义：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">angular.bootstrap(<span style="color: #0086B3">document</span>.documentElement, [
  <span style="color: #000000; font-weight: bold">function</span>($routeProvider){
    $routeProvider.when(<span style="color: #dd1144">&#39;/test&#39;</span>,
      {
        template<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;test&#39;</span>
      }
    );
  }
]);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc36"></a>
<h2 style="font-size: 18px; margin: 30px auto;">9.2. 参数定义</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在作路由定义时，可以匹配一个规则，规则中可以定义路径中的某些部分作为参数之用，然后使用 <em style="color: #d75100; font-style: normal;">$routeParams</em> 服务获取到指定参数。比如 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">/#/book/test</code> 中， <em style="color: #d75100; font-style: normal;">test</em> 作为参数传入到 controller 中：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">&lt;</span>div ng<span style="color: #000000; font-weight: bold">-</span>view<span style="color: #000000; font-weight: bold">&gt;&lt;</span><span style="color: #a61717; background-color: #e3d2d2">/div&gt;</span>


<span style="color: #000000; font-weight: bold">&lt;</span>script type<span style="color: #000000; font-weight: bold">=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000000; font-weight: bold">&gt;</span>

angular.module(<span style="color: #dd1144">&#39;ngView&#39;</span>, [],
  <span style="color: #000000; font-weight: bold">function</span>($routeProvider){
    $routeProvider.when(<span style="color: #dd1144">&#39;/book/:title&#39;</span>,
      {
        template<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;{{ title }}&#39;</span>,
        controller<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">function</span>($scope, $routeParams){
          $scope.title <span style="color: #000000; font-weight: bold">=</span> $routeParams.title;
        }
      }
    );
  }
);

<span style="color: #000000; font-weight: bold">&lt;</span><span style="color: #a61717; background-color: #e3d2d2">/script&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
访问： <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">/#/book/test</code>
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
不需要预定义模式，也可以像普通 GET 请求那样获取到相关参数：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">angular.module(<span style="color: #dd1144">&#39;ngView&#39;</span>, [],
  <span style="color: #000000; font-weight: bold">function</span>($routeProvider){
    $routeProvider.when(<span style="color: #dd1144">&#39;/book&#39;</span>,
      {
        template<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;{{ title }}&#39;</span>,
        controller<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">function</span>($scope, $routeParams){
          $scope.title <span style="color: #000000; font-weight: bold">=</span> $routeParams.title;
        }
      }
    );
  }
);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
访问： <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">/#/book?title=test</code>
</p>

<a class="anchor" name="toc37"></a>
<h2 style="font-size: 18px; margin: 30px auto;">9.3. 业务处理</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
简单来说，当一个锚点路由定义被匹配时，会根据模板生成一个 <em style="color: #d75100; font-style: normal;">$scope</em> ，同时相应的一个 controller 就会被触发。最后模板的结果会被填充到 <em style="color: #d75100; font-style: normal;">ng-view</em> 中去。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
从上面的例子中可以看到，最直接的方式，我们可以在模板中双向绑定数据，而数据的来源，在 controller 中控制。在 controller 中，又可以使用到像 <em style="color: #d75100; font-style: normal;">$scope</em> ， <em style="color: #d75100; font-style: normal;">$routeParams</em> 这些服务。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这里先提一下另外一种与锚点路由相关的服务， <em style="color: #d75100; font-style: normal;">$route</em> 。这个服务里锚点路由在定义时，及匹配过程中的信息。比如我们搞怪一下：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">angular.module(<span style="color: #dd1144">&#39;ngView&#39;</span>, [],
  <span style="color: #000000; font-weight: bold">function</span>($routeProvider){
    $routeProvider.when(<span style="color: #dd1144">&#39;/a&#39;</span>,
      {
        template<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;{{ title }}&#39;</span>,
        controller<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">function</span>($scope){
          $scope.title <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;a&#39;</span>;
        }
      }
    );

    $routeProvider.when(<span style="color: #dd1144">&#39;/b&#39;</span>,
      {
        template<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;{{ title }}&#39;</span>,
        controller<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">function</span>($scope, $route){
          console.log($route);
          $route.routes[<span style="color: #dd1144">&#39;/a&#39;</span>].controller($scope);
        }
      }
    );
  }
);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
回到锚点定义的业务处理中来。我们可以以字符串形式写模板，也可以直接引用外部文件作为模板：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">angular.module(<span style="color: #dd1144">&#39;ngView&#39;</span>, <span style="color: #999999; font-weight: bold">[]</span>,
  <span style="color: #000000; font-weight: bold">function</span>($routeProvider){
    $routeProvider.when(<span style="color: #dd1144">&#39;/test&#39;</span>,
      {
        templateUrl<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;tpl.html&#39;</span>,
        controller<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">function</span>($scope){
          $scope.title <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;a&#39;</span>;
        }
      }
    );
  }
);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">tpl.html</em> 中的内容是：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">{{ title }}
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这样的话，模板可以预定义，也可以很复杂了。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
现在暂时忘了模板吧，因为前面提到的，当前 <em style="color: #d75100; font-style: normal;">ng-view</em> 不能有多个的限制，模板的渲染机制局限性还是很大的。不过，反正会触发一个 controller ，那么在函数当中我们可以尽量地干自己喜欢的事：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">angular.module(&#39;ngView&#39;, [],
  function($routeProvider){
    $routeProvider.when(&#39;/test&#39;,
      {
        template: &#39;{{}}&#39;,
        controller: function(){
          $(&#39;div&#39;).first().html(&#39;<span style="color: #000080">&lt;b&gt;</span>OK<span style="color: #000080">&lt;/b&gt;</span>&#39;);
        }
      }
    );
  }
);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
那个空的 <em style="color: #d75100; font-style: normal;">template</em> 不能省，否则 controller 不会被触发。
</p>

<a class="anchor" name="toc38"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">10. 定义模板变量标识标签</h1>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
由于下面涉及动态内容，所以我打算起一个后端服务来做。但是我发现我使用的 Tornado 框架的模板系统，与 ng 的模板系统，都是使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">{{ }}</code> 这对符号来定义模板表达式的，这太悲剧了，不过幸好 ng 已经提供了修改方法：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">angular.bootstrap(<span style="color: #0086B3">document</span>.documentElement,
  <span style="color: #999999; font-weight: bold">[</span>function(<span style="color: #008080">$interpolateProvider</span>){
    <span style="color: #008080">$interpolateProvider.startSymbol</span>(<span style="color: #dd1144">&#39;[[&#39;</span>);
    <span style="color: #008080">$interpolateProvider.endSymbol</span>(<span style="color: #dd1144">&#39;]]&#39;</span>);
  }<span style="color: #999999; font-weight: bold">]</span>);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
使用 <em style="color: #d75100; font-style: normal;">$interpolateProvider</em> 服务即可。
</p>

<a class="anchor" name="toc39"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">11. AJAX</h1>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
ng 提供了基本的 AJAX 封装，你直接面对 promise 对象，使用起来还是很方便的。
</p>

<a class="anchor" name="toc40"></a>
<h2 style="font-size: 18px; margin: 30px auto;">11.1. HTTP请求</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
基本的操作由 <em style="color: #d75100; font-style: normal;">$http</em> 服务提供。它的使用很简单，提供一些描述请求的参数，请求就出去了，然后返回一个扩充了 <em style="color: #d75100; font-style: normal;">success</em> 方法和 <em style="color: #d75100; font-style: normal;">error</em> 方法的 <em style="color: #d75100; font-style: normal;">promise</em> 对象（下节介绍），你可以在这个对象中添加需要的回调函数。
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  <span style="color: #000000; font-weight: bold">var</span> p <span style="color: #000000; font-weight: bold">=</span> $http({
    method<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;GET&#39;</span>,
    url<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;/json&#39;</span>
  });
  p.success(<span style="color: #000000; font-weight: bold">function</span>(response, status, headers, config){
      $scope.name <span style="color: #000000; font-weight: bold">=</span> response.name;
  });
});
angular.bootstrap(<span style="color: #0086B3">document</span>.documentElement, [<span style="color: #dd1144">&#39;app&#39;</span>]);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">$http</em> 接受的配置项有：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">method 方法
</li>
<li style="margin: 10px auto;">url 路径
</li>
<li style="margin: 10px auto;">params GET请求的参数
</li>
<li style="margin: 10px auto;">data post请求的参数
</li>
<li style="margin: 10px auto;">headers 头
</li>
<li style="margin: 10px auto;">transformRequest 请求预处理函数
</li>
<li style="margin: 10px auto;">transformResponse 响应预处理函数
</li>
<li style="margin: 10px auto;">cache 缓存
</li>
<li style="margin: 10px auto;">timeout 超时毫秒，超时的请求会被取消
</li>
<li style="margin: 10px auto;">withCredentials 跨域安全策略的一个东西 
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
其中的 <em style="color: #d75100; font-style: normal;">transformRequest</em> 和 <em style="color: #d75100; font-style: normal;">transformResponse</em> 及 <em style="color: #d75100; font-style: normal;">headers</em> 已经有定义的，如果自定义则会覆盖默认定义：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> $config <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">this</span>.defaults <span style="color: #000000; font-weight: bold">=</span> {
  <span style="color: #999988">// transform incoming response data</span>
  transformResponse<span style="color: #000000; font-weight: bold">:</span> [<span style="color: #000000; font-weight: bold">function</span>(data) {
    <span style="color: #000000; font-weight: bold">if</span> (isString(data)) {
      <span style="color: #999988">// strip json vulnerability protection prefix</span>
      data <span style="color: #000000; font-weight: bold">=</span> data.replace(PROTECTION_PREFIX, <span style="color: #dd1144">&#39;&#39;</span>);
      <span style="color: #000000; font-weight: bold">if</span> (JSON_START.test(data) <span style="color: #000000; font-weight: bold">&amp;&amp;</span> JSON_END.test(data))
        data <span style="color: #000000; font-weight: bold">=</span> fromJson(data, <span style="color: #000000; font-weight: bold">true</span>);
    }
    <span style="color: #000000; font-weight: bold">return</span> data;
  }],

  <span style="color: #999988">// transform outgoing request data</span>
  transformRequest<span style="color: #000000; font-weight: bold">:</span> [<span style="color: #000000; font-weight: bold">function</span>(d) {
    <span style="color: #000000; font-weight: bold">return</span> isObject(d) <span style="color: #000000; font-weight: bold">&amp;&amp;</span> <span style="color: #000000; font-weight: bold">!</span>isFile(d) <span style="color: #000000; font-weight: bold">?</span> toJson(d) <span style="color: #000000; font-weight: bold">:</span> d;
  }],

  <span style="color: #999988">// default headers</span>
  headers<span style="color: #000000; font-weight: bold">:</span> {
    common<span style="color: #000000; font-weight: bold">:</span> {
      <span style="color: #dd1144">&#39;Accept&#39;</span><span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;application/json, text/plain, */*&#39;</span>,
      <span style="color: #dd1144">&#39;X-Requested-With&#39;</span><span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;XMLHttpRequest&#39;</span>
    },
    post<span style="color: #000000; font-weight: bold">:</span> {<span style="color: #dd1144">&#39;Content-Type&#39;</span><span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;application/json;charset=utf-8&#39;</span>},
    put<span style="color: #000000; font-weight: bold">:</span>  {<span style="color: #dd1144">&#39;Content-Type&#39;</span><span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;application/json;charset=utf-8&#39;</span>}
  }
};
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<strong style="color: red; font-weight: normal;">注意它默认的 POST 方法出去的 Content-Type</strong>
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
对于几个标准的 HTTP 方法，有对应的 shortcut ：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">$http.delete(url, config)
</li>
<li style="margin: 10px auto;">$http.get(url, config)
</li>
<li style="margin: 10px auto;">$http.head(url, config)
</li>
<li style="margin: 10px auto;">$http.jsonp(url, config)
</li>
<li style="margin: 10px auto;">$http.post(url, data, config)
</li>
<li style="margin: 10px auto;">$http.put(url, data, config)
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
注意其中的 JSONP 方法，在实现上会在页面中添加一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">script</code> 标签，然后放出一个 GET 请求。你自己定义的，匿名回调函数，会被 ng 自已给一个全局变量。在定义请求，作为 GET 参数，你可以使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">JSON_CALLBACK</code> 这个字符串来暂时代替回调函数名，之后 ng 会为你替换成真正的函数名：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> p <span style="color: #000000; font-weight: bold">=</span> $http({
  method<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;JSONP&#39;</span>,
  url<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;/json&#39;</span>,
  params<span style="color: #000000; font-weight: bold">:</span> {callback<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;JSON_CALLBACK&#39;</span>}
});
p.success(<span style="color: #000000; font-weight: bold">function</span>(response, status, headers, config){
    console.log(response);
    $scope.name <span style="color: #000000; font-weight: bold">=</span> response.name;
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">$http</em> 有两个属性：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">defaults 请求的全局配置
</li>
<li style="margin: 10px auto;">pendingRequests 当前的请求队列状态
</li>
</ul>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">$http.defaults.transformRequest <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(data){console.log(<span style="color: #dd1144">&#39;here&#39;</span>); <span style="color: #000000; font-weight: bold">return</span> data;}
console.log($http.pendingRequests);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc41"></a>
<h2 style="font-size: 18px; margin: 30px auto;">11.2. 广义回调管理</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
和其它框架一样， ng 提供了广义的异步回调管理的机制。 <em style="color: #d75100; font-style: normal;">$http</em> 服务是在其之上封装出来的。这个机制就是 ng 的 <em style="color: #d75100; font-style: normal;">$q</em> 服务。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
不过 ng 的这套机制总的来说实现得比较简单，按官方的说法，够用了。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
使用的方法，基本上是：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">通过 <em style="color: #d75100; font-style: normal;">$q</em> 服务得到一个 <em style="color: #d75100; font-style: normal;">deferred</em> 实例
</li>
<li style="margin: 10px auto;">通过 <em style="color: #d75100; font-style: normal;">deferred</em> 实例的 <em style="color: #d75100; font-style: normal;">promise</em> 属性得到一个 <em style="color: #d75100; font-style: normal;">promise</em> 对象
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">promise</em> 对象负责定义回调函数
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">deferred</em> 实例负责触发回调
</li>
</ul>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  <span style="color: #000000; font-weight: bold">var</span> defer <span style="color: #000000; font-weight: bold">=</span> $q.defer();
  <span style="color: #000000; font-weight: bold">var</span> promise <span style="color: #000000; font-weight: bold">=</span> defer.promise;
  promise.then(<span style="color: #000000; font-weight: bold">function</span>(data){console.log(<span style="color: #dd1144">&#39;ok, &#39;</span> <span style="color: #000000; font-weight: bold">+</span> data)},
               <span style="color: #000000; font-weight: bold">function</span>(data){console.log(<span style="color: #dd1144">&#39;error, &#39;</span> <span style="color: #000000; font-weight: bold">+</span> data)});
  <span style="color: #999988">//defer.reject(&#39;xx&#39;);</span>
  defer.resolve(<span style="color: #dd1144">&#39;xx&#39;</span>);
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
了解了上面的东西，再分别看 <em style="color: #d75100; font-style: normal;">$q</em> ， <em style="color: #d75100; font-style: normal;">deferred</em> ， <em style="color: #d75100; font-style: normal;">promise</em> 这三个东西。
</p>

<a class="anchor" name="toc42"></a>
<h3 style="font-size: 16px; margin: 25px auto;">11.2.1. $q</h3>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">$q</em> 有四个方法：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">$q.all()</em> 合并多个 <em style="color: #d75100; font-style: normal;">promise</em> ，得到一个新的 <em style="color: #d75100; font-style: normal;">promise</em>
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">$q.defer()</em> 返回一个 <em style="color: #d75100; font-style: normal;">deferred</em> 对象
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">$q.reject()</em> 包装一个错误，以使回调链能正确处理下去
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">$q.when()</em> 返回一个 <em style="color: #d75100; font-style: normal;">promise</em> 对象
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">$q.all()</em> 方法适用于并发场景很合适：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  <span style="color: #000000; font-weight: bold">var</span> p <span style="color: #000000; font-weight: bold">=</span> $http.get(<span style="color: #dd1144">&#39;/json&#39;</span>, {params<span style="color: #000000; font-weight: bold">:</span> {a<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">1</span>}});
  <span style="color: #000000; font-weight: bold">var</span> p2 <span style="color: #000000; font-weight: bold">=</span> $http.get(<span style="color: #dd1144">&#39;/json&#39;</span>, {params<span style="color: #000000; font-weight: bold">:</span> {a<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">2</span>}});
  <span style="color: #000000; font-weight: bold">var</span> all <span style="color: #000000; font-weight: bold">=</span> $q.all([p, p2]);
  p.success(<span style="color: #000000; font-weight: bold">function</span>(res){console.log(<span style="color: #dd1144">&#39;here&#39;</span>)});
  all.then(<span style="color: #000000; font-weight: bold">function</span>(res){console.log(res[<span style="color: #009999">0</span>])});
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">$q.reject()</em> 方法是在你捕捉异常之后，又要把这个异常在回调链中传下去时使用：
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
要理解这东西，先看看 <em style="color: #d75100; font-style: normal;">promise</em> 的链式回调是如何运作的，看下面两段代码的区别：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> defer <span style="color: #000000; font-weight: bold">=</span> $q.defer();
<span style="color: #000000; font-weight: bold">var</span> p <span style="color: #000000; font-weight: bold">=</span> defer.promise;
p.then(
  <span style="color: #000000; font-weight: bold">function</span>(data){<span style="color: #000000; font-weight: bold">return</span> <span style="color: #dd1144">&#39;xxx&#39;</span>}
);
p.then(
  <span style="color: #000000; font-weight: bold">function</span>(data){console.log(data)}
);
defer.resolve(<span style="color: #dd1144">&#39;123&#39;</span>);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> defer <span style="color: #000000; font-weight: bold">=</span> $q.defer();
<span style="color: #000000; font-weight: bold">var</span> p <span style="color: #000000; font-weight: bold">=</span> defer.promise;
<span style="color: #000000; font-weight: bold">var</span> p2 <span style="color: #000000; font-weight: bold">=</span> p.then(
  <span style="color: #000000; font-weight: bold">function</span>(data){<span style="color: #000000; font-weight: bold">return</span> <span style="color: #dd1144">&#39;xxx&#39;</span>}
);
p2.then(
  <span style="color: #000000; font-weight: bold">function</span>(data){console.log(data)}
);
defer.resolve(<span style="color: #dd1144">&#39;123&#39;</span>);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
从模型上看，前者是“并发”，后者才是“链式”。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
而 <em style="color: #d75100; font-style: normal;">$q.reject()</em> 的作用就是触发后链的 <em style="color: #d75100; font-style: normal;">error</em> 回调：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> defer <span style="color: #000000; font-weight: bold">=</span> $q.defer();
<span style="color: #000000; font-weight: bold">var</span> p <span style="color: #000000; font-weight: bold">=</span> defer.promise;
p.then(
  <span style="color: #000000; font-weight: bold">function</span>(data){<span style="color: #000000; font-weight: bold">return</span> data},
  <span style="color: #000000; font-weight: bold">function</span>(data){<span style="color: #000000; font-weight: bold">return</span> $q.reject(data)}
).
then(
  <span style="color: #000000; font-weight: bold">function</span>(data){console.log(<span style="color: #dd1144">&#39;ok, &#39;</span> <span style="color: #000000; font-weight: bold">+</span> data)},
  <span style="color: #000000; font-weight: bold">function</span>(data){console.log(<span style="color: #dd1144">&#39;error, &#39;</span> <span style="color: #000000; font-weight: bold">+</span> data)}
)
defer.reject(<span style="color: #dd1144">&#39;123&#39;</span>);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
最后的 <em style="color: #d75100; font-style: normal;">$q.when()</em> 是把数据封装成 <em style="color: #d75100; font-style: normal;">promise</em> 对象：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> p <span style="color: #000000; font-weight: bold">=</span> $q.when(<span style="color: #009999">0</span>, <span style="color: #000000; font-weight: bold">function</span>(data){<span style="color: #000000; font-weight: bold">return</span> data},
                   <span style="color: #000000; font-weight: bold">function</span>(data){<span style="color: #000000; font-weight: bold">return</span> data});
p.then(
  <span style="color: #000000; font-weight: bold">function</span>(data){console.log(<span style="color: #dd1144">&#39;ok, &#39;</span> <span style="color: #000000; font-weight: bold">+</span> data)},
  <span style="color: #000000; font-weight: bold">function</span>(data){console.log(<span style="color: #dd1144">&#39;error, &#39;</span> <span style="color: #000000; font-weight: bold">+</span> data)}
);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc43"></a>
<h3 style="font-size: 16px; margin: 25px auto;">11.2.2. deferred</h3>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">deferred</em> 对象有两个方法一个属性。
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">promise</em> 属性就是返回一个 <em style="color: #d75100; font-style: normal;">promise</em> 对象的。
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">resolve()</em> 成功回调
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">reject()</em> 失败回调
</li>
</ul>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> defer <span style="color: #000000; font-weight: bold">=</span> $q.defer();
<span style="color: #000000; font-weight: bold">var</span> promise <span style="color: #000000; font-weight: bold">=</span> defer.promise;
promise.then(<span style="color: #000000; font-weight: bold">function</span>(data){console.log(<span style="color: #dd1144">&#39;ok, &#39;</span> <span style="color: #000000; font-weight: bold">+</span> data)},
             <span style="color: #000000; font-weight: bold">function</span>(data){console.log(<span style="color: #dd1144">&#39;error, &#39;</span> <span style="color: #000000; font-weight: bold">+</span> data)});
<span style="color: #999988">//defer.reject(&#39;xx&#39;);</span>
defer.resolve(<span style="color: #dd1144">&#39;xx&#39;</span>);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc44"></a>
<h3 style="font-size: 16px; margin: 25px auto;">11.2.3. promise</h3>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">promise</em> 对象只有 <em style="color: #d75100; font-style: normal;">then()</em> 一个方法，注册成功回调函数和失败回调函数，再返回一个 <em style="color: #d75100; font-style: normal;">promise</em> 对象，以用于链式调用。
</p>

<a class="anchor" name="toc45"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">12. 工具函数</h1>

<a class="anchor" name="toc46"></a>
<h2 style="font-size: 18px; margin: 30px auto;">12.1. 上下文绑定</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">angular.bind</em> 是用来进行上下文绑定，参数动态绑定的工具函数。
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> f <span style="color: #000000; font-weight: bold">=</span> angular.bind({a<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;xx&#39;</span>},
  <span style="color: #000000; font-weight: bold">function</span>(){
    console.log(<span style="color: #000000; font-weight: bold">this</span>.a);
  }
);
f();
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
参数动态绑定：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> f <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(x){console.log(x)}
angular.bind({}, f, <span style="color: #dd1144">&#39;x&#39;</span>)();
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc47"></a>
<h2 style="font-size: 18px; margin: 30px auto;">12.2. 对象处理</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
对象复制： <em style="color: #d75100; font-style: normal;">angular.copy()</em>
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> a <span style="color: #000000; font-weight: bold">=</span> {<span style="color: #dd1144">&#39;x&#39;</span><span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;123&#39;</span>};
<span style="color: #000000; font-weight: bold">var</span> b <span style="color: #000000; font-weight: bold">=</span> angular.copy(a);
a.x <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;456&#39;</span>;
console.log(b);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
对象聚合： <em style="color: #d75100; font-style: normal;">angular.extend()</em>
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> a <span style="color: #000000; font-weight: bold">=</span> {<span style="color: #dd1144">&#39;x&#39;</span><span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;123&#39;</span>};
<span style="color: #000000; font-weight: bold">var</span> b <span style="color: #000000; font-weight: bold">=</span> {<span style="color: #dd1144">&#39;xx&#39;</span><span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;456&#39;</span>};
angular.extend(b, a);
console.log(b);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
空函数： <em style="color: #d75100; font-style: normal;">angular.noop()</em>
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
大小写转换： <em style="color: #d75100; font-style: normal;">angular.lowercase()</em> 和 <em style="color: #d75100; font-style: normal;">angular.uppercase()</em> 
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
JSON转换： <em style="color: #d75100; font-style: normal;">angular.fromJson()</em> 和 <em style="color: #d75100; font-style: normal;">angular.toJson()</em> 
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
遍历： <em style="color: #d75100; font-style: normal;">angular.forEach()</em> ，支持列表和对象：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> l <span style="color: #000000; font-weight: bold">=</span> {a<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;1&#39;</span>, b<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;2&#39;</span>};
angular.forEach(l, <span style="color: #000000; font-weight: bold">function</span>(v, k){console.log(k <span style="color: #000000; font-weight: bold">+</span> <span style="color: #dd1144">&#39;: &#39;</span> <span style="color: #000000; font-weight: bold">+</span> v)});

<span style="color: #000000; font-weight: bold">var</span> l <span style="color: #000000; font-weight: bold">=</span> [<span style="color: #dd1144">&#39;a&#39;</span>, <span style="color: #dd1144">&#39;b&#39;</span>, <span style="color: #dd1144">&#39;c&#39;</span>];
angular.forEach(l, <span style="color: #000000; font-weight: bold">function</span>(v, i, o){console.log(v)});

<span style="color: #000000; font-weight: bold">var</span> context <span style="color: #000000; font-weight: bold">=</span> {<span style="color: #dd1144">&#39;t&#39;</span><span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;xx&#39;</span>};
angular.forEach(l, <span style="color: #000000; font-weight: bold">function</span>(v, i, o){console.log(<span style="color: #000000; font-weight: bold">this</span>.t)}, context);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc48"></a>
<h2 style="font-size: 18px; margin: 30px auto;">12.3. 类型判定</h2>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">angular.isArray
</li>
<li style="margin: 10px auto;">angular.isDate
</li>
<li style="margin: 10px auto;">angular.isDefined
</li>
<li style="margin: 10px auto;">angular.isElement
</li>
<li style="margin: 10px auto;">angular.isFunction
</li>
<li style="margin: 10px auto;">angular.isNumber
</li>
<li style="margin: 10px auto;">angular.isObject
</li>
<li style="margin: 10px auto;">angular.isString
</li>
<li style="margin: 10px auto;">angular.isUndefined
</li>
</ul>

<a class="anchor" name="toc49"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">13. 其它服务</h1>

<a class="anchor" name="toc50"></a>
<h2 style="font-size: 18px; margin: 30px auto;">13.1. 日志</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
ng 提供 <em style="color: #d75100; font-style: normal;">$log</em> 这个服务用于向终端输出相关信息：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">error()
</li>
<li style="margin: 10px auto;">info()
</li>
<li style="margin: 10px auto;">log()
</li>
<li style="margin: 10px auto;">warn()
</li>
</ul>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $log.error(<span style="color: #dd1144">&#39;error&#39;</span>);
  $log.info(<span style="color: #dd1144">&#39;info&#39;</span>);
  $log.log(<span style="color: #dd1144">&#39;log&#39;</span>);
  $log.warn(<span style="color: #dd1144">&#39;warn&#39;</span>);
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc51"></a>
<h2 style="font-size: 18px; margin: 30px auto;">13.2. 缓存</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
ng 提供了一个简单封装了缓存机制 <em style="color: #d75100; font-style: normal;">$cacheFactory</em> ，可以用来作为数据容器：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> TestCtrl <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($scope, $cacheFactory){
  $scope.cache <span style="color: #000000; font-weight: bold">=</span> $cacheFactory(<span style="color: #dd1144">&#39;s_&#39;</span> <span style="color: #000000; font-weight: bold">+</span> $scope.$id, {capacity<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">3</span>});

  $scope.show <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){
    console.log($scope.cache.get(<span style="color: #dd1144">&#39;a&#39;</span>));
    console.log($scope.cache.info());
  }

  $scope.set <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){
    $scope.cache.put((<span style="color: #000000; font-weight: bold">new</span> <span style="color: #0086B3">Date</span>()).valueOf(), <span style="color: #dd1144">&#39;ok&#39;</span>);
  }
}
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
调用时，第一个参数是 id ，第二个参数是配置项，目前支持 <em style="color: #d75100; font-style: normal;">capacity</em> 参数，用以设置缓存能容留的最大条目数。超过这个个数，则自动清除较旧的条目。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
缓存实例的方法：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">info()</em> 获取 id , size 信息
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">put(k, v)</em> 设置新条目
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">get(k)</em> 获取条目
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">remove(k)</em> 删除条目
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">removeAll()</em> 删除所有条目
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">destroy()</em> 删除对本实例的引用
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">$http</em> 的调用当中，有一个 <em style="color: #d75100; font-style: normal;">cache</em> 参数，值为 <em style="color: #d75100; font-style: normal;">true</em> 时为自动维护的缓存。值也可以设置为一个 cache 实例。
</p>

<a class="anchor" name="toc52"></a>
<h2 style="font-size: 18px; margin: 30px auto;">13.3. 计时器</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">$timeout</em> 服务是 ng 对 <em style="color: #d75100; font-style: normal;">window.setTimeout()</em> 的封装，它使用 <em style="color: #d75100; font-style: normal;">promise</em> 统一了计时器的回调行为：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  <span style="color: #000000; font-weight: bold">var</span> p <span style="color: #000000; font-weight: bold">=</span> $timeout(<span style="color: #000000; font-weight: bold">function</span>(){console.log(<span style="color: #dd1144">&#39;haha&#39;</span>)}, <span style="color: #009999">5000</span>);
  p.then(<span style="color: #000000; font-weight: bold">function</span>(){console.log(<span style="color: #dd1144">&#39;x&#39;</span>)});
  <span style="color: #999988">//$timeout.cancel(p);</span>
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
使用 <em style="color: #d75100; font-style: normal;">$timeout.cancel()</em> 可以取消计时器。
</p>

<a class="anchor" name="toc53"></a>
<h2 style="font-size: 18px; margin: 30px auto;">13.4. 表达式函数化</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">$parse</em> 这个服务，为 js 提供了类似于 Python 中 <em style="color: #d75100; font-style: normal;">@property</em> 的能力：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.get_name <span style="color: #000000; font-weight: bold">=</span> $parse(<span style="color: #dd1144">&#39;name&#39;</span>);
  $scope.show <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){console.log($scope.get_name($scope))}
  $scope.set <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){$scope.name <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;123&#39;</span>}
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">$parse</em> 返回一个函数，调用这个函数时，可以传两个参数，第一个作用域，第二个是变量集，后者常用于覆盖前者的变量：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> get_name <span style="color: #000000; font-weight: bold">=</span> $parse(<span style="color: #dd1144">&#39;name&#39;</span>);
<span style="color: #000000; font-weight: bold">var</span> r <span style="color: #000000; font-weight: bold">=</span> get_name({name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;xx&#39;</span>}, {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;abc&#39;</span>});
console.log(r);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">$parse</em> 返回的函数，也提供了相应的 assign 功能，可以为表达式赋值（如果可以的话）：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> get_name <span style="color: #000000; font-weight: bold">=</span> $parse(<span style="color: #dd1144">&#39;name&#39;</span>);
<span style="color: #000000; font-weight: bold">var</span> set_name <span style="color: #000000; font-weight: bold">=</span> get_name.assign;
<span style="color: #000000; font-weight: bold">var</span> r <span style="color: #000000; font-weight: bold">=</span> get_name({name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;xx&#39;</span>}, {name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;abc&#39;</span>});
console.log(r);

<span style="color: #000000; font-weight: bold">var</span> s <span style="color: #000000; font-weight: bold">=</span> {}
set_name(s, <span style="color: #dd1144">&#39;123&#39;</span>);
<span style="color: #000000; font-weight: bold">var</span> r <span style="color: #000000; font-weight: bold">=</span> get_name(s);
console.log(r);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc54"></a>
<h2 style="font-size: 18px; margin: 30px auto;">13.5. 模板单独使用</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
ng 中的模板是很重要，也很强大的一个机制，自然少不了单独运用它的方法。不过，即使是单独使用，也是和 DOM 紧密相关的程度：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">定义时必须是有 HTML 标签包裹的，这样才能创建 DOM 节点
</li>
<li style="margin: 10px auto;">渲染时必须传入 <em style="color: #d75100; font-style: normal;">$scope</em> 
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
之后使用 <em style="color: #d75100; font-style: normal;">$compile</em> 就可以得到一个渲染好的节点对象了。当然， <em style="color: #d75100; font-style: normal;">$compile</em> 还要做其它一些工作，指令处理什么的。
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">angular.module(<span style="color: #dd1144">&#39;app&#39;</span>, [], angular.noop)
.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;123&#39;</span>;
  $scope.set <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){
    <span style="color: #000000; font-weight: bold">var</span> tpl <span style="color: #000000; font-weight: bold">=</span> $compile(<span style="color: #dd1144">&#39;&lt;p&gt;hello {{ a }}&lt;/p&gt;&#39;</span>);
    <span style="color: #000000; font-weight: bold">var</span> e <span style="color: #000000; font-weight: bold">=</span> tpl($scope);
    $element.append(e);
  }
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc55"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">14. 自定义模块和服务</h1>

<a class="anchor" name="toc56"></a>
<h2 style="font-size: 18px; margin: 30px auto;">14.1. 模块和服务的概念与关系</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
总的来说，模块是组织业务的一个框框，在一个模块当中定义多个服务。当你引入了一个模块的时候，就可以使用这个模块提供的一种或多种服务了。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
比如 <em style="color: #d75100; font-style: normal;">AngularJS</em> 本身的一个默认模块叫做 <em style="color: #d75100; font-style: normal;">ng</em> ，它提供了 <em style="color: #d75100; font-style: normal;">$http</em> ， <em style="color: #d75100; font-style: normal;">$q</em> 等等服务。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
服务只是模块提供的多种机制中的一种，其它的还有命令（ <em style="color: #d75100; font-style: normal;">directive</em> ），过滤器（ <em style="color: #d75100; font-style: normal;">filter</em> ），及其它配置信息。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
然后在额外的 js 文件中有一个附加的模块叫做 <em style="color: #d75100; font-style: normal;">ngResource</em> ， 它提供了一个 <em style="color: #d75100; font-style: normal;">$resource</em> 服务。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
定义时，我们可以在已有的模块中新定义一个服务，也可以先新定义一个模块，然后在新模块中定义新服务。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
使用时，模块是需要显式地的声明依赖（引入）关系的，而服务则可以让 <em style="color: #d75100; font-style: normal;">ng</em> 自动地做注入，然后直接使用。
</p>

<a class="anchor" name="toc57"></a>
<h2 style="font-size: 18px; margin: 30px auto;">14.2. 定义模块</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
定义模块的方法是使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">angular.module</code> 。调用时声明了对其它模块的依赖，并定义了“初始化”函数。
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> my_module <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;MyModule&#39;</span>, [], <span style="color: #000000; font-weight: bold">function</span>(){
    console.log(<span style="color: #dd1144">&#39;here&#39;</span>);
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这段代码定义了一个叫做 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">MyModule</code> 的模块， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">my_module</code> 这个引用可以在接下来做其它的一些事，比如定义服务。
</p>

<a class="anchor" name="toc58"></a>
<h2 style="font-size: 18px; margin: 30px auto;">14.3. 定义服务</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
服务本身是一个任意的对象。但是 <em style="color: #d75100; font-style: normal;">ng</em> 提供服务的过程涉及它的依赖注入机制。在这里呢，就要先介绍一下叫 <em style="color: #d75100; font-style: normal;">provider</em> 的东西。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
简单来说， <em style="color: #d75100; font-style: normal;">provider</em> 是被“注入控制器”使用的一个对象，注入机制通过调用一个 <em style="color: #d75100; font-style: normal;">provider</em> 的 <em style="color: #d75100; font-style: normal;">$get()</em> 方法，把得到的东西作为参数进行相关调用（比如把得到的服务作为一个 <em style="color: #d75100; font-style: normal;">Controller</em> 的参数）。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在这里“服务”的概念就比较不明确，对使用而言，服务仅指 <em style="color: #d75100; font-style: normal;">$get()</em> 方法返回的东西，但是在整体机制上，服务又要指提供了 <em style="color: #d75100; font-style: normal;">$get()</em> 方法的整个对象。
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #999988">//这是一个provider</span>
<span style="color: #000000; font-weight: bold">var</span> pp <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">this</span>.$get <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){
    <span style="color: #000000; font-weight: bold">return</span> {<span style="color: #dd1144">&#39;haha&#39;</span><span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;123&#39;</span>};
  }
}

<span style="color: #999988">//我在模块的初始化过程当中, 定义了一个叫 PP 的服务</span>
<span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], <span style="color: #000000; font-weight: bold">function</span>($provide){
  $provide.provider(<span style="color: #dd1144">&#39;PP&#39;</span>, pp);
});

<span style="color: #999988">//PP服务实际上就是 pp 这个 provider 的 $get() 方法返回的东西</span>
app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>,
  <span style="color: #000000; font-weight: bold">function</span>($scope, PP){
    console.log(PP);
  }
);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
上面的代码是一种定义服务的方法，当然， <em style="color: #d75100; font-style: normal;">ng</em> 还有相关的 shortcut， <em style="color: #d75100; font-style: normal;">ng</em> 总有很多 shortcut 。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
第一个是 <em style="color: #d75100; font-style: normal;">factory</em> 方法，由 <em style="color: #d75100; font-style: normal;">$provide</em> 提供， <em style="color: #d75100; font-style: normal;">module</em> 的 <em style="color: #d75100; font-style: normal;">factory</em> 是一个引用，作用一样。这个方法直接把一个函数当成是一个对象的 <em style="color: #d75100; font-style: normal;">$get()</em> 方法，这样你就不用显式地定义一个 <em style="color: #d75100; font-style: normal;">provider</em> 了：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], <span style="color: #000000; font-weight: bold">function</span>($provide){
  $provide.factory(<span style="color: #dd1144">&#39;PP&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
    <span style="color: #000000; font-weight: bold">return</span> {<span style="color: #dd1144">&#39;hello&#39;</span><span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;123&#39;</span>};
  });
});
app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope, PP){ console.log(PP) });
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在 <em style="color: #d75100; font-style: normal;">module</em> 中使用：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], <span style="color: #000000; font-weight: bold">function</span>(){ });
app.factory(<span style="color: #dd1144">&#39;PP&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){<span style="color: #000000; font-weight: bold">return</span> {<span style="color: #dd1144">&#39;abc&#39;</span><span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;123&#39;</span>}});
app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope, PP){ console.log(PP) });
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
第二个是 <em style="color: #d75100; font-style: normal;">service</em> 方法，也是由 <em style="color: #d75100; font-style: normal;">$provide</em> 提供， <em style="color: #d75100; font-style: normal;">module</em> 中有对它的同名引用。 <em style="color: #d75100; font-style: normal;">service</em> 和 <em style="color: #d75100; font-style: normal;">factory</em> 的区别在于，前者是要求提供一个“构造方法”，后者是要求提供 <em style="color: #d75100; font-style: normal;">$get()</em> 方法。意思就是，前者一定是得到一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">object</code> ，后者可以是一个数字或字符串。它们的关系大概是：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], <span style="color: #000000; font-weight: bold">function</span>(){ });
app.service <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(name, constructor){
  app.factory(name, <span style="color: #000000; font-weight: bold">function</span>(){
    <span style="color: #000000; font-weight: bold">return</span> (<span style="color: #000000; font-weight: bold">new</span> constructor());
  });
}
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这里插一句，js 中 <em style="color: #d75100; font-style: normal;">new</em> 的作用，以 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">new a()</code> 为例，过程相当于：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">创建一个空对象 obj
</li>
<li style="margin: 10px auto;">把 obj 绑定到 a 函数的上下文当中（即 a 中的 this 现在指向 obj ）
</li>
<li style="margin: 10px auto;">执行 a 函数
</li>
<li style="margin: 10px auto;">返回 obj
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">service</em> 方法的使用就很简单了：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], <span style="color: #000000; font-weight: bold">function</span>(){ });
app.service(<span style="color: #dd1144">&#39;PP&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">this</span>.abc <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;123&#39;</span>;
});
app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope, PP){ console.log(PP) });
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc59"></a>
<h2 style="font-size: 18px; margin: 30px auto;">14.4. 引入模块并使用服务</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
结合上面的“定义模块”和“定义服务”，我们可以方便地组织自己的额外代码：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">angular.module(<span style="color: #dd1144">&#39;MyModule&#39;</span>, [], <span style="color: #000000; font-weight: bold">function</span>($provide){
  $provide.factory(<span style="color: #dd1144">&#39;S1&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
    <span style="color: #000000; font-weight: bold">return</span> <span style="color: #dd1144">&#39;I am S1&#39;</span>;
  });
  $provide.factory(<span style="color: #dd1144">&#39;S2&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
    <span style="color: #000000; font-weight: bold">return</span> {see<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">function</span>(){<span style="color: #000000; font-weight: bold">return</span> <span style="color: #dd1144">&#39;I am S2&#39;</span>}}
  });
});

<span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [<span style="color: #dd1144">&#39;MyModule&#39;</span>], angular.noop);
app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope, S1, S2){
  console.log(S1)
  console.log(S2.see())
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc60"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">15. 附加模块 ngResource</h1>

<a class="anchor" name="toc61"></a>
<h2 style="font-size: 18px; margin: 30px auto;">15.1. 使用引入与整体概念</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">ngResource</em> 这个是 <em style="color: #d75100; font-style: normal;">ng</em> 官方提供的一个附加模块。附加的意思就是，如果你打算用它，那么你需要引入一人单独的 js 文件，然后在声明“根模块”时注明依赖的 <em style="color: #d75100; font-style: normal;">ngResource</em> 模块，接着就可以使用它提供的 <em style="color: #d75100; font-style: normal;">$resource</em> 服务了。完整的过程形如：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #999999; font-weight: bold">&lt;!DOCTYPE html&gt;</span>
<span style="color: #000080">&lt;html</span> <span style="color: #008080">ng-app=</span><span style="color: #dd1144">&quot;Demo&quot;</span><span style="color: #000080">&gt;</span>
<span style="color: #000080">&lt;head&gt;</span>
<span style="color: #000080">&lt;meta</span> <span style="color: #008080">charset=</span><span style="color: #dd1144">&quot;utf-8&quot;</span> <span style="color: #000080">/&gt;</span>
<span style="color: #000080">&lt;title&gt;</span>AngularJS<span style="color: #000080">&lt;/title&gt;</span>
<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span>
        <span style="color: #008080">src=</span><span style="color: #dd1144">&quot;http://ajax.googleapis.com/ajax/libs/angularjs/1.0.3/angular.min.js&quot;</span><span style="color: #000080">&gt;&lt;/script&gt;</span>
<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span>
        <span style="color: #008080">src=</span><span style="color: #dd1144">&quot;http://ajax.googleapis.com/ajax/libs/angularjs/1.0.3/angular-resource.js&quot;</span><span style="color: #000080">&gt;&lt;/script&gt;</span>
<span style="color: #000080">&lt;/head&gt;</span>
<span style="color: #000080">&lt;body&gt;</span>

  <span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;&lt;/div&gt;</span>


<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span> <span style="color: #008080">charset=</span><span style="color: #dd1144">&quot;utf-8&quot;</span><span style="color: #000080">&gt;</span>

<span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [<span style="color: #dd1144">&#39;ngResource&#39;</span>], angular.noop);
app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope, $resource){
  console.log($resource);
});

<span style="color: #000080">&lt;/script&gt;</span>
<span style="color: #000080">&lt;/body&gt;</span>
<span style="color: #000080">&lt;/html&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">$resource</em> 服务，整体上来说，比较像是使用类似 ORM 的方式来包装了 AJAX 调用。区别就是 ORM 是操作数据库，即拼出 SQL 语句之后，作 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">execute</code> 方法调用。而 <em style="color: #d75100; font-style: normal;">$resource</em> 的方式是构造出 AJAX 请求，然后发出请求。同时，AJAX 请求是需要回调处理的，这方面， <em style="color: #d75100; font-style: normal;">$resource</em> 的机制可以使你在一些时候省掉回调处理，当然，是否作回调处理在于业务情形及容错需求了。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
使用上 <em style="color: #d75100; font-style: normal;">$resource</em> 分成了“类”与“实例”这两个层面。一般地，类的方法调用就是直观的调用形式，通常会返回一个对象，这个对象即为“实例”。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
“实例”贯穿整个服务的使用过程。“实例”的数据是填充方式，即因为异步关系，回调函数没有执行时，实例已经存在，只是可能它还没有相关数据，回调执行之后，相关数据被填充到实例对象当中。实例的方法一般就是在类方法名前加一个 <em style="color: #d75100; font-style: normal;">$</em> ，调用上，根据定义，实例数据可能会做一些自动的参数填充，这点是区别实例与类的调用上的不同。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
好吧，上面这些话可能需要在看了接下来的内容之后再回过来理解。
</p>

<a class="anchor" name="toc62"></a>
<h2 style="font-size: 18px; margin: 30px auto;">15.2. 基本定义</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
就像使用 ORM 一般要先定义 Model 一样，使用 <em style="color: #d75100; font-style: normal;">$resource</em> 需要先定义“资源”，也就是先定义一些 HTTP 请求。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在业务场景上，我们假设为，我们需要操作“书”这个实体，包括创建create，获取详情read，修改update，删除delete，批量获取multi，共五个操作方法。实体属性有：唯一标识id，标题title，作者author。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
我们把这些操作定义成 <em style="color: #d75100; font-style: normal;">$resource</em> 的资源：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [<span style="color: #dd1144">&#39;ngResource&#39;</span>], angular.noop);
app.controller(<span style="color: #dd1144">&#39;BookCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope, $resource){
  <span style="color: #000000; font-weight: bold">var</span> actions <span style="color: #000000; font-weight: bold">=</span> {
    create<span style="color: #000000; font-weight: bold">:</span> {method<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;POST&#39;</span>, params<span style="color: #000000; font-weight: bold">:</span> {_method<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;create&#39;</span>}},
    read<span style="color: #000000; font-weight: bold">:</span> {method<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;POST&#39;</span>, params<span style="color: #000000; font-weight: bold">:</span> {_method<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;read&#39;</span>}},
    update<span style="color: #000000; font-weight: bold">:</span> {method<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;POST&#39;</span>, params<span style="color: #000000; font-weight: bold">:</span> {_method<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;update&#39;</span>}},
    <span style="color: #000000; font-weight: bold">delete:</span> {method<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;POST&#39;</span>, params<span style="color: #000000; font-weight: bold">:</span> {_method<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;delete&#39;</span>}},
    multi<span style="color: #000000; font-weight: bold">:</span> {method<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;POST&#39;</span>, params<span style="color: #000000; font-weight: bold">:</span> {_method<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;multi&#39;</span>}}
  }
  <span style="color: #000000; font-weight: bold">var</span> Book <span style="color: #000000; font-weight: bold">=</span> $resource(<span style="color: #dd1144">&#39;/book&#39;</span>, {}, actions);
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
定义是使用使用 <em style="color: #d75100; font-style: normal;">$resource</em> 这个函数就可以了，它接受三个参数：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">url
</li>
<li style="margin: 10px auto;">默认的params（这里的 params 即是 GET 请求的参数，POST 的参数单独叫做“postData”）
</li>
<li style="margin: 10px auto;">方法映射
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
方法映射是以方法名为 key ，以一个对象为 value ，这个 value 可以有三个成员：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">method, 请求方法，'GET', 'POST', 'PUT', 'DELETE' 这些
</li>
<li style="margin: 10px auto;">params, 默认的 GET 参数
</li>
<li style="margin: 10px auto;">isArray, 返回的数据是不是一个列表
</li>
</ul>

<a class="anchor" name="toc63"></a>
<h2 style="font-size: 18px; margin: 30px auto;">15.3. 基本使用</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在定义了资源之后，我们看如果使用这些资源，发出请求：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> book <span style="color: #000000; font-weight: bold">=</span> Book.read({id<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;123&#39;</span>}, <span style="color: #000000; font-weight: bold">function</span>(response){
  console.log(response);
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这里我们进行 <em style="color: #d75100; font-style: normal;">Book</em> 的“类”方法调用。在方法的使用上，根据官方文档：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">HTTP GET &quot;class&quot; actions: Resource.action([parameters], [success], [error])
non-GET &quot;class&quot; actions: Resource.action([parameters], postData, [success], [error])
non-GET instance actions: instance.$action([parameters], [success], [error])
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
我们这里是第二种形式，即类方法的非 GET 请求。我们给的参数会作为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">postData</code> 传递。如果我们需要 GET 参数，并且还需要一个错误回调，那么：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> book <span style="color: #000000; font-weight: bold">=</span> Book.read({get<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;haha&#39;</span>}, {id<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;123&#39;</span>},
  <span style="color: #000000; font-weight: bold">function</span>(response){
    console.log(response);
  },
  <span style="color: #000000; font-weight: bold">function</span>(error){
    console.log(error);
  }
);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
调用之后，我们会立即得到的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">book</code> ，它是 Book 类的一个实例。这里所谓的实例，实际上就是先把所有的 <em style="color: #d75100; font-style: normal;">action</em> 加一个 <strong style="color: red; font-weight: normal;">$</strong> 前缀放到一个空对象里，然后把发出的参数填充进去。等请求返回了，把除 <em style="color: #d75100; font-style: normal;">action</em> 以外的成员删除掉，再把请求返回的数据填充到这个对象当中。所以，如果我们这样：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> book <span style="color: #000000; font-weight: bold">=</span> Book.read({id<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;123&#39;</span>}, <span style="color: #000000; font-weight: bold">function</span>(response){
  console.log(book);
});
console.log(book)
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
就能看到 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">book</code> 实例的变化过程了。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
现在我们得到一个真实的实例，看一下实例的调用过程：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #999988">//响应的数据是 {result: 0, msg: &#39;&#39;, obj: {id: &#39;xxx&#39;}}</span>
<span style="color: #000000; font-weight: bold">var</span> book <span style="color: #000000; font-weight: bold">=</span> Book.create({title<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;测试标题&#39;</span>, author<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;测试作者&#39;</span>}, <span style="color: #000000; font-weight: bold">function</span>(response){
  console.log(book);
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
可以看到，在请求回调之后， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">book</code> 这个实例的成员已经被响应内容填充了。但是这里有一个问题，我们返回的数据，并不适合一个 book 实例。格式先不说，它把 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">title</code> 和 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">author</code> 这些信息都丢了（因为响应只返回了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">id</code> ）。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
如果仅仅是格式问题，我们可以通过配置 <em style="color: #d75100; font-style: normal;">$http</em> 服务来解决（ AJAX 请求都要使用 <em style="color: #d75100; font-style: normal;">$http</em> 服务的）：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">$http.defaults.transformResponse <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(data){<span style="color: #000000; font-weight: bold">return</span> angular.fromJson(data).obj};
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
当然，我们也可以自己来解决一下丢信息的问题：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> p <span style="color: #000000; font-weight: bold">=</span> {title<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;测试标题&#39;</span>, author<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;测试作者&#39;</span>};
<span style="color: #000000; font-weight: bold">var</span> book <span style="color: #000000; font-weight: bold">=</span> Book.create(p, <span style="color: #000000; font-weight: bold">function</span>(response){
  angular.extend(book, p);
  console.log(book);
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
不过，始终会有一些不方便了。比较正统的方式应该是调节服务器端的响应，让服务器端也具有和前端一样的实例概念，返回的是完整的实例信息。即使这样，你也还要考虑格式的事。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
现在我们得到了一个真实的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">book</code> 实例了，带有 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">id</code> 信息。我们尝试一下实例的方法调用，先回过去头看一下那三种调用形式，对于实例只有第三种形式：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">non-GET instance actions: instance.$action([parameters], [success], [error])
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
首先解决一个疑问，如果一个实例是进行一个 GET 的调用会怎么样？没有任何问题，这当然没有任何问题的，形式和上面一样。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
如何实例是做 POST 请求的话，从形式上看，我们无法控制请求的 <em style="color: #d75100; font-style: normal;">postData</em> ？是的，所有的 POST 请求，其 <em style="color: #d75100; font-style: normal;">postData</em> 都会被实例数据自动填充，形式上我们只能控制 <em style="color: #d75100; font-style: normal;">params</em> 。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
所以，如果是在做修改调用的话：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">book.$update({title<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;新标题&#39;</span>, author<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;测试作者&#39;</span>}, <span style="color: #000000; font-weight: bold">function</span>(response){
  console.log(book);
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这样是没有意义的并且错误的。因为要修改的数据只是作为 GET 参数传递了，而 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">postData</code> 传递的数据就是当前实例的数据，并没有任何修改。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
正确的做法：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">book.title <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;新标题&#39;</span>
book.$update(<span style="color: #000000; font-weight: bold">function</span>(response){
  console.log(book);
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
显然，这种情况下，回调都可以省了：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">book.title <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;新标题&#39;</span>
book.$update();
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc64"></a>
<h2 style="font-size: 18px; margin: 30px auto;">15.4. 定义和使用时的占位量</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
两方面。一是在定义时，在其 URL 中可以使用变量引用的形式（类型于定义锚点路由时那样）。第二时定义默认 <em style="color: #d75100; font-style: normal;">params</em> ，即 GET 参数时，可以定义为引用 <em style="color: #d75100; font-style: normal;">postData</em> 中的某变量。比如我们这样改一下：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> Book <span style="color: #000000; font-weight: bold">=</span> $resource(<span style="color: #dd1144">&#39;/book/:id&#39;</span>, {}, actions);
<span style="color: #000000; font-weight: bold">var</span> book <span style="color: #000000; font-weight: bold">=</span> Book.read({id<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;123&#39;</span>}, {}, <span style="color: #000000; font-weight: bold">function</span>(response){
  console.log(response);
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在 URL 中有一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">:id</code> ，表示对 <em style="color: #d75100; font-style: normal;">params</em> 中 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">id</code> 这个变量的引用。因为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">read</code> 是一个 POST 请求，根据调用形式，第一个参数是 <em style="color: #d75100; font-style: normal;">params</em> ，第二个参数是 <em style="color: #d75100; font-style: normal;">postData</em> 。这样的调用结果就是，我们会发一个 POST 请求到如下地址， <em style="color: #d75100; font-style: normal;">postData</em> 为空：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">/book/123?_method=read
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
再看默认的 <em style="color: #d75100; font-style: normal;">params</em> 中引用 <em style="color: #d75100; font-style: normal;">postData</em> 变量的形式：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> Book <span style="color: #000000; font-weight: bold">=</span> $resource(<span style="color: #dd1144">&#39;/book&#39;</span>, {id<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;@id&#39;</span>}, actions);
<span style="color: #000000; font-weight: bold">var</span> book <span style="color: #000000; font-weight: bold">=</span> Book.read({title<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;xx&#39;</span>}, {id<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;123&#39;</span>}, <span style="color: #000000; font-weight: bold">function</span>(response){
  console.log(response);
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这样会出一个 POST 请求， <em style="color: #d75100; font-style: normal;">postData</em> 内容中有一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">id</code> 数据，访问的 URL 是：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">/book?_method=read&amp;id=123&amp;title=xx
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这两个机制也可以联合使用：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> Book <span style="color: #000000; font-weight: bold">=</span> $resource(<span style="color: #dd1144">&#39;/book/:id&#39;</span>, {id<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;@id&#39;</span>}, actions);
<span style="color: #000000; font-weight: bold">var</span> book <span style="color: #000000; font-weight: bold">=</span> Book.read({title<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;xx&#39;</span>}, {id<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;123&#39;</span>}, <span style="color: #000000; font-weight: bold">function</span>(response){
  console.log(response);
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
结果就是出一个 POST 请求， <em style="color: #d75100; font-style: normal;">postData</em> 内容中有一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">id</code> 数据，访问的 URL 是：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">/book/123?_method=read&amp;title=xx
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc65"></a>
<h2 style="font-size: 18px; margin: 30px auto;">15.5. 实例</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">ngResource</em> 要举一个实例是比较麻烦的事。因为它必须要一个后端来支持，这里如果我用 Python 写一个简单的后端，估计要让这个后端跑起来对很多人来说都是问题。所以，我在几套公共服务的 API 中纠结考察了一番，最后使用 <a href="http://www.rememberthemilk.com" style="color: #0184b7; text-decoration: none">www.rememberthemilk.com</a> 的 API 来做了一个简单的，可用的例子。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
例子见： <a href="http://zouyesheng.com/demo/ng-resource-demo.html" style="color: #0184b7; text-decoration: none">http://zouyesheng.com/demo/ng-resource-demo.html</a>  (可以直接下载看源码)
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
先说一下 API 的情况。这里的请求调用全是跨域的，所以交互上全部是使用了 JSONP 的形式。 API 的使用有使用签名认证机制，嗯， js 中直接算 md5 是可行的，我用了一个现成的库（但是好像不能处理中文吧）。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这个例子中的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">LoginCtrl</code> 大家就不用太关心了，参见官方的文档，走完流程拿到 <em style="color: #d75100; font-style: normal;">token</em> 完事。与 <em style="color: #d75100; font-style: normal;">ngResource</em> 相关的是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">MainCtrl</code> 中的东西。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
其实从这个例子中就可以看出，目前 <em style="color: #d75100; font-style: normal;">ngResource</em> 的机制对于服务端返回的数据的格式是严重依赖的，同时也可以反映出 <em style="color: #d75100; font-style: normal;">$http</em> 对一些场景根本无法应对的局限。所以，我现在的想法是理解 <em style="color: #d75100; font-style: normal;">ngResource</em> 的思想，真正需要的人自己使用 <em style="color: #d75100; font-style: normal;">jQuery</em> 重新实现一遍也许更好。这应该也花不了多少时间， <em style="color: #d75100; font-style: normal;">ngResource</em> 的代码本来不多。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
我为什么说 <em style="color: #d75100; font-style: normal;">$http</em> 在一些场景中有局限呢。在这个例子当中，所有的请求都需要带一个签名，签名值是由请求中带的参数根据规则使用 md5 方法计算出的值。我找不到一个 hook 可以让我在请求出去之前修改这个请求（添加上签名）。所以在这个例子当中，我的做法是根据 <em style="color: #d75100; font-style: normal;">ngResource</em> 的请求最后会使用 <em style="color: #d75100; font-style: normal;">$httpBackend</em> 这个底层服务，在 module 定义时我自己复制官方的相关代码，重新定义 <em style="color: #d75100; font-style: normal;">$httpBackend</em> 服务，在需要的地方做我自己的修改：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">script.src <span style="color: #000000; font-weight: bold">=</span> sign_url(url);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
不错，我就改了这一句，但我不得不复制了 50 行官方源码到我的例子中。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
另外一个需要说的是对返回数据的处理。因为 <em style="color: #d75100; font-style: normal;">ngResource</em> 会使用返回的数据直接填充实例，所以这个数据格式就很重要。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
首先，我们可以使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$http.defaults.transformResponse</code> 来统一处理一下返回的数据，但是这并不能解决所有问题，可目前 <em style="color: #d75100; font-style: normal;">ngResource</em> 并不提供对每一个 <em style="color: #d75100; font-style: normal;">action</em> 的单独的后处理回调函数项。除非你的服务端是经过专门的适应性设计的，否则你用 <em style="color: #d75100; font-style: normal;">ngResource</em> 不可能爽。例子中，我为了获取当前列表的结果，我不得不自己去封装结果：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> list_list <span style="color: #000000; font-weight: bold">=</span> List.getList(<span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> res <span style="color: #000000; font-weight: bold">=</span> list_list[<span style="color: #009999">1</span>];
  <span style="color: #000000; font-weight: bold">while</span>(list_list.length <span style="color: #000000; font-weight: bold">&gt;</span> <span style="color: #009999">0</span>){list_list.pop()};
  angular.forEach(res.list, <span style="color: #000000; font-weight: bold">function</span>(v){
    list_list.push(<span style="color: #000000; font-weight: bold">new</span> List({list<span style="color: #000000; font-weight: bold">:</span> v}));
  });
  $scope.list_list <span style="color: #000000; font-weight: bold">=</span> list_list;
  $scope.show_add <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">true</span>;
  <span style="color: #000000; font-weight: bold">return</span>;
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc66"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">16. AngularJS与其它框架的混用(jQuery, Dojo)</h1>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这个问题似乎很多人都关心，但是事实是，如果了解了 ng 的工作方式，这本来就不是一个问题了。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在我自己使用 ng 的过程当中，一直是混用 jQuery 的，以前还要加上一个 Dojo 。只要了解每种框架的工作方式，在具体的代码中每个框架都做了什么事，那么整体上控制起来就不会有问题。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
回到 ng 上来看，首先对于 jQuery 来说，最开始说提到过，在 DOM 操作部分， ng 与 jQuery 是兼容的，如果没有 jQuery ， ng 自己也实现了兼容的部分 API 。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
同时，最开始也提到过， ng 的使用最忌讳的一点就是修改 DOM 结构——你应该使用 ng 的模板机制进行数据绑定，以此来控制 DOM 结构，而不是直接操作。换句话来说，在不动 DOM 结构的这个前提之下，你的数据随便怎么改，随便使用哪个框架来控制都是没问题的，到时如有必要使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$scope.$digest()</code> 来通知 ng 一下即可。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
下面这个例子，我们使用了 jQuery 中的 <em style="color: #d75100; font-style: normal;">Deferred</em> ( <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$.ajax</code> 就是返回一个 <em style="color: #d75100; font-style: normal;">Deferred</em> )，还使用了 ng 的 <em style="color: #d75100; font-style: normal;">$timeout</em> ，当然是在 ng 的结构之下：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #999999; font-weight: bold">&lt;!DOCTYPE html&gt;</span>
<span style="color: #000080">&lt;html</span> <span style="color: #008080">ng-app=</span><span style="color: #dd1144">&quot;Demo&quot;</span><span style="color: #000080">&gt;</span>
<span style="color: #000080">&lt;head&gt;</span>
<span style="color: #000080">&lt;meta</span> <span style="color: #008080">charset=</span><span style="color: #dd1144">&quot;utf-8&quot;</span> <span style="color: #000080">/&gt;</span>
<span style="color: #000080">&lt;title&gt;</span>AngularJS<span style="color: #000080">&lt;/title&gt;</span>
<span style="color: #000080">&lt;/head&gt;</span>
<span style="color: #000080">&lt;body&gt;</span>

<span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;span</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;go()&quot;</span><span style="color: #000080">&gt;</span>{{ a }}<span style="color: #000080">&lt;/span&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>

<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span>
  <span style="color: #008080">src=</span><span style="color: #dd1144">&quot;http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js&quot;</span><span style="color: #000080">&gt;</span>
<span style="color: #000080">&lt;/script&gt;</span>
<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span>
  <span style="color: #008080">src=</span><span style="color: #dd1144">&quot;http://ajax.googleapis.com/ajax/libs/angularjs/1.0.3/angular.min.js&quot;</span><span style="color: #000080">&gt;</span>
<span style="color: #000080">&lt;/script&gt;</span>

<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000080">&gt;</span>
<span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);
app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope, $timeout){
  $scope.a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;点击我开始&#39;</span>;

  <span style="color: #000000; font-weight: bold">var</span> defer <span style="color: #000000; font-weight: bold">=</span> $.Deferred();
  <span style="color: #000000; font-weight: bold">var</span> f <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){
    <span style="color: #000000; font-weight: bold">if</span>($scope.a <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;&#39;</span>){$scope.a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;已停止&#39;</span>; <span style="color: #000000; font-weight: bold">return</span>}
    defer.done(<span style="color: #000000; font-weight: bold">function</span>(){
      $scope.a.length <span style="color: #000000; font-weight: bold">&lt;</span> <span style="color: #009999">10</span> <span style="color: #000000; font-weight: bold">?</span> $scope.a <span style="color: #000000; font-weight: bold">+=</span> <span style="color: #dd1144">&#39;&gt;&#39;</span> <span style="color: #000000; font-weight: bold">:</span> $scope.a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;&gt;&#39;</span>;
      $timeout(f, <span style="color: #009999">100</span>);
    });
  }
  defer.done(<span style="color: #000000; font-weight: bold">function</span>(){$scope.a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;&gt;&#39;</span>; f()});

  $scope.go <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){
    defer.resolve();
    $timeout(<span style="color: #000000; font-weight: bold">function</span>(){$scope.a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;&#39;</span>}, <span style="color: #009999">5000</span>);
  }
});
<span style="color: #000080">&lt;/script&gt;</span>
<span style="color: #000080">&lt;/body&gt;</span>
<span style="color: #000080">&lt;/html&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
再把 Dojo 加进来看与 DOM 结构相关的例子。之前说过，使用 ng 就最好不要手动修改 DOM 结构，但这里说两点：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">对于整个页面，你可以只在局部使用 ng ，不使用 ng 的地方你可以随意控制 DOM 。
</li>
<li style="margin: 10px auto;">如果 DOM 结构有变动，你可以在 DOM 结构定下来之后再初始化 ng 。
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
下面这个例子使用了 <em style="color: #d75100; font-style: normal;">AngularJS</em> ， <em style="color: #d75100; font-style: normal;">jQuery</em> ， <em style="color: #d75100; font-style: normal;">Dojo</em> ：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #999999; font-weight: bold">&lt;!DOCTYPE html&gt;</span>
<span style="color: #000080">&lt;html&gt;</span>
<span style="color: #000080">&lt;head&gt;</span>
<span style="color: #000080">&lt;meta</span> <span style="color: #008080">charset=</span><span style="color: #dd1144">&quot;utf-8&quot;</span> <span style="color: #000080">/&gt;</span>
<span style="color: #000080">&lt;title&gt;</span>AngularJS<span style="color: #000080">&lt;/title&gt;</span>
<span style="color: #000080">&lt;link</span> <span style="color: #008080">rel=</span><span style="color: #dd1144">&quot;stylesheet&quot;</span>
  <span style="color: #008080">href=</span><span style="color: #dd1144">&quot;http://ajax.googleapis.com/ajax/libs/dojo/1.9.1/dijit/themes/claro/claro.css&quot;</span> <span style="color: #008080">media=</span><span style="color: #dd1144">&quot;screen&quot;</span> <span style="color: #000080">/&gt;</span>
<span style="color: #000080">&lt;/head&gt;</span>
<span style="color: #000080">&lt;body</span> <span style="color: #008080">class=</span><span style="color: #dd1144">&quot;claro&quot;</span><span style="color: #000080">&gt;</span>

<span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span> <span style="color: #008080">id=</span><span style="color: #dd1144">&quot;test_ctrl&quot;</span><span style="color: #000080">&gt;</span>

  <span style="color: #000080">&lt;p</span> <span style="color: #008080">ng-show=</span><span style="color: #dd1144">&quot;!btn_disable&quot;</span><span style="color: #000080">&gt;</span>
    <span style="color: #000080">&lt;button</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;change()&quot;</span><span style="color: #000080">&gt;</span>调用dojo修改按钮<span style="color: #000080">&lt;/button&gt;</span>
  <span style="color: #000080">&lt;/p&gt;</span>

  <span style="color: #000080">&lt;p</span> <span style="color: #008080">id=</span><span style="color: #dd1144">&quot;btn_wrapper&quot;</span><span style="color: #000080">&gt;</span>
    <span style="color: #000080">&lt;button</span> <span style="color: #008080">data-dojo-type=</span><span style="color: #dd1144">&quot;dijit/form/Button&quot;</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;button&quot;</span><span style="color: #000080">&gt;</span>{{ a }}<span style="color: #000080">&lt;/button&gt;</span>
  <span style="color: #000080">&lt;/p&gt;</span>

  <span style="color: #000080">&lt;p&gt;</span>
    <span style="color: #000080">&lt;input</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;dialog_text&quot;</span> <span style="color: #008080">ng-init=</span><span style="color: #dd1144">&quot;dialog_text=&#39;对话框内容&#39;&quot;</span> <span style="color: #000080">/&gt;</span>
    <span style="color: #000080">&lt;button</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;dialog(dialog_text)&quot;</span><span style="color: #000080">&gt;</span>显示对话框<span style="color: #000080">&lt;/button&gt;</span>
  <span style="color: #000080">&lt;/p&gt;</span>

  <span style="color: #000080">&lt;p</span> <span style="color: #008080">ng-show=</span><span style="color: #dd1144">&quot;show_edit_text&quot;</span> <span style="color: #008080">style=</span><span style="color: #dd1144">&quot;display: none;&quot;</span><span style="color: #000080">&gt;</span>
    <span style="color: #000080">&lt;span&gt;</span>需要编辑的内容:<span style="color: #000080">&lt;/span&gt;</span>
    <span style="color: #000080">&lt;input</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;text&quot;</span> <span style="color: #000080">/&gt;</span>
  <span style="color: #000080">&lt;/p&gt;</span>

  <span style="color: #000080">&lt;div</span> <span style="color: #008080">id=</span><span style="color: #dd1144">&quot;editor_wrapper&quot;</span><span style="color: #000080">&gt;</span>
    <span style="color: #000080">&lt;div</span> <span style="color: #008080">data-dojo-type=</span><span style="color: #dd1144">&quot;dijit/Editor&quot;</span> <span style="color: #008080">id=</span><span style="color: #dd1144">&quot;editor&quot;</span><span style="color: #000080">&gt;&lt;/div&gt;</span>
  <span style="color: #000080">&lt;/div&gt;</span>

<span style="color: #000080">&lt;/div&gt;</span>


<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span>
  <span style="color: #008080">src=</span><span style="color: #dd1144">&quot;http://ajax.googleapis.com/ajax/libs/dojo/1.9.1/dojo/dojo.js&quot;</span><span style="color: #000080">&gt;</span>
<span style="color: #000080">&lt;/script&gt;</span>
<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span>
  <span style="color: #008080">src=</span><span style="color: #dd1144">&quot;http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js&quot;</span><span style="color: #000080">&gt;</span>
<span style="color: #000080">&lt;/script&gt;</span>
<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span>
  <span style="color: #008080">src=</span><span style="color: #dd1144">&quot;http://ajax.googleapis.com/ajax/libs/angularjs/1.0.3/angular.min.js&quot;</span><span style="color: #000080">&gt;</span>
<span style="color: #000080">&lt;/script&gt;</span>

<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000080">&gt;</span>

require([<span style="color: #dd1144">&#39;dojo/parser&#39;</span>, <span style="color: #dd1144">&#39;dijit/Editor&#39;</span>], <span style="color: #000000; font-weight: bold">function</span>(parser){
  parser.parse($(<span style="color: #dd1144">&#39;#editor_wrapper&#39;</span>)[<span style="color: #009999">0</span>]).then(<span style="color: #000000; font-weight: bold">function</span>(){
    <span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

    app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope, $timeout){
      $scope.a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;我是ng, 也是dojo&#39;</span>;
      $scope.show_edit_text <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">true</span>;

      $scope.change <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){
        $scope.a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;DOM结构已经改变(不建议这样做)&#39;</span>;
        require([<span style="color: #dd1144">&#39;dojo/parser&#39;</span>, <span style="color: #dd1144">&#39;dijit/form/Button&#39;</span>, <span style="color: #dd1144">&#39;dojo/domReady!&#39;</span>],
          <span style="color: #000000; font-weight: bold">function</span>(parser){
            parser.parse($(<span style="color: #dd1144">&#39;#btn_wrapper&#39;</span>)[<span style="color: #009999">0</span>]);
            $scope.btn_disable <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">true</span>;
          }
        );
      }

      $scope.dialog <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(text){
        require([<span style="color: #dd1144">&quot;dijit/Dialog&quot;</span>, <span style="color: #dd1144">&quot;dojo/domReady!&quot;</span>], <span style="color: #000000; font-weight: bold">function</span>(Dialog){
          <span style="color: #000000; font-weight: bold">var</span> dialog <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">new</span> Dialog({
              title<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&quot;对话框哦&quot;</span>,
              content<span style="color: #000000; font-weight: bold">:</span> text,
              style<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&quot;width: 300px&quot;</span>
          });
          dialog.show();
        });
      }

      require([<span style="color: #dd1144">&#39;dijit/registry&#39;</span>], <span style="color: #000000; font-weight: bold">function</span>(registry){
        <span style="color: #000000; font-weight: bold">var</span> editor <span style="color: #000000; font-weight: bold">=</span> registry.byId(<span style="color: #dd1144">&#39;editor&#39;</span>);
        $scope.$watch(<span style="color: #dd1144">&#39;text&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(new_v){
          editor.setValue(new_v);
        });
      });

    });

    angular.bootstrap(<span style="color: #0086B3">document</span>, [<span style="color: #dd1144">&#39;Demo&#39;</span>]);
  });

});

<span style="color: #000080">&lt;/script&gt;</span>
<span style="color: #000080">&lt;/body&gt;</span>
<span style="color: #000080">&lt;/html&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc67"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">17. 自定义过滤器</h1>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
先来回顾一下 ng 中的一些概念：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">module</em> ，代码的组织单元，其它东西都是在定义在具体的模块中的。
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">app</em> ，业务概念，可能会用到多个模块。
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">service</em> ，仅在数据层面实现特定业务功能的代码封装。
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">controller</em> ，与 DOM 结构相关联的东西，即是一种业务封装概念，又体现了项目组织的层级结构。
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">filter</em> ，改变输入数据的一种机制。
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">directive</em> ，与 DOM 结构相关联的，特定功能的封装形式。
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
上面的这几个概念基本上就是 ng 的全部。每一部分都可以自由定义，使用时通过各要素的相互配合来实现我们的业务需求。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
我们从最开始一致打交道的东西基本上都是 <em style="color: #d75100; font-style: normal;">controller</em> 层面的东西。在前面，也介绍了 <em style="color: #d75100; font-style: normal;">module</em> 和 <em style="color: #d75100; font-style: normal;">service</em> 的自定义。剩下的会介绍 <em style="color: #d75100; font-style: normal;">filter</em> 和 <em style="color: #d75100; font-style: normal;">directive</em> 的定义。基本上这几部分的定义形式都是一样的，原理上是通过 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">provider</code> 来做注入形式的声明，在实际操作过程中，又有很多 shortcut 式的声明方式。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
过滤器的自定义是最简单的，就是一个函数，接受输入，然后返回结果。在考虑过滤器时，我觉得很重要的一点： <strong style="color: red; font-weight: normal;">无状态</strong> 。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
具体来说，过滤器就是一个函数，函数的本质含义就是确定的输入一定得到确定的输出。虽然 <em style="color: #d75100; font-style: normal;">filter</em> 是定义在 <em style="color: #d75100; font-style: normal;">module</em> 当中的，而且 <em style="color: #d75100; font-style: normal;">filter</em> 又是在 <em style="color: #d75100; font-style: normal;">controller</em> 的 DOM 范围内使用的，但是，它和具体的 <em style="color: #d75100; font-style: normal;">module</em> ， <em style="color: #d75100; font-style: normal;">controller</em> ， <em style="color: #d75100; font-style: normal;">scope</em> 这些概念都没有关系（虽然在这里你可以使用 js 的闭包机制玩些花样），它仅仅是一个函数，而已。换句话说，它没有任何上下文关联的能力。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
过滤器基本的定义方式：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);
app.filter(<span style="color: #dd1144">&#39;map&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> filter <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(input){
    <span style="color: #000000; font-weight: bold">return</span> input <span style="color: #000000; font-weight: bold">+</span> <span style="color: #dd1144">&#39;...&#39;</span>;
  };
  <span style="color: #000000; font-weight: bold">return</span> filter;
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
上面的代码定义了一个叫做 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">map</code> 的过滤器。使用时：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;p&gt;</span>示例数据: {{ a|map }}<span style="color: #000080">&lt;/p&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
过滤器也可以带参数，多个参数之间使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">:</code> 分割，看一个完整的例子：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
<span style="color: #000080">&lt;p&gt;</span>示例数据: {{ a|map:map_value:&#39;&gt;&gt;&#39;:&#39;(no)&#39; }}<span style="color: #000080">&lt;/p&gt;</span>
<span style="color: #000080">&lt;p&gt;</span>示例数据: {{ b|map:map_value:&#39;&gt;&gt;&#39;:&#39;(no)&#39; }}<span style="color: #000080">&lt;/p&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>


<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000080">&gt;</span>

<span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);
app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.map_value <span style="color: #000000; font-weight: bold">=</span> {
    a<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;一&#39;</span>,
    b<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;二&#39;</span>,
    c<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;三&#39;</span>
  }
  $scope.a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;a&#39;</span>;
});

app.filter(<span style="color: #dd1144">&#39;map&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> filter <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(input, map_value, append, default_value){
    <span style="color: #000000; font-weight: bold">var</span> r <span style="color: #000000; font-weight: bold">=</span> map_value[input];
    <span style="color: #000000; font-weight: bold">if</span>(r <span style="color: #000000; font-weight: bold">===</span> <span style="color: #000000; font-weight: bold">undefined</span>){ <span style="color: #000000; font-weight: bold">return</span> default_value <span style="color: #000000; font-weight: bold">+</span> append }
    <span style="color: #000000; font-weight: bold">else</span> { <span style="color: #000000; font-weight: bold">return</span> r <span style="color: #000000; font-weight: bold">+</span> append }
  };
  <span style="color: #000000; font-weight: bold">return</span> filter;
});

angular.bootstrap(<span style="color: #0086B3">document</span>, [<span style="color: #dd1144">&#39;Demo&#39;</span>]);
<span style="color: #000080">&lt;/script&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc68"></a>
<h1 style="font-size: 20px; margin: 35px auto; border-bottom: 1px solid gray; padding-top: 5px; padding-bottom: 5px;">18. 自定义指令directive</h1>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这是 ng 最强大的一部分，也是最复杂最让人头疼的部分。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
目前我们看到的所谓“模板”系统，只不过是官方实现的几个指令而已。这意味着，通过自定义各种指令，我们不但可以完全定义一套“模板”系统，更可以把 HTML 页面直接打造成为一种 DSL （领域特定语言）。
</p>

<a class="anchor" name="toc69"></a>
<h2 style="font-size: 18px; margin: 30px auto;">18.1. 指令的使用</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
使用指令时，它的名字可以有多种形式，把指令放在什么地方也有多种选择。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
通常，指令的定义名是形如 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">ngBind</code> 这样的 “camel cased” 形式。在使用时，它的引用名可以是：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">ng:bind
</li>
<li style="margin: 10px auto;">ng_bind
</li>
<li style="margin: 10px auto;">ng-bind
</li>
<li style="margin: 10px auto;">x-ng-bind
</li>
<li style="margin: 10px auto;">data-ng-bind
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
你可以根据你自己是否有 “HTML validator” 洁癖来选择。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
指令可以放在多个地方，它们的作用相同：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">&lt;span my-dir="exp"&gt;&lt;/span&gt;</code> 作为标签的属性
</li>
<li style="margin: 10px auto;"><code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">&lt;span class="my-dir: exp;"&gt;&lt;/span&gt;</code> 作为标签类属性的值
</li>
<li style="margin: 10px auto;"><code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">&lt;my-dir&gt;&lt;/my-dir&gt;</code> 作为标签
</li>
<li style="margin: 10px auto;"><code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">&lt;!-- directive: my-dir exp --&gt;</code> 作为注释
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这些方式可以使用指令定义中的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">restrict</code> 属性来控制。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
可以看出，指令即可以作为标签使用，也可以作为属性使用。仔细考虑一下，这在类 XML 的结构当中真算得上是一种神奇的机制。
</p>

<a class="anchor" name="toc70"></a>
<h2 style="font-size: 18px; margin: 30px auto;">18.2. 指令的执行过程</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
ng 中对指令的解析与执行过程是这样的：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">浏览器得到 HTML 字符串内容，解析得到 DOM 结构。
</li>
<li style="margin: 10px auto;">ng 引入，把 DOM 结构扔给 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$compile</code> 函数处理：
    <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
    <li style="margin: 10px auto;">找出 DOM 结构中有变量占位符
    </li>
    <li style="margin: 10px auto;">匹配找出 DOM 中包含的所有指令引用
    </li>
    <li style="margin: 10px auto;">把指令关联到 DOM 
    </li>
    <li style="margin: 10px auto;">关联到 DOM 的多个指令按权重排列
    </li>
    <li style="margin: 10px auto;">执行指令中的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 函数（改变 DOM 结构，返回 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数）
    </li>
    <li style="margin: 10px auto;">得到的所有 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数组成一个列表作为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$compile</code> 函数的返回
    </li>
    </ul>
</li>
<li style="margin: 10px auto;">执行 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数（连接模板的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code>）。
</li>
</ul>

<a class="anchor" name="toc71"></a>
<h2 style="font-size: 18px; margin: 30px auto;">18.3. 基本的自定义方法</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
自定义一个指令可以非常非常的复杂，但是其基本的调用形式，同自定义服务大概是相同的：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;p</span> <span style="color: #008080">show</span> <span style="color: #008080">style=</span><span style="color: #dd1144">&quot;font-size: 12px;&quot;</span><span style="color: #000080">&gt;&lt;/p&gt;</span>

<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000080">&gt;</span>

<span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;show&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($scope, $element, $attrs){
    console.log($scope);
    console.log($element);
    console.log($attrs);
  }    
  <span style="color: #000000; font-weight: bold">return</span> func;
  <span style="color: #999988">//return {compile: function(){return func}}</span>
});

angular.bootstrap(<span style="color: #0086B3">document</span>, [<span style="color: #dd1144">&#39;Demo&#39;</span>]);
<span style="color: #000080">&lt;/script&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
如果在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">directive</code> 中直接返回一个函数，则这个函数会作为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 的返回值，也即是作为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数使用。这里说的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 和 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 都是一个指令的组成部分，一个完整的定义应该返回一个对象，这个对象包括了多个属性：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">name
</li>
<li style="margin: 10px auto;">priority
</li>
<li style="margin: 10px auto;">terminal
</li>
<li style="margin: 10px auto;">scope
</li>
<li style="margin: 10px auto;">controller
</li>
<li style="margin: 10px auto;">require
</li>
<li style="margin: 10px auto;">restrict
</li>
<li style="margin: 10px auto;">template
</li>
<li style="margin: 10px auto;">templateUrl
</li>
<li style="margin: 10px auto;">replace
</li>
<li style="margin: 10px auto;">transclude
</li>
<li style="margin: 10px auto;">compile
</li>
<li style="margin: 10px auto;">link
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
上面的每一个属性，都可以单独探讨的。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
下面是一个完整的基本的指令定义例子：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;code</span> <span style="color: #008080">lines</span><span style="color: #000080">&gt;</span>
//失去焦点使用 jQuery 的扩展支持冒泡
app.directive(&#39;ngBlur&#39;, function($parse){
  return function($scope, $element, $attr){
    var fn = $parse($attr[&#39;ngBlur&#39;]);
    $element.on(&#39;focusout&#39;, function(event){
      fn($scope, {$event: event});
    });
  }
});
<span style="color: #000080">&lt;/code&gt;</span>

<span style="color: #000080">&lt;div</span> <span style="color: #008080">code</span> <span style="color: #008080">lines</span><span style="color: #000080">&gt;</span>
//失去焦点使用 jQuery 的扩展支持冒泡
app.directive(&#39;ngBlur&#39;, function($parse){
  return function($scope, $element, $attr){
    var fn = $parse($attr[&#39;ngBlur&#39;]);
    $element.on(&#39;focusout&#39;, function(event){
      fn($scope, {$event: event});
    });
  }
});
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;code&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($scope, $element, $attrs){

    <span style="color: #000000; font-weight: bold">var</span> html <span style="color: #000000; font-weight: bold">=</span> $element.text();
    <span style="color: #000000; font-weight: bold">var</span> lines <span style="color: #000000; font-weight: bold">=</span> html.split(<span style="color: #dd1144">&#39;\n&#39;</span>);

    <span style="color: #999988">//处理首尾空白</span>
    <span style="color: #000000; font-weight: bold">if</span>(lines[<span style="color: #009999">0</span>] <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;&#39;</span>){lines <span style="color: #000000; font-weight: bold">=</span> lines.slice(<span style="color: #009999">1</span>, lines.length <span style="color: #000000; font-weight: bold">-</span> <span style="color: #009999">1</span>)}
    <span style="color: #000000; font-weight: bold">if</span>(lines[lines.length<span style="color: #000000; font-weight: bold">-</span><span style="color: #009999">1</span>] <span style="color: #000000; font-weight: bold">==</span> <span style="color: #dd1144">&#39;&#39;</span>){lines <span style="color: #000000; font-weight: bold">=</span> lines.slice(<span style="color: #009999">0</span>, lines.length <span style="color: #000000; font-weight: bold">-</span> <span style="color: #009999">1</span>)}

    $element.empty();

    <span style="color: #999988">//处理外框</span>
    (<span style="color: #000000; font-weight: bold">function</span>(){
      $element.css(<span style="color: #dd1144">&#39;clear&#39;</span>, <span style="color: #dd1144">&#39;both&#39;</span>);
      $element.css(<span style="color: #dd1144">&#39;display&#39;</span>, <span style="color: #dd1144">&#39;block&#39;</span>);
      $element.css(<span style="color: #dd1144">&#39;line-height&#39;</span>, <span style="color: #dd1144">&#39;20px&#39;</span>);
      $element.css(<span style="color: #dd1144">&#39;height&#39;</span>, <span style="color: #dd1144">&#39;200px&#39;</span>);
    })();

    <span style="color: #999988">//是否显示行号的选项</span>
    <span style="color: #000000; font-weight: bold">if</span>(<span style="color: #dd1144">&#39;lines&#39;</span> <span style="color: #000000; font-weight: bold">in</span> $attrs){
      <span style="color: #999988">//处理行号</span>
      (<span style="color: #000000; font-weight: bold">function</span>(){
        <span style="color: #000000; font-weight: bold">var</span> div <span style="color: #000000; font-weight: bold">=</span> $(<span style="color: #dd1144">&#39;&lt;div style=&quot;width: %spx; background-color: gray;&#39;</span> <span style="color: #000000; font-weight: bold">+</span>
                    <span style="color: #dd1144">&#39;float: left; text-align: right; padding-right: 5px;&#39;</span> <span style="color: #000000; font-weight: bold">+</span>
                    <span style="color: #dd1144">&#39;margin-right: 10px;&quot;&gt;&lt;/div&gt;&#39;</span>
                    .replace(<span style="color: #dd1144">&#39;%s&#39;</span>, <span style="color: #0086B3">String</span>(lines.length).length <span style="color: #000000; font-weight: bold">*</span> <span style="color: #009999">10</span>));
        <span style="color: #000000; font-weight: bold">var</span> s <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;&#39;</span>;
        angular.forEach(lines, <span style="color: #000000; font-weight: bold">function</span>(_, i){
          s <span style="color: #000000; font-weight: bold">+=</span> <span style="color: #dd1144">&#39;&lt;pre style=&quot;margin: 0;&quot;&gt;%s&lt;/pre&gt;\n&#39;</span>.replace(<span style="color: #dd1144">&#39;%s&#39;</span>, i <span style="color: #000000; font-weight: bold">+</span> <span style="color: #009999">1</span>);
        });
        div.html(s);
        $element.append(div);
      })();
    }

    <span style="color: #999988">//处理内容</span>
    (<span style="color: #000000; font-weight: bold">function</span>(){
      <span style="color: #000000; font-weight: bold">var</span> div <span style="color: #000000; font-weight: bold">=</span> $(<span style="color: #dd1144">&#39;&lt;div style=&quot;float: left;&quot;&gt;&lt;/div&gt;&#39;</span>);
      <span style="color: #000000; font-weight: bold">var</span> s <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;&#39;</span>;
      angular.forEach(lines, <span style="color: #000000; font-weight: bold">function</span>(l){
        s <span style="color: #000000; font-weight: bold">+=</span> <span style="color: #dd1144">&#39;&lt;span style=&quot;margin: 0;&quot;&gt;%s&lt;/span&gt;&lt;br /&gt;\n&#39;</span>
             .replace(<span style="color: #dd1144">&#39;%s&#39;</span>, l.replace(<span style="color: #009926">/\s/g</span>, <span style="color: #dd1144">&#39;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&#39;</span>));
      });
      div.html(s);
      $element.append(div);
    })();
  }

  <span style="color: #000000; font-weight: bold">return</span> {link<span style="color: #000000; font-weight: bold">:</span> func,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;AE&#39;</span>}; <span style="color: #999988">//以元素或属性的形式使用命令</span>
});

angular.bootstrap(<span style="color: #0086B3">document</span>, [<span style="color: #dd1144">&#39;Demo&#39;</span>]);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
上面这个自定义的指令，做的事情就是解析节点中的文本内容，然后修改它，再把生成的新内容填充到节点当中去。其间还涉及了节点属性值 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">lines</code> 的处理。这算是指令中最简单的一种形式。因为它是“一次性使用”，中间没有变量的处理。比如如果节点原来的文本内容是一个变量引用，类似于 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">{{ code }}</code> ，那上面的代码就不行了。这种情况麻烦得多。后面会讨论。
</p>

<a class="anchor" name="toc72"></a>
<h2 style="font-size: 18px; margin: 30px auto;">18.4. 属性值类型的自定义</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
官方代码中的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">ng-show</code> 等算是我说的这种类型。使用时主要是在节点加添加一个属性值以附加额外的功能。看一个简单的例子：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;p</span> <span style="color: #008080">color=</span><span style="color: #dd1144">&quot;red&quot;</span><span style="color: #000080">&gt;</span>有颜色的文本<span style="color: #000080">&lt;/p&gt;</span>
<span style="color: #000080">&lt;color</span> <span style="color: #008080">color=</span><span style="color: #dd1144">&quot;red&quot;</span><span style="color: #000080">&gt;</span>有颜色的文本<span style="color: #000080">&lt;/color&gt;</span>

<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000080">&gt;</span>

<span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;color&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> link <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($scope, $element, $attrs){
    $element.css(<span style="color: #dd1144">&#39;color&#39;</span>, $attrs.color);
  }
  <span style="color: #000000; font-weight: bold">return</span> {link<span style="color: #000000; font-weight: bold">:</span> link,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;AE&#39;</span>};
});

angular.bootstrap(<span style="color: #0086B3">document</span>, [<span style="color: #dd1144">&#39;Demo&#39;</span>]);
<span style="color: #000080">&lt;/script&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
我们定义了一个叫 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">color</code> 的指令，可以指定节点文本的颜色。但是这个例子还无法像 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">ng-show</code> 那样工作的，这个例子只能渲染一次，然后就无法根据变量来重新改变显示了。要响应变化，我们需要手工使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$watch</code> 来处理：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;p</span> <span style="color: #008080">color=</span><span style="color: #dd1144">&quot;color&quot;</span><span style="color: #000080">&gt;</span>有颜色的文本<span style="color: #000080">&lt;/p&gt;</span>
  <span style="color: #000080">&lt;p</span> <span style="color: #008080">color=</span><span style="color: #dd1144">&quot;&#39;blue&#39;&quot;</span><span style="color: #000080">&gt;</span>有颜色的文本<span style="color: #000080">&lt;/p&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>

<span style="color: #000080">&lt;script </span><span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text/javascript&quot;</span><span style="color: #000080">&gt;</span>

<span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;color&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> link <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($scope, $element, $attrs){
    $scope.$watch($attrs.color, <span style="color: #000000; font-weight: bold">function</span>(new_v){
      $element.css(<span style="color: #dd1144">&#39;color&#39;</span>, new_v);
    });
  }
  <span style="color: #000000; font-weight: bold">return</span> link;
});

app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.color <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;red&#39;</span>;
});

angular.bootstrap(<span style="color: #0086B3">document</span>, [<span style="color: #dd1144">&#39;Demo&#39;</span>]);
<span style="color: #000080">&lt;/script&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc73"></a>
<h2 style="font-size: 18px; margin: 30px auto;">18.5. Compile的细节</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
指令的处理过程，是 ng 的 <em style="color: #d75100; font-style: normal;">Compile</em> 过程的一部分，它们也是紧密联系的。继续深入指令的定义方法，首先就要对 Compile 的过程做更细致的了解。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
前面说过， ng 对页面的处理过程：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">浏览器把 HTML 字符串解析成 DOM 结构。
</li>
<li style="margin: 10px auto;">ng 把 DOM 结构给 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$compile</code> ，返回一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数。
</li>
<li style="margin: 10px auto;">传入具体的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 调用这个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数。
</li>
<li style="margin: 10px auto;">得到处理后的 DOM ，这个 DOM 处理了指令，连接了数据。
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$compile</code> 最基本的使用方式：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> link <span style="color: #000000; font-weight: bold">=</span> $compile(<span style="color: #dd1144">&#39;&lt;p&gt;{{ text }}&lt;/p&gt;&#39;</span>);
<span style="color: #000000; font-weight: bold">var</span> node <span style="color: #000000; font-weight: bold">=</span> link($scope);
console.log(node);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
上面的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$compile</code> 和 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 调用时都有额外参数来实现其它功能。先看 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数，它形如：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">function</span>(scope[, cloneAttachFn]
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
第二个参数 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">cloneAttachFn</code> 的作用是，表明是否复制原始节点，及对复制节点需要做的处理，下面这个例子说明了它的作用：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;&lt;/div&gt;</span>
<span style="color: #000080">&lt;div</span> <span style="color: #008080">id=</span><span style="color: #dd1144">&quot;a&quot;</span><span style="color: #000080">&gt;</span>A {{ text }}<span style="color: #000080">&lt;/div&gt;</span>
<span style="color: #000080">&lt;div</span> <span style="color: #008080">id=</span><span style="color: #dd1144">&quot;b&quot;</span><span style="color: #000080">&gt;</span>B <span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope, $compile){
  <span style="color: #000000; font-weight: bold">var</span> link <span style="color: #000000; font-weight: bold">=</span> $compile($(<span style="color: #dd1144">&#39;#a&#39;</span>));

  <span style="color: #999988">//true参数表示新建一个完全隔离的scope,而不是继承的child scope</span>
  <span style="color: #000000; font-weight: bold">var</span> scope <span style="color: #000000; font-weight: bold">=</span> $scope.$new(<span style="color: #000000; font-weight: bold">true</span>);
  scope.text <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;12345&#39;</span>;

  <span style="color: #999988">//var node = link(scope, function(){});</span>
  <span style="color: #000000; font-weight: bold">var</span> node <span style="color: #000000; font-weight: bold">=</span> link(scope);

  $(<span style="color: #dd1144">&#39;#b&#39;</span>).append(node);
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">cloneAttachFn</code> 对节点的处理是有限制的，你可以添加 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">class</code> ，但是不能做与数据绑定有关的其它修改（修改了也无效）：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope, $compile){
  <span style="color: #000000; font-weight: bold">var</span> link <span style="color: #000000; font-weight: bold">=</span> $compile($(<span style="color: #dd1144">&#39;#a&#39;</span>));
  <span style="color: #000000; font-weight: bold">var</span> scope <span style="color: #000000; font-weight: bold">=</span> $scope.$new(<span style="color: #000000; font-weight: bold">true</span>);
  scope.text <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;12345&#39;</span>;

  <span style="color: #000000; font-weight: bold">var</span> node <span style="color: #000000; font-weight: bold">=</span> link(scope, <span style="color: #000000; font-weight: bold">function</span>(clone_element, scope){
    clone_element.text(clone_element.text() <span style="color: #000000; font-weight: bold">+</span> <span style="color: #dd1144">&#39; ...&#39;</span>); <span style="color: #999988">//无效</span>
    clone_element.text(<span style="color: #dd1144">&#39;{{ text2 }}&#39;</span>); <span style="color: #999988">//无效</span>
    clone_element.addClass(<span style="color: #dd1144">&#39;new_class&#39;</span>);
  });

  $(<span style="color: #dd1144">&#39;#b&#39;</span>).append(node);
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
修改无效的原因是，像 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">{{ text }}</code> 这种所谓的 <em style="color: #d75100; font-style: normal;">Interpolate</em> 在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$compile</code> 中已经被处理过了，生成了相关函数（这里起作用的是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">directive</code> 中的一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">postLink</code> 函数），后面执行 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 就是执行了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$compile</code> 生成的这些函数。当然，如果你的文本没有数据变量的引用，那修改是会有效果的。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
前面在说自定义指令时说过， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数是由 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 函数返回的，也就像前面说的，应该把改变 DOM 结构的逻辑放在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 函数中做。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$compile</code> 还有两个额外的参数：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">$compile(element, transclude, maxPriority);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">maxPriority</code> 是指令的权重限制，这个容易理解，后面再说。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">transclude</code> 是一个函数，这个函数会传递给 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 期间找到的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">directive</code> 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 函数（编译节点的过程中找到了指令，指令的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 函数会接受编译时传递的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">transclude</code> 函数作为其参数）。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
但是在实际使用中，除我们手工在调用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$compile</code> 之外，初始化时的根节点 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 是不会传递这个参数的。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在我们定义指令时，它的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 函数是这个样子的：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">function</span> compile(tElement, tAttrs, transclude) { ... }
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
事实上， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">transclude</code> 的值，就是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">directive</code> 所在的 <strong style="color: red; font-weight: normal;">原始</strong> 节点，把原始节点重新做了编译之后得到的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数（需要 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">directive</code> 定义时使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">transclude</code> 选项），后面会专门演示这个过程。所以，官方文档上也把 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">transclude</code> 函数描述成 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数的样子（如果自定义的指令只用在自己手动 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$compile</code> 的环境中，那这个函数的形式是可以随意的）：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">{<span style="color: #000000; font-weight: bold">function</span>(angular.Scope[, cloneAttachFn]}
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
所以记住，定义指令时， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 函数的第三个参数 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">transclude</code> ，就是一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> ，装入 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 执行它你就得到了一个节点。
</p>

<a class="anchor" name="toc74"></a>
<h2 style="font-size: 18px; margin: 30px auto;">18.6. transclude的细节</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">transclude</code> 有两方面的东西，一个是使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$compile</code> 时传入的函数，另一个是定义指令的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 函数时接受的一个参数。虽然这里的一出一进本来是相互对应的，但是实际使用中，因为大部分时候不会手动调用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$compile</code> ，所以，在“默认”情况下，指令接受的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">transclude</code> 又会是一个比较特殊的函数。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
看一个基本的例子：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;more&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(element, attrs, transclude){
    <span style="color: #000000; font-weight: bold">var</span> sum <span style="color: #000000; font-weight: bold">=</span> transclude(<span style="color: #009999">1</span>, <span style="color: #009999">2</span>);
    console.log(sum);
    console.log(element);  
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> func,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;E&#39;</span>};
});

app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope, $compile, $element){
  <span style="color: #000000; font-weight: bold">var</span> s <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;&lt;more&gt;123&lt;/more&gt;&#39;</span>;
  <span style="color: #000000; font-weight: bold">var</span> link <span style="color: #000000; font-weight: bold">=</span> $compile(s, <span style="color: #000000; font-weight: bold">function</span>(a, b){<span style="color: #000000; font-weight: bold">return</span> a <span style="color: #000000; font-weight: bold">+</span> b});
  <span style="color: #000000; font-weight: bold">var</span> node <span style="color: #000000; font-weight: bold">=</span> link($scope);
  $element.append(node);
});

angular.bootstrap(<span style="color: #0086B3">document</span>, [<span style="color: #dd1144">&#39;Demo&#39;</span>]);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
我们定义了一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">more</code> 指令，它的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 函数的第三个参数，就是我们手工 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$compile</code> 时传入的。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
如果不是手工 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$compile</code> ，而是 ng 初始化时找出的指令，则 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">transclude</code> 是一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数（指令定义需要设置 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">transclude</code> 选项）：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">more</span><span style="color: #000080">&gt;</span>123<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">app.directive(<span style="color: #dd1144">&#39;more&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($rootScope, $document){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(element, attrs, link){
    <span style="color: #000000; font-weight: bold">var</span> node <span style="color: #000000; font-weight: bold">=</span> link($rootScope);
    node.removeAttr(<span style="color: #dd1144">&#39;more&#39;</span>); <span style="color: #999988">//不去掉就变死循环了</span>
    $(<span style="color: #dd1144">&#39;body&#39;</span>, $document).append(node);
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> func,
          transclude<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;element&#39;</span>, <span style="color: #999988">// element是节点没,其它值是节点的内容没</span>
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;A&#39;</span>};
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc75"></a>
<h2 style="font-size: 18px; margin: 30px auto;">18.7. 把节点内容作为变量处理的类型</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
回顾最开始的那个代码显示的例子，那个例子只能处理一次节点内容。如果节点的内容是一个变量的话，需要用另外的思路来考虑。这里我们假设的例子是，定义一个指令 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">showLenght</code> ，它的作用是在一段文本的开头显示出这段节点文本的长度，节点文本是一个变量。指令使用的形式是：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;div</span> <span style="color: #008080">show-length</span><span style="color: #000080">&gt;</span>{{ text }}<span style="color: #000080">&lt;/div&gt;</span>
  <span style="color: #000080">&lt;button</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;text=&#39;xx&#39;&quot;</span><span style="color: #000080">&gt;</span>改变<span style="color: #000080">&lt;/button&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
从上面的 HTML 代码中，大概清楚 ng 解析它的过程（只看 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">show-length</code> 那一行）：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">解析 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">div</code> 时发现了一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">show-length</code> 的指令。
</li>
<li style="margin: 10px auto;">如果 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">show-length</code> 指令设置了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">transclude</code> 属性，则 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">div</code> 的节点内容被重新编译，得到的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数作为指令 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 函数的参数传入。
</li>
<li style="margin: 10px auto;">如果 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">show-length</code> 指令没有设置 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">transclude</code> 属性，则继续处理它的子节点（ <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">TextNode</code> ）。
</li>
<li style="margin: 10px auto;">不管是上面的哪种情况，都会继续处理到 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">{{ text }}</code> 这段文本。
</li>
<li style="margin: 10px auto;">发现 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">{{ text }}</code> 是一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">Interpolate</code> ，于是自动在此节点中添加了一个指令，这个指令的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数就是为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 添加了一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$watch</code> ，实现的功能是是当 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 作 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$digest</code> 的时候，就更新节点文本。
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
与处理 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">{{ text }}</code> 时添加的指令相同，我们实现 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">showLength</code> 的思路，也就是：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">修改原来的 DOM 结构
</li>
<li style="margin: 10px auto;">为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 添加 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$watch</code> ，当 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$digest</code> 时修改指定节点的文本，其值为指定节点文本的长度。
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
代码如下：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">app.directive(<span style="color: #dd1144">&#39;showLength&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($rootScope, $document){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(element, attrs, link){

    <span style="color: #000000; font-weight: bold">return</span> <span style="color: #000000; font-weight: bold">function</span>(scope, ielement, iattrs, controller){
      <span style="color: #000000; font-weight: bold">var</span> node <span style="color: #000000; font-weight: bold">=</span> link(scope);
      ielement.append(node);
      <span style="color: #000000; font-weight: bold">var</span> lnode <span style="color: #000000; font-weight: bold">=</span> $(<span style="color: #dd1144">&#39;&lt;span&gt;&lt;/span&gt;&#39;</span>);
      ielement.prepend(lnode);

      scope.$watch(<span style="color: #000000; font-weight: bold">function</span>(scope){
        lnode.text(node.text().length);
      });
    };
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> func,
          transclude<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">true</span>, <span style="color: #999988">// element是节点没,其它值是节点的内容没</span>
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;A&#39;</span>};
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
上面代码中，因为设置了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">transclude</code> 属性，我们在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">showLength</code> 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数（就是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">return</code> 的那个函数）中，使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">func</code> 的第三个函数来重塑了原来的文本节点，并放在我们需要的位置上。然后，我们添加自己的节点来显示长度值。最后给当前的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 添加 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$watch</code> ，以更新这个长度值。
</p>

<a class="anchor" name="toc76"></a>
<h2 style="font-size: 18px; margin: 30px auto;">18.8. 指令定义时的参数</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
指令定义时的参数如下：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">name
</li>
<li style="margin: 10px auto;">priority
</li>
<li style="margin: 10px auto;">terminal
</li>
<li style="margin: 10px auto;">scope
</li>
<li style="margin: 10px auto;">controller
</li>
<li style="margin: 10px auto;">require
</li>
<li style="margin: 10px auto;">restrict
</li>
<li style="margin: 10px auto;">template
</li>
<li style="margin: 10px auto;">templateUrl
</li>
<li style="margin: 10px auto;">replace
</li>
<li style="margin: 10px auto;">transclude
</li>
<li style="margin: 10px auto;">compile
</li>
<li style="margin: 10px auto;">link
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
现在我们开始一个一个地吃掉它们……，但是并不是按顺序讲的。
</p>

<dl style="">
<dt style=""><em style="color: #d75100; font-style: normal;">priority</em></dt><dd style="">
    这个值设置指令的权重，默认是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">0</code> 。当一个节点中有多个指令存在时，就按着权限从大到小的顺序依次执行它们的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 函数。相同权重顺序不定。
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">terminal</em></dt><dd style="">
    是否以当前指令的权重为结束界限。如果这值设置为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">true</code> ，则节点中权重小于当前指令的其它指令不会被执行。相同权重的会执行。
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">restrict</em></dt><dd style="">
    指令可以以哪些方式被使用，可以同时定义多种方式。
    <ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
    <li style="margin: 10px auto;">E 元素方式 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">&lt;my-directive&gt;&lt;/my-directive&gt;</code>
    </li>
    <li style="margin: 10px auto;">A 属性方式 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">&lt;div my-directive="exp"&gt; &lt;/div&gt;</code>
    </li>
    <li style="margin: 10px auto;">C 类方式 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">&lt;div class="my-directive: exp;"&gt;&lt;/div&gt;</code>
    </li>
    <li style="margin: 10px auto;">M 注释方式 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">&lt;!-- directive: my-directive exp --&gt;</code>
    </li>
    </ul>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">transclude</em></dt><dd style="">
    前面已经讲过基本的用法了。可以是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">'element'</code> 或 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">true</code> 两种值。
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">compile</em></dt><dd style="">
    基本的定义函数。 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">function compile(tElement, tAttrs, transclude) { ... }</code>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">link</em></dt><dd style="">
    前面介绍过了。大多数时候我们不需要单独定义它。只有 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 未定义时 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 才会被尝试。 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">function link(scope, iElement, iAttrs, controller) { ... }</code>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">scope</em></dt><dd style="">
    scope 的形式。 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">false</code> 节点的 scope ， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">true</code> 继承创建一个新的 scope ， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">{}</code> 不继承创建一个新的隔离 scope 。 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">{@attr: '引用节点属性', =attr: '把节点属性值引用成scope属性值', &amp;attr: '把节点属性值包装成函数'}</code>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">controller</em></dt><dd style="">
    为指令定义一个 controller ， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">function controller($scope, $element, $attrs, $transclude) { ... }</code>
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">name</em></dt><dd style="">
    指令的 controller 的名字，方便其它指令引用。
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">require</em></dt><dd style="">
    要引用的其它指令 conroller 的名字， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">?name</code> 忽略不存在的错误， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">^name</code> 在父级查找。
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">template</em></dt><dd style="">
    模板内容。
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">templateUrl</em></dt><dd style="">
    从指定地址获取模板内容。
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">replace</em></dt><dd style="">
    是否使用模板内容替换掉整个节点， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">true</code> 替换整个节点， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">false</code> 替换节点内容。
</dd>
</dl>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;a</span> <span style="color: #008080">b</span><span style="color: #000080">&gt;&lt;/a&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;a&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(element, attrs, link){
    console.log(<span style="color: #dd1144">&#39;a&#39;</span>);
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> func,
          priority<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">1</span>,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;EA&#39;</span>};
});

app.directive(<span style="color: #dd1144">&#39;b&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(element, attrs, link){
    console.log(<span style="color: #dd1144">&#39;b&#39;</span>);
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> func,
          priority<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">2</span>,
          <span style="color: #999988">//terminal: true,</span>
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;A&#39;</span>};
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
上面几个参数值都是比较简单且容易理想的。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
再看 <em style="color: #d75100; font-style: normal;">scope</em> 这个参数：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;div</span> <span style="color: #008080">a</span> <span style="color: #008080">b</span><span style="color: #000080">&gt;&lt;/div&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;a&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(element, attrs, link){
    <span style="color: #000000; font-weight: bold">return</span> <span style="color: #000000; font-weight: bold">function</span>(scope){
      console.log(scope);
    }
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> func,
          scope<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">true</span>,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;A&#39;</span>};
});

app.directive(<span style="color: #dd1144">&#39;b&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(element, attrs, link){
    <span style="color: #000000; font-weight: bold">return</span> <span style="color: #000000; font-weight: bold">function</span>(scope){
      console.log(scope);
    }
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> func,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;A&#39;</span>};
});

app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;123&#39;</span>;
  console.log($scope);
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
对于 <em style="color: #d75100; font-style: normal;">scope</em> ：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">默认为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">false</code> ， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数接受的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 为节点所在的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 。
</li>
<li style="margin: 10px auto;">为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">true</code> 时，则 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数中第一个参数（还有 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">controller</code> 参数中的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$scope</code> ）， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 是节点所在的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">child scope</code> ，并且如果节点中有多个指令，则只要其中一个指令是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">true</code> 的设置，其它所有指令都会受影响。
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这个参数还有其它取值。当其为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">{}</code> 时，则 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 接受一个完全隔离（isolate）的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> ，于 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">true</code> 的区别就是不会继承其它 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 的属性。但是这时，这个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 的属性却可以有很灵活的定义方式：
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">@attr</em> 引用节点的属性。
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;div</span> <span style="color: #008080">a</span> <span style="color: #008080">abc=</span><span style="color: #dd1144">&quot;here&quot;</span> <span style="color: #008080">xx=</span><span style="color: #dd1144">&quot;{{ a }}&quot;</span> <span style="color: #008080">c=</span><span style="color: #dd1144">&quot;ccc&quot;</span><span style="color: #000080">&gt;&lt;/div&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;a&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(element, attrs, link){
    <span style="color: #000000; font-weight: bold">return</span> <span style="color: #000000; font-weight: bold">function</span>(scope){
      console.log(scope);
    }
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> func,
          scope<span style="color: #000000; font-weight: bold">:</span> {a<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;@abc&#39;</span>, b<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;@xx&#39;</span>, c<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;@&#39;</span>},
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;A&#39;</span>};
});

app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;123&#39;</span>;
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">@abc</em> 引用 div 节点的 abc 属性。
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">@xx</em> 引用 div 节点的 xx 属性，而 xx 属性又是一个变量绑定，于是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 中 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">b</code> 属性值就和 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">TestCtrl</code> 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">a</code> 变量绑定在一起了。
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">@</em> 没有写 attr name ，则默认取自己的值，这里是取 div 的 c 属性。
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">=attr</em> 相似，只是它把节点的属性值当成节点 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 的属性名来使用，作用相当于上面例子中的 <em style="color: #d75100; font-style: normal;">@xx</em> ：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;div</span> <span style="color: #008080">a</span> <span style="color: #008080">abc=</span><span style="color: #dd1144">&quot;here&quot;</span><span style="color: #000080">&gt;&lt;/div&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;a&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(element, attrs, link){
    <span style="color: #000000; font-weight: bold">return</span> <span style="color: #000000; font-weight: bold">function</span>(scope){
      console.log(scope);
    }
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> func,
          scope<span style="color: #000000; font-weight: bold">:</span> {a<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;=abc&#39;</span>},
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;A&#39;</span>};
});

app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.here <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;123&#39;</span>;
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">&amp;attr</em> 是包装一个函数出来，这个函数以节点所在的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 为上下文。来看一个很爽的例子：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;div</span> <span style="color: #008080">a</span> <span style="color: #008080">abc=</span><span style="color: #dd1144">&quot;here = here + 1&quot;</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;show(here)&quot;</span><span style="color: #000080">&gt;</span>这里<span style="color: #000080">&lt;/div&gt;</span>
  <span style="color: #000080">&lt;div&gt;</span>{{ here }}<span style="color: #000080">&lt;/div&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;a&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(element, attrs, link){
    <span style="color: #000000; font-weight: bold">return</span> <span style="color: #000000; font-weight: bold">function</span> llink(scope){
      console.log(scope);
      scope.a();
      scope.b();

      scope.show <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(here){
        console.log(<span style="color: #dd1144">&#39;Inner, &#39;</span> <span style="color: #000000; font-weight: bold">+</span> here);
        scope.a({here<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">5</span>});
      }
    }
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> func,
          scope<span style="color: #000000; font-weight: bold">:</span> {a<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;&amp;abc&#39;</span>, b<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;&amp;ngClick&#39;</span>},
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;A&#39;</span>};
});

app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.here <span style="color: #000000; font-weight: bold">=</span> <span style="color: #009999">123</span>;
  console.log($scope);

  $scope.show <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(here){
    console.log(here);
  }
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
scope.a 是 <em style="color: #d75100; font-style: normal;">&amp;abc</em> ，即：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">scope.a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){here <span style="color: #000000; font-weight: bold">=</span> here <span style="color: #000000; font-weight: bold">+</span> <span style="color: #009999">1</span>}
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
只是其中的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">here</code> 是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">TestCtrl</code> 的。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
scope.b 是 <em style="color: #d75100; font-style: normal;">&amp;ngClick</em> ，即：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">scope.b <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){show(here)}
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这里的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">show()</code> 和 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">here</code> 都是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">TestCtrl</code> 的，于是上面的代码最开始会在终端输出一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">124</code> 。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
当点击“这里”时，这时执行的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">show(here)</code> 就是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">llink</code> 中定义的那个函数了，与 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">TestCtrl</code> 无关。但是，其间的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope.a({here:5})</code> ，因为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">a</code> 执行时是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">TestCtrl</code> 的上下文，于是向 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">a</code> 传递的一个对象，里面的所有属性 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">TestCtrl</code> 就全收下了，接着执行 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">here=here+1</code> ，于是我们会在屏幕上看到 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">6</code> 。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这里是一个上下文交错的环境，通过 <em style="color: #d75100; font-style: normal;">&amp;</em> 这种机制，让指令的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 与节点的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 发生了互动。真是鬼斧神工的设计。而实现它，只用了几行代码：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">case</span> <span style="color: #dd1144">&#39;&amp;&#39;</span><span style="color: #000000; font-weight: bold">:</span> {
  parentGet <span style="color: #000000; font-weight: bold">=</span> $parse(attrs[attrName]);
  scope[scopeName] <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(locals) {
    <span style="color: #000000; font-weight: bold">return</span> parentGet(parentScope, locals);
  }
  <span style="color: #000000; font-weight: bold">break</span>;
}
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
再看 <em style="color: #d75100; font-style: normal;">controller</em> 这个参数。这个参数的作用是提供一个 controller 的构造函数，它会在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 函数之后， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数之前被执行。
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;a&gt;</span>haha<span style="color: #000080">&lt;/a&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;a&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){
    console.log(<span style="color: #dd1144">&#39;compile&#39;</span>);
    <span style="color: #000000; font-weight: bold">return</span> <span style="color: #000000; font-weight: bold">function</span>(){
      console.log(<span style="color: #dd1144">&#39;link&#39;</span>);
    }
  }

  <span style="color: #000000; font-weight: bold">var</span> controller <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($scope, $element, $attrs, $transclude){
    console.log(<span style="color: #dd1144">&#39;controller&#39;</span>);
    console.log($scope);

    <span style="color: #000000; font-weight: bold">var</span> node <span style="color: #000000; font-weight: bold">=</span> $transclude(<span style="color: #000000; font-weight: bold">function</span>(clone_element, scope){
      console.log(clone_element);
      console.log(<span style="color: #dd1144">&#39;--&#39;</span>);
      console.log(scope);
    });
    console.log(node);
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> func,
          controller<span style="color: #000000; font-weight: bold">:</span> controller,
          transclude<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">true</span>,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;E&#39;</span>}
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">controller</code> 的最后一个参数， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$transclude</code> ，是一个只接受 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">cloneAttachFn</code> 作为参数的一个函数。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
按官方的说法，这个机制的设计目的是为了让各个指令之间可以互相通信。参考普通节点的处理方式，这里也是处理指令 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 的合适位置。
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;a</span> <span style="color: #008080">b</span><span style="color: #000080">&gt;</span>kk<span style="color: #000080">&lt;/a&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;a&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){
  }

  <span style="color: #000000; font-weight: bold">var</span> controller <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($scope, $element, $attrs, $transclude){
    console.log(<span style="color: #dd1144">&#39;a&#39;</span>);
    <span style="color: #000000; font-weight: bold">this</span>.a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;xx&#39;</span>;
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> func,
          name<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;not_a&#39;</span>,
          controller<span style="color: #000000; font-weight: bold">:</span> controller,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;E&#39;</span>}
});

app.directive(<span style="color: #dd1144">&#39;b&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){
    <span style="color: #000000; font-weight: bold">return</span> <span style="color: #000000; font-weight: bold">function</span>($scope, $element, $attrs, $controller){
      console.log($controller);
    }
  }

  <span style="color: #000000; font-weight: bold">var</span> controller <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($scope, $element, $attrs, $transclude){
    console.log(<span style="color: #dd1144">&#39;b&#39;</span>);
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> func,
          controller<span style="color: #000000; font-weight: bold">:</span> controller,
          require<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;not_a&#39;</span>,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;EA&#39;</span>}
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">name</em> 参数在这里可以用以为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">controller</code> 重起一个名字，以方便在 <em style="color: #d75100; font-style: normal;">require</em> 参数中引用。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">require</em> 参数可以带两种前缀（可以同时使用）：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">?</em> ，如果指定的 controller 不存在，则忽略错误。即：
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">require<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;?not_b&#39;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
如果名为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">not_b</code> 的 controller 不存在时，不会直接抛出错误， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数中对应的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$controller</code> 为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">undefined</code> 。
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">^</em> ，同时在父级节点中寻找指定的 controller ，把上面的例子小改一下：
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;a&gt;&lt;b&gt;</span>kk<span style="color: #000080">&lt;/b&gt;&lt;/a&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>
把 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">a</code> 的 <em style="color: #d75100; font-style: normal;">require</em> 改成（否则就找不到 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">not_a</code> 这个 controller ）：
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;"></p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">require<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;?^not_a&#39;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
还剩下几个模板参数：
</p>

<dl style="">
<dt style=""><em style="color: #d75100; font-style: normal;">template</em> 模板内容，这个内容会根据 <em style="color: #d75100; font-style: normal;">replace</em> 参数的设置替换节点或只替换节点内容。</dt><dd style="">
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">templateUrl</em> 模板内容，获取方式是异步请求。</dt><dd style="">
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">replace</em> 设置如何处理模板内容。为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">true</code> 时为替换掉指令节点，否则只替换到节点内容。</dt><dd style="">
</dd>
</dl>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;h1</span> <span style="color: #008080">a</span><span style="color: #000080">&gt;</span>原始内容<span style="color: #000080">&lt;/h1&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;a&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> func,
          template<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;&lt;p&gt;标题 {{ name }} &lt;button ng-click=&quot;name=\&#39;</span>hahaha<span style="color: #a61717; background-color: #e3d2d2">\</span><span style="color: #dd1144">&#39;&quot;&gt;修改&lt;/button&gt;&lt;/p&gt;&#39;</span>,
          <span style="color: #999988">//replace: true,</span>
          <span style="color: #999988">//controller: function($scope){$scope.name = &#39;xxx&#39;},</span>
          <span style="color: #999988">//scope: {},</span>
          scope<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">true</span> ,
          controller<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">function</span>($scope){console.log($scope)},
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;A&#39;</span>}
});

app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.name <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;123&#39;</span>;
  console.log($scope);
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">template</em> 中可以包括变量引用的表达式，其 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 遵寻 <em style="color: #d75100; font-style: normal;">scope</em> 参数的作用（可能受继承关系影响）。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">templateUrl</em> 是异步请求模板内容，并且是获取到内容之后才开始执行指令的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 函数。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
最后说一个 <em style="color: #d75100; font-style: normal;">compile</em> 这个参数。它除了可以返回一个函数用为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数之外，还可以返回一个对象，这个对象能包括两个成员，一个 <em style="color: #d75100; font-style: normal;">pre</em> ，一个 <em style="color: #d75100; font-style: normal;">post</em> 。实际上， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数是由两部分组成，所谓的 <em style="color: #d75100; font-style: normal;">preLink</em> 和 <em style="color: #d75100; font-style: normal;">postLink</em> 。区别在于执行顺序，特别是在指令层级嵌套的结构之下， <em style="color: #d75100; font-style: normal;">postLink</em> 是在所有的子级指令 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 完成之后才最后执行的。 <em style="color: #d75100; font-style: normal;">compile</em> 如果只返回一个函数，则这个函数被作为 <em style="color: #d75100; font-style: normal;">postLink</em> 使用：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;a&gt;&lt;b&gt;&lt;/b&gt;&lt;/a&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;a&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){
    console.log(<span style="color: #dd1144">&#39;a compile&#39;</span>);
    <span style="color: #000000; font-weight: bold">return</span> {
      pre<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">function</span>(){console.log(<span style="color: #dd1144">&#39;a link pre&#39;</span>)},
      post<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">function</span>(){console.log(<span style="color: #dd1144">&#39;a link post&#39;</span>)},
    }
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> func,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;E&#39;</span>}
});

app.directive(<span style="color: #dd1144">&#39;b&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){
    console.log(<span style="color: #dd1144">&#39;b compile&#39;</span>);
    <span style="color: #000000; font-weight: bold">return</span> {
      pre<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">function</span>(){console.log(<span style="color: #dd1144">&#39;b link pre&#39;</span>)},
      post<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">function</span>(){console.log(<span style="color: #dd1144">&#39;b link post&#39;</span>)},
    }
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> func,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;E&#39;</span>}
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc77"></a>
<h2 style="font-size: 18px; margin: 30px auto;">18.9. Attributes的细节</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
节点属性被包装之后会传给 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 和 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数。从这个操作中，我们可以得到节点的引用，可以操作节点属性，也可以为节点属性注册侦听事件。
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;test</span> <span style="color: #008080">a=</span><span style="color: #dd1144">&quot;1&quot;</span> <span style="color: #008080">b</span> <span style="color: #008080">c=</span><span style="color: #dd1144">&quot;xxx&quot;</span><span style="color: #000080">&gt;&lt;/test&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;test&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($element, $attrs){
    console.log($attrs);
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> func,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;E&#39;</span>}
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
整个 <em style="color: #d75100; font-style: normal;">Attributes</em> 对象是比较简单的，它的成员包括了：
</p>

<dl style="">
<dt style=""><em style="color: #d75100; font-style: normal;">$$element</em> 属性所在的节点。</dt><dd style="">
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">$attr</em> 所有的属性值（类型是对象）。</dt><dd style="">
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">$normalize</em> 一个名字标准化的工具函数，可以把 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">ng-click</code> 变成 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">ngClick</code> 。</dt><dd style="">
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">$observe</em> 为属性注册侦听器的函数。</dt><dd style="">
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">$set</em> 设置对象属性，及节点属性的工具。</dt><dd style="">
</dd>
</dl>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
除了上面这些成员，对象的成员还包括所有属性的名字。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
先看 <em style="color: #d75100; font-style: normal;">$observe</em> 的使用，基本上相当于 <em style="color: #d75100; font-style: normal;">$scope</em> 中的 <em style="color: #d75100; font-style: normal;">$watch</em> ：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;test</span> <span style="color: #008080">a=</span><span style="color: #dd1144">&quot;{{ a }}&quot;</span> <span style="color: #008080">b</span> <span style="color: #008080">c=</span><span style="color: #dd1144">&quot;xxx&quot;</span><span style="color: #000080">&gt;&lt;/test&gt;</span>
  <span style="color: #000080">&lt;button</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;a=a+1&quot;</span><span style="color: #000080">&gt;</span>修改<span style="color: #000080">&lt;/button&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;test&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($element, $attrs){
    console.log($attrs);

    $attrs.$observe(<span style="color: #dd1144">&#39;a&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(new_v){
      console.log(new_v);
    });
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> func,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;E&#39;</span>}
});

app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #009999">123</span>;
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">$set</em> 方法的定义是： <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">function(key, value, writeAttr, attrName) { ... }</code> 。
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">key</em> 对象的成员名。
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">value</em> 需要设置的值。
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">writeAttr</em> 是否同时修改 DOM 节点的属性（注意区别“节点”与“对象”），默认为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">true</code> 。
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">attrName</em> 实际的属性名，与“标准化”之后的属性名有区别。
</li>
</ul>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;test</span> <span style="color: #008080">a=</span><span style="color: #dd1144">&quot;1&quot;</span> <span style="color: #008080">ys-a=</span><span style="color: #dd1144">&quot;123&quot;</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;show(1)&quot;</span><span style="color: #000080">&gt;</span>这里<span style="color: #000080">&lt;/test&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;test&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> func <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($element, $attrs){
    $attrs.$set(<span style="color: #dd1144">&#39;b&#39;</span>, <span style="color: #dd1144">&#39;ooo&#39;</span>);
    $attrs.$set(<span style="color: #dd1144">&#39;a-b&#39;</span>, <span style="color: #dd1144">&#39;11&#39;</span>);
    $attrs.$set(<span style="color: #dd1144">&#39;c-d&#39;</span>, <span style="color: #dd1144">&#39;11&#39;</span>, <span style="color: #000000; font-weight: bold">true</span>, <span style="color: #dd1144">&#39;c_d&#39;</span>);
    console.log($attrs);
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> func,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;E&#39;</span>}
});

app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.show <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(v){console.log(v);}
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
从例子中可以看到，原始的节点属性值对，放到对象中之后，名字一定是“标准化”之后的。但是手动 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$set</code> 的新属性，不会自动做标准化处理。
</p>

<a class="anchor" name="toc78"></a>
<h2 style="font-size: 18px; margin: 30px auto;">18.10. 预定义的 NgModelController</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在前面讲 conroller 参数的时候，提到过可以为指令定义一个 conroller 。官方的实现中，有很多已定义的指令，这些指令当中，有两个已定义的 conroller ，它们是 <em style="color: #d75100; font-style: normal;">NgModelController</em> 和 <em style="color: #d75100; font-style: normal;">FormController</em> ，对应 <em style="color: #d75100; font-style: normal;">ng-model</em> 和 <em style="color: #d75100; font-style: normal;">form</em> 这两个指令（可以参照前面的“表单控件”一章）。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
在使用中，除了可以通过 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$scope</code> 来取得它们的引用之外，也可以在自定义指令中通过 <em style="color: #d75100; font-style: normal;">require</em> 参数直接引用，这样就可以在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数中使用 controller 去实现一些功能。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
先看 <em style="color: #d75100; font-style: normal;">NgModelController</em> 。这东西的作用有两个，一是控制 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">ViewValue</code> 与 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">ModelValue</code> 之间的转换关系（你可以实现看到的是一个值，但是存到变量里变成了另外一个值），二是与 <em style="color: #d75100; font-style: normal;">FormController</em> 配合做数据校验的相关逻辑。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
先看两个应该是最有用的属性：
</p>

<dl style="">
<dt style=""><em style="color: #d75100; font-style: normal;">$formatters</em> 是一个由函数组成的列表，串行执行，作用是把变量值变成显示的值。</dt><dd style="">
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">$parsers</em> 与上面的方向相反，把显示的值变成变量值。</dt><dd style="">
</dd>
</dl>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
假设我们在变量中要保存一个列表的类型，但是显示的东西只能是字符串，所以这两者之间需要一个转换：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;input</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;text&quot;</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">test</span> <span style="color: #000080">/&gt;</span>
  <span style="color: #000080">&lt;button</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;show(a)&quot;</span><span style="color: #000080">&gt;</span>查看<span style="color: #000080">&lt;/button&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;test&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> link <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($scope, $element, $attrs, $ctrl){

    $ctrl.$formatters.push(<span style="color: #000000; font-weight: bold">function</span>(value){
      <span style="color: #000000; font-weight: bold">return</span> value.join(<span style="color: #dd1144">&#39;,&#39;</span>);
    });

    $ctrl.$parsers.push(<span style="color: #000000; font-weight: bold">function</span>(value){
      <span style="color: #000000; font-weight: bold">return</span> value.split(<span style="color: #dd1144">&#39;,&#39;</span>);
    });
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">function</span>(){<span style="color: #000000; font-weight: bold">return</span> link},
          require<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;ngModel&#39;</span>,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;A&#39;</span>}
});

app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.a <span style="color: #000000; font-weight: bold">=</span> [];
  <span style="color: #999988">//$scope.a = [1,2,3];</span>
  $scope.show <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(v){
    console.log(v);
  }
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
上面在定义 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">test</code> 这个指令， <em style="color: #d75100; font-style: normal;">require</em> 参数指定了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">ngModel</code> 。同时因为 DOM 结构， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">ng-model</code> 是存在的。于是， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 函数中就可以获取到一个 <em style="color: #d75100; font-style: normal;">NgModelController</em> 的实例，即代码中的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$ctrl</code> 。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
我们添加了需要的过滤函数：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">从变量( <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">ModelValue</code> )到显示值( <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">ViewValue</code> )的过程， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$formatters</code> 属性，把一个列表变成一个字符串。
</li>
<li style="margin: 10px auto;">从显示值到变量的过程， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$parsers</code> 属性，把一个字符串变成一个列表。
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
对于显示值和变量，还有其它的 API ，这里就不细说了。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
另一部分，是关于数据校验的，放到下一章同 <em style="color: #d75100; font-style: normal;">FormController</em> 一起讨论。
</p>

<a class="anchor" name="toc79"></a>
<h2 style="font-size: 18px; margin: 30px auto;">18.11. 预定义的 FormController</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
前面的“表单控制”那章，实际上讲的就是 <em style="color: #d75100; font-style: normal;">FormController</em> ，只是那里是从 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 中获取到的引用。现在从指令定义的角度，来更清楚地了解 <em style="color: #d75100; font-style: normal;">FormController</em> 及 <em style="color: #d75100; font-style: normal;">NgModelController</em> 是如何配合工作的。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
先说一下， <em style="color: #d75100; font-style: normal;">form</em> 和 <em style="color: #d75100; font-style: normal;">ngForm</em> 是官方定义的两个指令，但是它们其实是同一个东西。前者只允许以标签形式使用，而后者允许 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">EAC</code> 的形式。DOM 结构中， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">form</code> 标签不能嵌套，但是 ng 的指令没有这个限制。不管是 <em style="color: #d75100; font-style: normal;">form</em> 还是 <em style="color: #d75100; font-style: normal;">ngForm</em> ，它们的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">controller</code> 都被命名成了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">form</code> 。 所以 <em style="color: #d75100; font-style: normal;">require</em> 这个参数不要写错了。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">FormController</em> 的几个成员是很好理解的：
</p>

<dl style="">
<dt style=""><em style="color: #d75100; font-style: normal;">$pristine</em> 表单是否被动过</dt><dd style="">
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">$dirty</em> 表单是否没被动过</dt><dd style="">
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">$valid</em> 表单是否检验通过</dt><dd style="">
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">$invalid</em> 表单是否检验未通过</dt><dd style="">
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">$error</em> 表单中的错误</dt><dd style="">
</dd>
<dt style=""><em style="color: #d75100; font-style: normal;">$setDirty()</em> 直接设置 <em style="color: #d75100; font-style: normal;">$dirty</em> 及 <em style="color: #d75100; font-style: normal;">$pristine</em> </dt><dd style="">
</dd>
</dl>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-form</span> <span style="color: #008080">test</span><span style="color: #000080">&gt;</span>
    <span style="color: #000080">&lt;input</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;email&quot;</span> <span style="color: #000080">/&gt;</span>
    <span style="color: #000080">&lt;button</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;do()&quot;</span><span style="color: #000080">&gt;</span>查看<span style="color: #000080">&lt;/button&gt;</span>
  <span style="color: #000080">&lt;/div&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;test&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> link <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($scope, $element, $attrs, $ctrl){
    $scope.<span style="color: #000000; font-weight: bold">do</span> <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){
      <span style="color: #999988">//$ctrl.$setDirty();</span>
      console.log($ctrl.$pristine); <span style="color: #999988">//form是否没被动过</span>
      console.log($ctrl.$dirty); <span style="color: #999988">//form是否被动过</span>
      console.log($ctrl.$valid); <span style="color: #999988">//form是否被检验通过</span>
      console.log($ctrl.$invalid); <span style="color: #999988">//form是否有错误</span>
      console.log($ctrl.$error); <span style="color: #999988">//form中有错误的字段</span>
    }
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">function</span>(){<span style="color: #000000; font-weight: bold">return</span> link},
          require<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;form&#39;</span>,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;A&#39;</span>}
});

app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">$error</em> 这个属性，是一个对象， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">key</code> 是错误名， <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">value</code> 部分是一个列表，其成员是对应的 <em style="color: #d75100; font-style: normal;">NgModelController</em> 的实例。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
<em style="color: #d75100; font-style: normal;">FormController</em> 可以自由增减它包含的那些，类似于 <em style="color: #d75100; font-style: normal;">NgModelController</em> 的实例。在 DOM 结构上，有 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">ng-model</code> 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">input</code> 节点的 <em style="color: #d75100; font-style: normal;">NgMoelController</em> 会被自动添加。
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">$addControl()</em> 添加一个 conroller 
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">$removeControl()</em> 删除一个 controller
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这两个手动使用机会应该不会很多。被添加的实例也可以手动实现所有的 <em style="color: #d75100; font-style: normal;">NgModelController</em> 的方法
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;bb</span> <span style="color: #000080">/&gt;</span>
  <span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-form</span> <span style="color: #008080">test</span><span style="color: #000080">&gt;</span>
    <span style="color: #000080">&lt;input</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;email&quot;</span> <span style="color: #000080">/&gt;</span>
    <span style="color: #000080">&lt;button</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;add()&quot;</span><span style="color: #000080">&gt;</span>添加<span style="color: #000080">&lt;/button&gt;</span>
  <span style="color: #000080">&lt;/div&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;test&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> link <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($scope, $element, $attrs, $ctrl){
    $scope.add <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>(){
      $ctrl.$addControl($scope.bb);
      console.log($ctrl);
    }
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">function</span>(){<span style="color: #000000; font-weight: bold">return</span> link},
          require<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;form&#39;</span>,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;A&#39;</span>}
});

app.directive(<span style="color: #dd1144">&#39;bb&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">var</span> controller <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($scope, $element, $attrs, $transclude){
    $scope.bb <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">this</span>;
    <span style="color: #000000; font-weight: bold">this</span>.$name <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;bb&#39;</span>;
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> angular.noop,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;E&#39;</span>,
          controller<span style="color: #000000; font-weight: bold">:</span> controller}
});

app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
整合 <em style="color: #d75100; font-style: normal;">FormController</em> 和 <em style="color: #d75100; font-style: normal;">NgModelController</em> 就很容易扩展各种类型的字段:
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;form</span> <span style="color: #008080">name=</span><span style="color: #dd1144">&quot;f&quot;</span><span style="color: #000080">&gt;</span>
    <span style="color: #000080">&lt;input</span> <span style="color: #008080">type=</span><span style="color: #dd1144">&quot;my&quot;</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #000080">/&gt;</span>
    <span style="color: #000080">&lt;button</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;show()&quot;</span><span style="color: #000080">&gt;</span>查看<span style="color: #000080">&lt;/button&gt;</span>
  <span style="color: #000080">&lt;/form&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>


<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;">var app = angular.module(&#39;Demo&#39;, [], angular.noop);

app.directive(&#39;input&#39;, function(){
  var link = function($scope, $element, $attrs, $ctrl){
    console.log($attrs.type);
    var validator = function(v){
      if(v == &#39;123&#39;){
        $ctrl.$setValidity(&#39;my&#39;, true);
        return v;
      } else {
        $ctrl.$setValidity(&#39;my&#39;, false);
        return undefined;
      }
    }

    $ctrl.$formatters.push(validator);
    $ctrl.$parsers.push(validator);
  }

  return {compile: function(){return link},
          require: &#39;ngModel&#39;,
          restrict: &#39;E&#39;}
});

app.controller(&#39;TestCtrl&#39;, function($scope){
    $scope.show = function(){
      console.log($scope.f);
    }
});
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
虽然官方原来定义了几种 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">type</code> ，但这不妨碍我们继续扩展新的类型。如果新的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">type</code> 参数值不在官方的定义列表里，那会按 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">text</code> 类型先做处理，这其实什么影响都没有。剩下的，就是写我们自己的验证逻辑就行了。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
上面的代码是参见官方的做法，使用格式化的过程，同时在里面做有效性检查。
</p>

<a class="anchor" name="toc80"></a>
<h2 style="font-size: 18px; margin: 30px auto;">18.12. 示例：文本框</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这个例子与官网上的那个例子相似。最终是要显示一个文本框，这个文本框由标题和内容两部分组成。而且标题和内容则是引用 controller 中的变量值。
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
HTML 部分的代码：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;ys-block</span> <span style="color: #008080">title=</span><span style="color: #dd1144">&quot;title&quot;</span> <span style="color: #008080">text=</span><span style="color: #dd1144">&quot;text&quot;</span><span style="color: #000080">&gt;&lt;/ys-block&gt;</span>
  <span style="color: #000080">&lt;p&gt;</span>标题: <span style="color: #000080">&lt;input</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;title&quot;</span> <span style="color: #000080">/&gt;&lt;/p&gt;</span>
  <span style="color: #000080">&lt;p&gt;</span>内容: <span style="color: #000080">&lt;input</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;text&quot;</span> <span style="color: #000080">/&gt;&lt;/p&gt;</span>
  <span style="color: #000080">&lt;ys-block</span> <span style="color: #008080">title=</span><span style="color: #dd1144">&quot;title&quot;</span> <span style="color: #008080">text=</span><span style="color: #dd1144">&quot;text&quot;</span><span style="color: #000080">&gt;&lt;/ys-block&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
从这个期望实现效果的 HTML 代码中，我们可以考虑设计指令的实现方式：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">这个指令的使用方式是“标签”， 即 <em style="color: #d75100; font-style: normal;">restrict</em> 这个参数应该设置为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">E</code> 。
</li>
<li style="margin: 10px auto;">节点的属性值是对 controller 变量的引用，那么我们应该在指令的 <em style="color: #d75100; font-style: normal;">scope</em> 中使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">=</code> 的方式来指定成员值。
</li>
<li style="margin: 10px auto;">最终的效果显示需要进行 DOM 结构的重构，那直接使用 <em style="color: #d75100; font-style: normal;">template</em> 就好了。
</li>
<li style="margin: 10px auto;">自定义的标签在最终效果中是多余的，所有 <em style="color: #d75100; font-style: normal;">replace</em> 应该设置为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">true</code> 。
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
JS 部分的代码：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;ysBlock&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>(){
  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> angular.noop,
          template<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;&lt;div style=&quot;width: 200px; border: 1px solid black;&quot;&gt;&#39;</span> <span style="color: #000000; font-weight: bold">+</span> 
                     <span style="color: #dd1144">&#39;&lt;h1 style=&quot;background-color: gray; color: white; font-size: 22px;&quot;&gt;&#39;</span> <span style="color: #000000; font-weight: bold">+</span> 
                     <span style="color: #dd1144">&#39;{{ title }}&#39;</span> <span style="color: #000000; font-weight: bold">+</span> <span style="color: #dd1144">&#39;&lt;/h1&gt;&lt;div&gt;{{ text }}&lt;/div&gt;&lt;/div&gt;&#39;</span>,
          replace<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">true</span>,
          scope<span style="color: #000000; font-weight: bold">:</span> {title<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;=title&#39;</span>, text<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;=text&#39;</span>},
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;E&#39;</span>};
});

app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.title <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;标题在这里&#39;</span>;
  $scope.text <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#39;内容在这里&#39;</span>;
});

angular.bootstrap(<span style="color: #0086B3">document</span>, [<span style="color: #dd1144">&#39;Demo&#39;</span>]);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
可以看到，这种简单的组件式指令，只需要作 DOM 结构的变换即可实现，连 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">compile</code> 函数都不需要写。
</p>

<a class="anchor" name="toc81"></a>
<h2 style="font-size: 18px; margin: 30px auto;">18.13. 示例：模板控制语句 for</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这个示例尝试实现一个重复语句，功能同官方的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">ngRepeat</code> ，但是使用方式类似于我们通常编程语言中的 <em style="color: #d75100; font-style: normal;">for</em> 语句：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span> <span style="color: #008080">ng-init=</span><span style="color: #dd1144">&quot;obj_list=[1,2,3,4]; name=&#39;name&#39;&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;ul&gt;</span>
    <span style="color: #000080">&lt;for</span> <span style="color: #008080">o</span> <span style="color: #008080">in</span> <span style="color: #008080">obj_list</span><span style="color: #000080">&gt;</span>
      <span style="color: #000080">&lt;li&gt;</span>{{ o }}, {{ name }}<span style="color: #000080">&lt;/li&gt;</span>
    <span style="color: #000080">&lt;/for&gt;</span>
  <span style="color: #000080">&lt;/ul&gt;</span>
  <span style="color: #000080">&lt;button</span> <span style="color: #008080">ng-click=</span><span style="color: #dd1144">&quot;obj_list=[1,2]; name=&#39;o?&#39;&quot;</span><span style="color: #000080">&gt;</span>修改<span style="color: #000080">&lt;/button&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
同样，我们从上面的使用方式去考虑这个指令的实现：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;">这是一个完全的控制指令，所以单个节点应该只有它一个指令起作用就好了，于是权重要比较高，并且“到此为止”—— <em style="color: #d75100; font-style: normal;">priority</em> 设置为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">1000</code> ， <em style="color: #d75100; font-style: normal;">terminal</em> 设置为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">true</code> 。
</li>
<li style="margin: 10px auto;">使用时的语法问题。事实上浏览器会把 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">for</code> 节点补充成一个正确的 HTML 结构，即里面的属性都会变成类似 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">o=""</code> 这样。我们通过节点的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">outerHTML</code> 属性取到字符串并解析取得需要的信息。
</li>
<li style="margin: 10px auto;">我们把 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">for</code> 节点之间的内容作为一个模板，并且通过循环多次渲染该模板之后把结果填充到合适的位置。
</li>
<li style="margin: 10px auto;">在处理上面的那个模板时，需要不断地创建新 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 的，并且 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">o</code> 这个成员需要单独赋值。
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
注意：这里只是简单实现功能。官方的那个 <em style="color: #d75100; font-style: normal;">ngRepeat</em> 比较复杂，是做了专门的算法优化的。当然，这里的实现也可以是简单把 DOM 结构变成使用 <em style="color: #d75100; font-style: normal;">ngRepeat</em> 的形式 :)
</p>
<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
JS 部分代码：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;for&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($compile){
  <span style="color: #000000; font-weight: bold">var</span> compile <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($element, $attrs, $link){
    <span style="color: #000000; font-weight: bold">var</span> match <span style="color: #000000; font-weight: bold">=</span> $element[<span style="color: #009999">0</span>].outerHTML.match(<span style="color: #dd1144">&#39;&lt;for (.*?)=.*? in=.*? (.*?)=.*?&gt;&#39;</span>);
    <span style="color: #000000; font-weight: bold">if</span>(<span style="color: #000000; font-weight: bold">!</span>match <span style="color: #000000; font-weight: bold">||</span> match.length <span style="color: #000000; font-weight: bold">!=</span> <span style="color: #009999">3</span>){<span style="color: #000000; font-weight: bold">throw</span> <span style="color: #0086B3">Error</span>(<span style="color: #dd1144">&#39;syntax: &lt;for o in obj_list&gt;&#39;</span>)}
    <span style="color: #000000; font-weight: bold">var</span> iter <span style="color: #000000; font-weight: bold">=</span> match[<span style="color: #009999">1</span>];
    <span style="color: #000000; font-weight: bold">var</span> list <span style="color: #000000; font-weight: bold">=</span> match[<span style="color: #009999">2</span>];
    <span style="color: #000000; font-weight: bold">var</span> tpl <span style="color: #000000; font-weight: bold">=</span> $compile($.trim($element.html()));
    $element.empty();

    <span style="color: #000000; font-weight: bold">var</span> link <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($scope, $ielement, $iattrs, $controller){

      <span style="color: #000000; font-weight: bold">var</span> new_node <span style="color: #000000; font-weight: bold">=</span> [];

      $scope.$watch(list, <span style="color: #000000; font-weight: bold">function</span>(list){
        angular.forEach(new_node, <span style="color: #000000; font-weight: bold">function</span>(n){n.remove()});
        <span style="color: #000000; font-weight: bold">var</span> scp, inode;
        <span style="color: #000000; font-weight: bold">for</span>(<span style="color: #000000; font-weight: bold">var</span> i <span style="color: #000000; font-weight: bold">=</span> <span style="color: #009999">0</span>, ii <span style="color: #000000; font-weight: bold">=</span> list.length; i <span style="color: #000000; font-weight: bold">&lt;</span> ii; i<span style="color: #000000; font-weight: bold">++</span>){
          scp <span style="color: #000000; font-weight: bold">=</span> $scope.$new();
          scp[iter] <span style="color: #000000; font-weight: bold">=</span> list[i];
          inode <span style="color: #000000; font-weight: bold">=</span> tpl(scp, angular.noop);
          $ielement.before(inode);
          new_node.push(inode);
        }

      });
    }

    <span style="color: #000000; font-weight: bold">return</span> link;
  }
  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> compile,
          priority<span style="color: #000000; font-weight: bold">:</span> <span style="color: #009999">1000</span>,
          terminal<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">true</span>,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;E&#39;</span>};
});

app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, angular.noop);
angular.bootstrap(<span style="color: #0086B3">document</span>, [<span style="color: #dd1144">&#39;Demo&#39;</span>]);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<a class="anchor" name="toc82"></a>
<h2 style="font-size: 18px; margin: 30px auto;">18.14. 示例：模板控制语句 if/else</h2>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
这个示例是尝试实现：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000080">&lt;div</span> <span style="color: #008080">ng-controller=</span><span style="color: #dd1144">&quot;TestCtrl&quot;</span><span style="color: #000080">&gt;</span>
  <span style="color: #000080">&lt;if</span> <span style="color: #008080">true=</span><span style="color: #dd1144">&quot;a == 1&quot;</span><span style="color: #000080">&gt;</span>
      <span style="color: #000080">&lt;p&gt;</span>判断为真, {{ name }}<span style="color: #000080">&lt;/p&gt;</span>
    <span style="color: #000080">&lt;else&gt;</span>
      <span style="color: #000080">&lt;p&gt;</span>判断为假, {{ name }}<span style="color: #000080">&lt;/p&gt;</span>
    <span style="color: #000080">&lt;/else&gt;</span>
  <span style="color: #000080">&lt;/if&gt;</span>

  <span style="color: #000080">&lt;div&gt;</span>
    <span style="color: #000080">&lt;p&gt;</span>a: <span style="color: #000080">&lt;input</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;a&quot;</span> <span style="color: #000080">/&gt;&lt;/p&gt;</span>
    <span style="color: #000080">&lt;p&gt;</span>name: <span style="color: #000080">&lt;input</span> <span style="color: #008080">ng-model=</span><span style="color: #dd1144">&quot;name&quot;</span> <span style="color: #000080">/&gt;&lt;/p&gt;</span>
  <span style="color: #000080">&lt;/div&gt;</span>
<span style="color: #000080">&lt;/div&gt;</span>
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
考虑实现的思路：
</p>

<ul style="line-height: 1.6em; list-style: inside square; padding: 0px; padding-left: 50px; margin: auto;">
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">else</em> 与 <em style="color: #d75100; font-style: normal;">if</em> 是两个指令，它们是父子关系。通过 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 可以联系起来。至于 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">scope</code> 是在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">link</code> 中处理还是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">controller</code> 中处理并不重要。
</li>
<li style="margin: 10px auto;"><em style="color: #d75100; font-style: normal;">true</em> 属性的条件判断通过 <em style="color: #d75100; font-style: normal;">$parse</em> 服务很容易实现。
</li>
<li style="margin: 10px auto;">如果最终效果要去掉 <em style="color: #d75100; font-style: normal;">if</em> 节点，我们可以使用注释节点来“占位”。
</li>
</ul>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
JS 代码：
</p>

<div class="code" style="margin: 25px auto;">
<div style="background: white"><div style="width: 30%; height: 20px; border-top: 1px dashed gray; border-left: 1px dashed gray;"></div><pre style="white-space: pre; font-size: 12px; line-height: 1.5em; margin-left: 15px; letter-spacing: 0;"><span style="color: #000000; font-weight: bold">var</span> app <span style="color: #000000; font-weight: bold">=</span> angular.module(<span style="color: #dd1144">&#39;Demo&#39;</span>, [], angular.noop);

app.directive(<span style="color: #dd1144">&#39;if&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($parse, $compile){
  <span style="color: #000000; font-weight: bold">var</span> compile <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($element, $attrs){
    <span style="color: #000000; font-weight: bold">var</span> cond <span style="color: #000000; font-weight: bold">=</span> $parse($attrs.<span style="color: #000000; font-weight: bold">true</span>);
    
    <span style="color: #000000; font-weight: bold">var</span> link <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($scope, $ielement, $iattrs, $controller){
      $scope.if_node <span style="color: #000000; font-weight: bold">=</span> $compile($.trim($ielement.html()))($scope, angular.noop);
      $ielement.empty();
      <span style="color: #000000; font-weight: bold">var</span> mark <span style="color: #000000; font-weight: bold">=</span> $(<span style="color: #dd1144">&#39;&lt;!-- IF/ELSE --&gt;&#39;</span>);
      $element.before(mark);
      $element.remove();

      $scope.$watch(<span style="color: #000000; font-weight: bold">function</span>(scope){
        <span style="color: #000000; font-weight: bold">if</span>(cond(scope)){
          mark.after($scope.if_node);
          $scope.else_node.detach();
        } <span style="color: #000000; font-weight: bold">else</span> {
          <span style="color: #000000; font-weight: bold">if</span>($scope.else_node <span style="color: #000000; font-weight: bold">!==</span> <span style="color: #000000; font-weight: bold">undefined</span>){
            mark.after($scope.else_node);
            $scope.if_node.detach();
          }
        }
      });
    }
    <span style="color: #000000; font-weight: bold">return</span> link;
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> compile,
          scope<span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000; font-weight: bold">true</span>,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;E&#39;</span>}
});

app.directive(<span style="color: #dd1144">&#39;else&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($compile){
  <span style="color: #000000; font-weight: bold">var</span> compile <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($element, $attrs){
    
    <span style="color: #000000; font-weight: bold">var</span> link <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">function</span>($scope, $ielement, $iattrs, $controller){
      $scope.else_node <span style="color: #000000; font-weight: bold">=</span> $compile($.trim($ielement.html()))($scope, angular.noop);
      $element.remove();
    }
    <span style="color: #000000; font-weight: bold">return</span> link;
  }

  <span style="color: #000000; font-weight: bold">return</span> {compile<span style="color: #000000; font-weight: bold">:</span> compile,
          restrict<span style="color: #000000; font-weight: bold">:</span> <span style="color: #dd1144">&#39;E&#39;</span>}
});

app.controller(<span style="color: #dd1144">&#39;TestCtrl&#39;</span>, <span style="color: #000000; font-weight: bold">function</span>($scope){
  $scope.a <span style="color: #000000; font-weight: bold">=</span> <span style="color: #009999">1</span>;
});

angular.bootstrap(<span style="color: #0086B3">document</span>, [<span style="color: #dd1144">&#39;Demo&#39;</span>]);
</pre><div style="width: 30%; height: 20px; border-bottom: 1px dashed gray; border-left: 1px dashed gray;"></div></div>

</div>

<p style="line-height: 1.8em; margin: 25px auto; word-break: break-word; word-wrap: break-word;">
代码中注意一点，就是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">if_node</code> 在得到之时，就已经是做了变量绑定的了。错误的思路是，在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">$watch</code> 中再去不断地得到新的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; letter-spacing: 0;">if_node</code> 。
</p>

<style type="text/css">
body.z { background-color: #eff3fa; }
body.z > .content { background-color: white; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5); }
body.z > .content > h1 { background-color: #0184b7; color: white; border-bottom: none; padding-left: 10px; border-radius: 5px; text-shadow: 0 2px 5px rgba(0, 0, 0, 0.9); }
body.z > .content > .toc a:hover { background-color: #ddd; }
body.z > .content > table th { background-color: rgba(223, 151, 27, 0.3);}
body.z > .content > .quote:before { content: '引'; font-size: 30px; color: #ddd; font-family: "'Microsoft YaHei','WenQuanYi Micro Hei',SimHei,tahoma,sans-serif"; }
body.z > .content ul > li, body.z > .content ol > li  { text-indent: -1em; }
body.z > .content  > .toc ul > li, body.z > .content  > .toc ol > li  { text-indent: 0; }
</style>
    

<script type="text/javascript" src="https://upcdn.b0.upaiyun.com/libs/jquery/jquery-2.0.3.min.js"></script>
<script type="text/javascript">

$(function(){
    function bind_scroll(){
        $('body.z > .content > .toc ol').css({listStyle: 'none'})
        $('body.z > .content > .toc ul').css({listStyle: 'none'})
        $('body.z > .content > .toc a').css({display: 'block', paddingLeft: '10px'})

        var anchor_list = $.map($('.anchor'), function(n){
            return $(n).offset().top;
        });
        var item = $('body.z > .content > .toc a');
        var last = 0;
        var flag = 0;

        $(window).on('scroll', function(eventObj){
            _set_item();
        });

        function set_item(){
            var top = $(window).scrollTop();
            if(top < anchor_list[0]){
                item.eq(last).css({backgroundColor: '', color: '#0184b7'});
                last = 0;
                return;
            }

            for(var i = 0, l = anchor_list.length; i < l; i++){
                if(top < anchor_list[i]){break}
                flag = i;
            }
            item.eq(last).css({backgroundColor: '', color: '#0184b7'});
            item.eq(flag).css({backgroundColor: '#ddd', color: '#333'});
            last = flag;
        }

        var timer = null;
        function _set_item(){
            if(timer){
                clearTimeout(timer);
            }
            timer = setTimeout(set_item, 100);
        }
    }

    function create_toc(){
        if($('body.z > .content > .toc').length == 0){
            $('body.z > .content > .header').css('min-height', '200px');
            return;
        }
        if($('body.z > .content > .toc').height() < 50){return}

        //至少200空间
        var space = ($(window).width() - $('body.z > .content').outerWidth());
        if( space < 200 ){return}

        $('body.z > .content > .header').css('min-height', '200px');

        var toc_width = (space > 400 ? 400 : space);
        var content_left = (space - toc_width - 20) / 2;

        $('body.z > .content > .toc ol').css({
            paddingLeft: '20px'
        });
        $('body.z > .content > .toc ul').css({
            paddingLeft: '20px'
        });

        $('body.z > .content').css({
            marginLeft: content_left + 'px'
        });

        $('body.z > .content > .toc').css({
            fontSize: '12px',
            width: toc_width + 'px',
            backgroundColor: 'white',
            border: '1px solid #ccc',
            boxShadow: '0 2px 5px rgba(0, 0, 0, 0.3)',
            position: 'fixed',
            zIndex: 9999,
            padding: '10px',
            boxSizing: 'border-box',
            top: '50px',
            right: content_left + 'px',
            overflow: 'auto',
            maxHeight: $(window).height() - 100 + 'px'
        });

        bind_scroll();
    }

    function is_mobile(){
        if(navigator.userAgent.indexOf('iPhone') >= 0 || navigator.userAgent.indexOf('Android') >= 0){
            return true;
        }
        return false;
    }

    function mobile_meta(){
        var ua=navigator.userAgent;
        var meta = '';
        if(ua.indexOf('Android')!=-1){
            var isUC= /UC /.test(ua) || /UCBrowser/.test(ua) || /baidubrowser/.test(ua)|| /qq/i.test(ua);
            if(isUC){
                meta='<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0,target-densitydpi=device-dpi,user-scalable=no" />';
            } else {
                meta='<meta name="viewport" content="width=device-width, initial-scale=0.5, maximum-scale=0.5,target-densitydpi=320,user-scalable=no" />';
            }
        }else{
            meta='<meta name="viewport" content="width=device-width, initial-scale=0.5, maximum-scale=0.5,target-densitydpi=device-dpi,user-scalable=no,minimal-ui" />';
        }
        $('head').append(meta);
    }

    function mobile_adjust(){
        $('body.z > .content').css({ width: '100%', padding: '15px' });
        $('#qr').hide();
        $('#disqus_thread').css({ width: '100%' });
        $('body.z').css({ letterSpacing: 0 });
        $('body.z p, body.z ul, body.z ol').css({ lineHeight: '1.5em' });
        $('body.z ul > li, body.z ol > li').css({ textIndent: '-2em' });
        $('body.z > .content > .toc ul > li, body.z > .content > .toc ol > li').css({ textIndent: 0, margin: 0 });
        $('body.z pre').css({ whiteSpace: 'pre-wrap', wordWrap: 'break-word' });
    }

    function normal_adjust(){
        $('body.z > .content > .toc ul > li, body.z > .content > .toc ol > li').css({ textIndent: 0, margin: 0 });
    }

    function code_view(){

        $('pre').click(function(eventObj){
            var $node = $($.clone(this));
            $node.attr('style', '');
            $node.css({
                fontSize: '24px',
                fontFamily: 'monospace',
                whiteSpace: 'pre-wrap',
                wordWrap: 'break-word',
                lineHeight: '1.5em',
                width: $(window).height(),
                height: $(window).width(),
                boxSizing: 'border-box',
                padding: '10px',
                paddingBottom: '30px',
                overflow: 'hidden'
            });
            var $wrapper = $('<div></div>').css({
                position: 'fixed',
                padding: 0,
                margin: 0,
                boxSizing: 'border-box',
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                width: $(window).height(),
                height: $(window).width(),
                overflow: 'hidden',
                top: ($(window).height() - $(window).width()) / 2,
                left: ($(window).width() - $(window).height()) / 2,
                transform: 'rotate(90deg)',
                zIndex: 999999
            });

            var $close = $('<div>&times;</div>').css({
                position: 'absolute',
                right: 0,
                top: 0,
                width: '100px',
                height: '100px',
                lineHeight: '80px',
                fontSize: '80px',
                textAlign: 'center',
                backgroundColor: 'rgba(204, 204, 204, 0.5)'
            });

            var $up = $('<div>△</div>').css({
                position: 'absolute',
                right: 0,
                bottom: '300px',
                width: '100px',
                height: '100px',
                lineHeight: '50px',
                fontSize: '50px',
                textAlign: 'center',
                backgroundColor: 'rgba(204, 204, 204, 0.5)',
                userSelect: 'none',
                '-webkit-user-select': 'none'
            });

            var $down = $('<div>▽</div>').css({
                position: 'absolute',
                right: 0,
                bottom: '100px',
                width: '100px',
                height: '100px',
                lineHeight: '150px',
                fontSize: '50px',
                textAlign: 'center',
                backgroundColor: 'rgba(204, 204, 204, 0.5)',
                userSelect: 'none',
                '-webkit-user-select': 'none'
            });

            $wrapper.append($node);
            $wrapper.append($close);
            $wrapper.append($up);
            $wrapper.append($down);

            $wrapper.on('touchstart', function(){
                return false;
            });

            $close.on('touchstart', function(){
                $close.css({ backgroundColor: '#0184b7' });
                return false;
            });
            $close.on('touchend', function(){

                $wrapper.off('touchend');
                $close.off('touchstart');
                $close.off('touchend');
                $up.off('touchstart');
                $up.off('touchend');
                $down.off('touchstart');
                $down.off('touchend');
                $wrapper.remove();

                return false;
            });

            var up_timer = null;
            $up.on('touchstart', function(eventObj){
                var start = $node.scrollTop();
                var dx = 0;
                $up.css({ backgroundColor: '#0184b7' });
                up_timer = setInterval(function(){
                    dx += 20;
                    $node.scrollTop(start - dx);
                }, 25);
                return false;
            });
            $up.on('touchend', function(eventObj){
                if(up_timer){clearInterval(up_timer)};
                $up.css({ backgroundColor: 'rgba(204, 204, 204, 0.5)' });
                return false;
            });

            var down_timer = null;
            $down.on('touchstart', function(eventObj){
                var start = $node.scrollTop();
                var dx = 0;
                $down.css({ backgroundColor: '#0184b7' });
                down_timer = setInterval(function(){
                    dx += 20;
                    $node.scrollTop(start + dx);
                }, 25);
                return false;
            });
            $down.on('touchend', function(eventObj){
                if(down_timer){clearInterval(down_timer)};
                $down.css({ backgroundColor: 'rgba(204, 204, 204, 0.5)' });
                return false;
            });

            $(this).before($wrapper);
        });
    
    }

    if(is_mobile()){
        mobile_meta();
        mobile_adjust();
        code_view();
    } else {
        create_toc();
        normal_adjust();
    }
});
</script>
    

    <div style="padding: 4px; line-height: 1.4em; font-size: 22px; margin-top: 100px; margin-bottom: 20px; clear: both; text-align: center; font-weight: bold; ">评论</div>
<div id="disqus_thread" style="width: 800px; margin: auto; "></div>
<script type="text/javascript">
  var disqus_shortname = 'zys';
  var disqus_identifier = 'angular';
  var disqus_url = 'https://www.zouyesheng.com/angular.html';
  var disqus_title = 'AngularJS学习笔记';

  (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>评论功能需要javascript的支持</noscript>
    

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-29492100-1', {siteSpeedSampleRate: 100});
ga('require', 'linkid');
ga('set', 'dimension1', (new Date()).getDay().toString());
ga('send', 'pageview');
</script>

<div id="qr" style="position: absolute; right: 30px; top: 80px;"><img style="border: 1px solid gray;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKUAAAClAQAAAAAVUAB3AAABpUlEQVR4nN2XMY7bQAxFHyUBo26U
E4wvEussuYcRy9D2e6RI8SnSSQdYYFxFBmT9FHaa7KYzi4TNgL8gQfJ/gmPivV2LD0D499DRzOqx
gXq0CjOznVs2NEoKkiTlo4K0psUxWyaFUR0ataYwcPDL9kDVlFP9uSmnJ8f9C3rpuBa8PD3uH3af
2xZXwhB757kVyMw4z13C5uvualZ51iZJ2mKvBcq758jJgVJhlAQcJ7lyEm0cp4WoSRskzFdv0ppo
f6sby6VnJzcOaWnVsVgmLa61FUA5xlNTCiVN4Wb95MjJIfbSRjlh6kWb8Z2bpqB8SEG5nO7tdJxb
lDRqZWklYer9WFIAzPb1EhQGTqZvzfPivjdtgAYOLPu4suxxVEDFOb9+qX/GKgEkLL+67skMi2lN
Gu7u0VXdUQrKsDwQ12ySpCGuhDGTNOCogMfN1c4Vi1JHTXTcJQUmCSWJdl4f7XS+uTYOCeIK5smS
6v58jxVYPqExve1+uF/Q5aibaboe5871wouasEyqz/m2q5WCH0sqZBDUvO3YX16QPj0l7seo/cc/
ql/dLBtxWXQFNwAAAABJRU5ErkJggg==
" title="本文二维码网址" /></div>
    

<div style="font-size: 10px; text-align: right; margin-top: 50px; letter-spacing: 0;">
&copy;2010-2016 zouyesheng.com All rights reserved. Powered by <a href="https://github.com/" target="_blank">GitHub</a> , <a href="http://txt2tags.org/" target="_blank">txt2tags</a> , <a href="https://www.mathjax.org/" target="_blank">MathJax</a>
</div>

<script type="text/javascript">
  dplus.track('浏览页面', {'页面名称': 'angularjs', 'URL': location.href});
  dplus.track('页面加载完成', {'页面名称': 'angularjs', '用时': parseInt((new Date()).valueOf() - window.START, 10)});
</script>
    
<!-- xhtml code generated by txt2tags 2.6 (http://txt2tags.org) -->
</div></body></html>
